import { beforeEach, describe, expect, it } from 'bun:test';
import { convertContentToMarkdown } from 'shamela';
import { type Page, type Segment, type SegmentationOptions, segmentPages } from './index';

const mapPageToMarkdown = (p: Page) => ({ content: convertContentToMarkdown(p.content), id: p.id });

const testSegment = (
    segment: Segment,
    { beginsWith, endsWith, ...expected }: Partial<Segment> & { beginsWith?: string; endsWith?: string },
) => {
    expect(segment).toMatchObject(expected);

    if (beginsWith) {
        expect(segment.content).toStartWith(beginsWith);
    }

    if (endsWith) {
        expect(segment.content).toEndWith(endsWith);
    }
};

describe('index', () => {
    let options: SegmentationOptions;
    let pages: Page[];

    const initPages = (contents: string[]) => {
        pages = contents.map((content, idx) => {
            return { content: convertContentToMarkdown(content), id: idx };
        });
    };

    describe('2576', () => {
        beforeEach(() => {
            pages = [
                {
                    content:
                        '<span data-type="title">(هذا نص التقرير) </span>\rالوارد من حضرة صاحب الفضيلة الأستاذ الأكبر الشيخ حسونة النواوي شيخ الجامع الأزهر - حفظه الله',
                    id: 1,
                },
                {
                    content: '﷽\rالحمد للَّه  سلطان المسلمين',
                    id: 2,
                },
                {
                    content: 'وحافظ   لهم دراية بعلم الحديث.',
                    id: 3,
                },
                {
                    content:
                        'هذا وقد احتفلنا بيوم ختام هذا الكتاب المستطاب في مركز إدارة الجامع الأزهر الأنور، فحضر في ذلك اليوم المشهود جمع من أكابر العلماء، وتليت الأدعية الصالحة المقبولة بدوام عرش الخلافة العظمى وتأييد مولانا أمير  قَدْ حَوَى التَّـ … ـارِيخَ فِي بَيْتِ الْقَصِيدْ\rطَبَعَ البُخَارِيَّ جَيِّدًا … سُلْطَانُنَا عَبْدُ الحَميدْ\r٨١، ٨٤٤، ١٨، ٢٠١، ١٦٩\r\rسنة ١٣١٣',
                    id: 4,
                },
                {
                    content:
                        '<span data-type="title">مقدمة </span>\r﷽\r\rيا من أمر بصنع الجميل، وجزى عليه الجزاء الجزيل، نحمدك على ما هديتنا، ونشكرك على ما أوليتنا، ونصلي ونسلم على نبيك الأكرم، ورسولك السيد السند الأعظم، سيدنا ومولانا  خان، أيد اللَّه',
                    id: 5,
                },
                {
                    content:
                        'القسط بهمته، وقوم أود الرعية بعدالته، وأكثر خير البلاد بيمنه، وأنام جميع الأنام في ظل أمنه، وأدامه عزًّا  والبيان تامًّا، إن شاء اللَّه تعالى. وكتبه محمد بن عبد اللَّه بن مالك حامدًا للَّه تعالى. اهـ.\rوكتب الحافظ اليونيني على ظهر آخر ورقة من المجلد  مالك أزمة الأدب، العلامة أبي عبد اللَّه بن مالك الطائي الجياني، أمد اللَّه تعالى عمره، في المجلس الحادي والسبعين، وهو يراعي قراءتي ويلاحظ نطقي، فما اختاره ورجحه وأمر بإصلاحه أصلحته وصححت عليه،',
                    id: 6,
                },
                {
                    content:
                        ' (الجزء الأول)\rمن صحيح أبي عبد اللَّه محمد بن إسماعيل بن إبراهيم بن المغيرة ابن بردزبه البخاري الجعفي رضي اللَّه تعالى عنه عند أصحاب الرمز الذي بعدها، وقد يوجد في آخر تلك الجملة التي عليها (لا) لفظ (إلى) إشارة إلى آخر الساقط عند صاحب الرمز.\rومن  سبحانه أعلم.\r\r(طبع)\rبالمطبعة الكبرى الأميرية ببولاق مصر المحمية\rسنة ١٣١١ هجرية',
                    id: 8,
                },
                {
                    content:
                        '﷽\rقَالَ الشَّيْخُ الإِمَامُ الْحَافِظُ أَبُو عَبْدِ اللَّهِ مُحَمَّدُ بْنُ إِسْمَاعِيلَ بْنِ إِبْرَاهِيمَ بْنِ الْمُغِيرَةِ الْبُخَارِىُّ رَحِمَهُ اللَّهُ تَعَالَى، آمِينَ: كَيْفَ كَانَ بَدْءُ الْوَحْيِ إِلَى رَسُولِ اللهِ ﷺ، وَقَوْلُ اللهِ جَلَّ ذِكْرُهُ: ﴿إِنَّا أَوْحَيْنَا إِلَيْكَ كَمَا أَوْحَيْنَا إِلَى نُوحٍ وَالنَّبِيِّينَ مِنْ بَعْدِهِ﴾.\r<span id="link-1"> </span>',
                    id: 9,
                },
                {
                    content:
                        '١ - حَدَّثَنَا <a href="inr://man-3654">الْحُمَيْدِيُّ عَبْدُ اللهِ بْنُ الزُّبَيْرِ </a>،   أَوْ إِلَى امْرَأَةٍ يَنْكِحُهَا، فَهِجْرَتُهُ إِلَى مَا هَاجَرَ إِلَيْهِ».\r <hadeeth>',
                    id: 10,
                },
                {
                    content: "<span data-type='title' id=toc-30>بَابُ عَلَامَةِ الْمُنَافِقِ</span>",
                    id: 66,
                },
                {
                    content:
                        '٣٣ - حَدَّثَنَا <a href="inr://man-2591">سُلَيْمَانُ أَبُو الرَّبِيعِ </a>قَالَ: حَدَّثَنَا <a href="inr://man-650"> وَإِذَا اؤْتُمِنَ خَانَ».\r <hadeeth>',
                    id: 67,
                },
                {
                    content:
                        '٣٤ - حَدَّثَنَا <a href="inr://man-5178">قَبِيصَةُ بْنُ عُقْبَةَ </a>قَالَ: حَدَّثَنَا <a href="inr://man-2472">سُفْيَانُ، </a>عَنِ <a href="inr://man-2638">الْأَعْمَشِ، </a>عَنْ <a href="inr://man-3909">عَبْدِ اللهِ بْنِ مُرَّةَ، </a>عَنْ <a href="inr://man-6088">مَسْرُوقٍ، </a>عَنْ <a href="inr://man-3823">عَبْدِ اللهِ بْنِ عَمْرٍو، </a>أَنَّ النَّبِيَّ ﷺ قَالَ: <hadeeth-32>«أَرْبَعٌ مَنْ كُنَّ فِيهِ كَانَ مُنَافِقًا خَالِصًا، وَمَنْ  شُعْبَةُ، عَنِ الْأَعْمَشِ.\r <hadeeth>',
                    id: 68,
                },
                {
                    content: "<span data-type='title' id=toc-31>بَابٌ: قِيَامُ لَيْلَةِ الْقَدْرِ مِنَ الْإِيمَانِ</span>",
                    id: 69,
                },
                {
                    content:
                        '٣٥ - حَدَّثَنَا <a href="inr://man-1588">أَبُو الْيَمَانِ </a>قَالَ: أَخْبَرَنَا <a href="inr://man-2785">شُعَيْبٌ </a>قَالَ: حَدَّثَنَا <a href="inr://man-3645">أَبُو الزِّنَادِ، </a>عَنِ <a href="inr://man-3424">الْأَعْرَجِ، </a>عَنْ <a href="inr://man-3320">أَبِي هُرَيْرَةَ </a>قَالَ: قَالَ رَسُولُ اللهِ ﷺ: <hadeeth-33>«مَنْ يَقُمْ لَيْلَةَ الْقَدْرِ إِيمَانًا وَاحْتِسَابًا غُفِرَ لَهُ مَا تَقَدَّمَ مِنْ ذَنْبِهِ».\r <hadeeth>',
                    id: 70,
                },
                {
                    content: 'بَابُ قَوْلِ الْمُحَدِّثِ حَدَّثَنَا أَوْ : عَنِ النَّبِيِّ ﷺ يَرْوِيهِ عَنْ رَبِّكُمْ ﷿',
                    id: 115,
                },
                {
                    content:
                        '٧٥٦٣ - حَدَّثَنِي <a href="inr://man-415">أَحْمَدُ بْنُ إِشْكَابٍ، </a>حَدَّثَنَا <a href="inr://man-5879">مُحَمَّدُ بْنُ فُضَيْلٍ، </a>عَنْ <a href="inr://man-4642">عُمَارَةَ بْنِ الْقَعْقَاعِ، </a>عَنْ <a href="inr://man-268">أَبِي زُرْعَةَ، </a>عَنْ <a href="inr://man-3320">أَبِي هُرَيْرَةَ </a>﵁ قَالَ: قَالَ النَّبِيُّ ﷺ: <hadeeth-2283>«كَلِمَتَانِ حَبِيبَتَانِ إِلَى الرَّحْمَنِ، خَفِيفَتَانِ عَلَى اللِّسَانِ، ثَقِيلَتَانِ فِي الْمِيزَانِ: سُبْحَانَ اللهِ وَبِحَمْدِهِ، سُبْحَانَ اللهِ الْعَظِيمِ.» <hadeeth>',
                    id: 11208,
                },
            ];

            options = {
                breakpoints: [{ pattern: '{{tarqim}}\\s*' }, ''],
                maxPages: 1,
                prefer: 'longer',
                rules: [
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{basmalah}}'],
                        split: 'at',
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{bab}}'],
                        meta: { type: 'chapter' },
                        split: 'at',
                    },
                    {
                        lineStartsAfter: ['##'],
                        meta: { type: 'chapter' },
                        split: 'at',
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{kitab}}'],
                        meta: { type: 'book' },
                        split: 'at',
                    },
                    {
                        lineStartsAfter: ['{{raqms:num}} {{dash}}'],
                        split: 'at',
                    },
                ],
            };

            pages = pages.map(mapPageToMarkdown);
        });

        it('should segment the pages', () => {
            const segments = segmentPages(pages, options);

            // With page-ID-based span calculation, pages get split more accurately
            expect(segments).toHaveLength(17);

            testSegment(segments[0], {
                beginsWith: '(هذا نص التقرير)',
                endsWith: 'حفظه الله',
                from: 1,
                meta: {
                    type: 'chapter',
                },
            });

            testSegment(segments[1], {
                beginsWith: '﷽',
                endsWith: 'بعلم الحديث.',
                from: 2,
                to: 3,
            });

            testSegment(segments[2], {
                beginsWith: 'هذا وقد',
                endsWith: 'سنة ١٣١٣',
                from: 4,
            });

            testSegment(segments[3], {
                beginsWith: 'مقدمة',
                from: 5,
                meta: {
                    type: 'chapter',
                },
            });

            testSegment(segments[4], {
                beginsWith: '﷽',
                endsWith: 'تعالى. اهـ.',
                from: 5,
                to: 6,
            });

            testSegment(segments[5], {
                beginsWith: 'وكتب الحافظ',
                from: 6,
            });

            testSegment(segments[6], {
                beginsWith: '(الجزء الأول)',
                from: 8,
            });

            testSegment(segments[7], {
                beginsWith: '(طبع)',
                from: 8,
            });

            testSegment(segments[8], {
                beginsWith: '﷽',
                from: 9,
            });

            testSegment(segments[9], {
                beginsWith: 'حَدَّثَنَا الْحُمَيْدِيُّ عَبْدُ اللهِ بْنُ الزُّبَيْرِ',
                endsWith: 'هَاجَرَ إِلَيْهِ».',
                from: 10,
                meta: {
                    num: '١',
                },
            });

            testSegment(segments[10], {
                content: 'بَابُ عَلَامَةِ الْمُنَافِقِ',
                from: 66,
                meta: {
                    type: 'chapter',
                },
            });

            testSegment(segments[11], {
                beginsWith: 'حَدَّثَنَا سُلَيْمَانُ أَبُو الرَّبِيعِ',
                endsWith: 'اؤْتُمِنَ خَانَ».',
                from: 67,
                meta: {
                    num: '٣٣',
                },
            });

            testSegment(segments[13], {
                content: 'بَابٌ: قِيَامُ لَيْلَةِ الْقَدْرِ مِنَ الْإِيمَانِ',
                from: 69,
                meta: {
                    type: 'chapter',
                },
            });

            testSegment(segments[14], {
                beginsWith: 'حَدَّثَنَا أَبُو الْيَمَانِ قَالَ: أَخْبَرَنَا',
                endsWith: 'ذَنْبِهِ».',
                from: 70,
                meta: {
                    num: '٣٥',
                },
            });

            testSegment(segments[15], {
                beginsWith: 'بَابُ قَوْلِ الْمُحَدِّثِ',
                endsWith: 'عَنْ رَبِّكُمْ ﷿',
                from: 115,
                meta: {
                    type: 'chapter',
                },
            });

            testSegment(segments[16], {
                beginsWith: 'حَدَّثَنِي أَحْمَدُ بْنُ إِشْكَابٍ',
                endsWith: 'الْعَظِيمِ.»',
                from: 11208,
                meta: {
                    num: '٧٥٦٣',
                },
            });
        });
    });

    describe('2588', () => {
        beforeEach(() => {
            pages = [
                {
                    content: 'المغْني\rالرياض',
                    id: 1,
                },
                {
                    content: 'المغْني',
                    id: 2,
                },
                {
                    content:
                        'بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ\r\r<span data-type="title">مقدمة التحقيق</span>\rنص مختصر لمسائله.\rوكان أبو القاسم عمر بن الحسين المتوفى سنة ٣٣٤ هـ،',
                    id: 5,
                },
                {
                    content:
                        'السابق لها حتى يهدى السبيل.\rغرة ربيع الأول ١٤٠٦ هـ\rعبد اللَّه عبد المحسن التركى\rعبد الفتاح محمد الحلو',
                    id: 56,
                },
                {
                    content: 'المغْني\rالجزء الأول',
                    id: 57,
                },
                {
                    content: 'المغْني',
                    id: 58,
                },
                {
                    content:
                        'بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ\r[قال الشيخُ الإِمامُ العالمُ العاملُ شيخُ الإِسلام، قُدْوةُ الأنام، مَجْمُوعُ الفضائل، مُوَفَّقُ الدين أبو محمد عبد اللَّه بن أحمد بن محمد بن قُدامَةَ المَقْدِسِىُّ، قَدَّس اللهُ رُوحَه، وَنوَّر ضَرِيحَهُ: ] (١)\rالحمدُ للَّه بارِئِ الْبَرِيَّات، وغافِر الخَطِيَّات، وعالِمِ الخَفِيَّات، المُطّلِعِ على الضمائِرِ والنِّيَّات، أحاط بكلِّ شَئٍ عِلْما، وَوَسِعَ كُلَّ شَئٍ رحمةً وحِلْما، وَقَهَرَ كُلَّ مخلوقٍ عِزةً وحُكْمًا {يَعْلَمُ مَا بَيْنَ أَيْدِيهِمْ وَمَا خَلْفَهُمْ وَلَا يُحِيطُونَ بِهِ عِلْمًا} (٢)، لا تدركُه الأبصار، ولا تُغيِّره الأعْصار، ولا تَتَوهَّمه الأفكار، {وَكُلُّ شَيْءٍ عِنْدَهُ بِمِقْدَارٍ} (٣)، أتْقَن ما صنَع وأحْكَمه، وأحْصَى كُلَّ شَئٍ وعلمَه، وخلق الإِنسانَ وَعَلَّمَهُ، ورفع قَدْرَ العِلْمِ وعظَّمه، وحظَره على من استرْذَله وحَرَّمَه، وخَصَّ به مِن خَلْقِه مَن كرَّمه، وحَضَّ عبادَه المؤمنين على النَّفِيرِ لِلتَّفَقُّهِ في الدين، فقال  للقيامِ بحُجَّتِه، والنِّيابةِ عنه في الإِخبارِ بشريعتِه، واخْتَصَّهم مِن بينِ عبادِه بخَشْيتِه، فقَال تعالى: {إِنَّمَا يَخْشَى اللَّهَ مِنْ عِبَادِهِ الْعُلَمَاءُ} (٥)، ثم أمَر سائِرَ الناسِ\r',
                    id: 59,
                },
                {
                    content:
                        'إلى هذا الطَّرْفِ.\r\r<span data-type="title" id=toc-167><span data-type="title" id=toc-168><span data-type="title" id=toc-169>فصل: </span></span></span>وإنْ خُلِقَ له إصْبَعٌ زائدةٌ، أو يَدٌ زائِدةٌ في مَحَلِّ الفَرْضِ، وَجَب غَسْلُها مع الأَصْلِيَّةِ؛ لأنها نابِتَةٌ فيه، أشْبَهَت الثُّؤْلُولَ (٨)، وإن كانت نابتةً في غيرِ مَحَلِّ الفَرْضِ كالعَضُدِ أو المَنْكِبِ، لم يجِبْ غَسْلُها، سواء كانت قصيرةً أو طويلةً؛ لأنها في غيرِ مَحَلِّ الفَرْضِ، فأشْبَهت شعرَ الرَّأْسِ إذا نزلَ عن الوَجْهِ، وهذا قَوْلُ ابنِ حَامِد وابنِ عَقِيل. وقال القَاضِى: إن كان بَعْضُها يُحَاذِى مَحَلَّ الفَرْضِ غَسَلَ ما يُحاذِيهِ منها. والأَوَّلُ أصَحُّ. واخْتَلَفَ أَصْحابُ الشَّافِعِىِّ (٩) في ذلك، كنَحْوٍ ممَّا  فوَجَبَ غَسْلُهما، كما لو تَنَجَّسَت إحْدَى يَدَيْه ولم يَعْلَمْ عَيْنَها.\r\rفصل: وإن انْقَلَعَتْ (١٠) جِلْدَةٌ مِنْ غيرِ مَحَلِّ الفَرْضِ، حَتَّى تَدَلَّتْ مِنْ مَحَلِّ الْفَرْضِ، وجَبَ غَسْلُها؛ لأنَّ أصْلَها في مَحَلِّ الفَرْضِ، فأشْبَهَت الإِصْبعَ الزائدةَ، وإن تَقَلَّعت (١١) مِن مَحَلِّ الفَرْضِ حتى صارَتْ مُتَدَلِّيةً مِن غيرِ مَحَلِّ الفَرْضِ، لم يَجبْ غَسْلُها؛ قصيرةً كانت أو طويلةً بلا خِلَافٍ، لأنها في غيرِ مَحَلِّ الفَرْضِ. وإن تَقَلَّعت (١١) مِن أحدِ  وغَسْلُ ما تحتَها مِن مَحَلِّ الفَرْضِ.\r\rفصل: وإن قُطِعَت يَدُه مِنْ دُون المِرْفَقِ، غَسَلَ ما بَقِىَ مِنْ مَحَلِّ الفَرْضِ. وإن قُطِعَت مِن المِرْفَقِ غَسَلَ العَظْمَ الذي هو طَرَفُ العَضُدِ؛ لأنَّ غَسْلَ العَظْمَيْنِ\r',
                    id: 229,
                },
                {
                    content:
                        'بالموتِ، أشْبَهَت المُدَبَّرَةِ، وتُفارِقُ الحُرَّةَ، فإنَّها كامِلَةٌ.\r\r<span data-type="title" id=toc-8780>فصل: </span>ولا يَجِبُ القصاصُ على الحُرَّةِ بقَتْلِها؛ لعدَمِ المُكافَأَةِ. وإِنْ كان القاتِلُ لها رَقِيقًا، وجَبَ القِصاصُ عليه؛ لأنَّها أكْمَلُ منه. وإِنْ جَنَتْ على عبدٍ أو أَمَةٍ، جنايَةً فيها القِصاصُ، لَزِمَها القِصاصُ؛ لأنَّها أَمَةٌ، أحْكامُها أحْكامُ الإِماءِ، واسْتِحْقاقُها العِتْقَ لا يَمْنَعُ القِصاصَ، كالمُدَبَّرَةِ.\r\r<span data-type="title" id=toc-8781>٢٠٢٦ - مسألة؛ قال: (وإِنْ صَلَّتْ مَكْشُوفَةَ الرَّأْسِ، كُرِهَ لَهَا ذلِكَ، وأَجْزأَهَا)</span>\rإنَّما كُرِهَ لها كَشْفُ رَأْسِها فى صلاتِها؛ لأنَّها قدأخَذَتْ شَبَهًا من الحَرائِرِ، لامْتِناعِ بَيْعِها. وقد سُئِلَ أحمدُ، رَضِىَ اللَّهُ عنه، عن أُمِّ الولدِ كيف تُصَلِّى؟ قال: تُغَطِّى رَأْسَها وقَدَمَيْها؛ لأنَّها لا تُباعُ. وكان الحسنُ يُحِبُّ للأَمَةِ إذا [عَهِدَها سَيِّدُها -يعنى وَطِئَها] (١) - أَنْ لا تُصَلِّىَ إِلَّا مُجْتَمِعَةً. وإِنْ صَلَّتْ مكْشُوفَةَ الرَّأْسِ، أَجْزَأَها؛ لأنَّها أمَةٌ، حكمُها حكمُ (٢) الإِماءِ. قال إبراهيمُ: تُصَلِّى أُمُّ الولدِ بغيرِ قِناعِ، وإِنْ كانَتْ  ولأنَّ الأَصْلَ بقاءُ حُكْمِها فى إباحَةِ كشفِ رَأْسِها، ولم يُوجَدْ ما يَنْقُلُ عنه مِن نَصٍّ، ولا ما فى مَعْناه، فيَبْقَى الحكمُ على ما كان عليه.\r\r<span data-type="title" id=toc-8782>٢٠٢٧ - مسألة؛ قال: (وَإِذَا قَتلَتْ أمُّ الْوَلَدِ سَيِّدَهَا، فعَلَيْهَا قِيمَةُ نَفْسِهَا)</span>\rوجملتُه أَنَّ أُمَّ الولدِ إذا قَتَلَتْ سَيِّدَها، عَتَقَتْ؛ لأنَّها لا يُمْكِنُ نَقْلُ المِلْكِ فيها، وقد زالَ مِلْكُ سَيِّدِها بقَتْلِه، فصارَتْ حُرَّةً، كما لو قَتَلَه غيرُها، وعليها قِيمَةُ نَفْسِها، إِنْ لم يجبِ\r',
                    id: 7954,
                },
                {
                    content:
                        'القِصاصُ عليها. وهذا قولُ أبى يوسفَ. وقال الشافِعِىُّ: عليها الدِّيَةُ؛ لأنَّها تَصِيرُ حُرَّةً. وكذلك (١) لَزِمَها مُوجَبُ جِنايَتِها، والواجِبُ على الحُرِّ بقَتلِ الحُرِّ دِيَتُه (٢).',
                    id: 7955,
                },
                {
                    content:
                        '<span data-type="title" id=toc-210>بابُ الاسْتِطابةِ والحَدَثِ</span>\rالاسْتِطابةُ: هي الاسْتِنْجاءُ بالماءِ أو بالأَحْجارِ، يقال: اسْتَطابَ، وأَطَابَ: إذا اسْتَنْجَى؛ سُمِّىَ اسْتِطابةً لأنَّه يُطَيِّبُ جَسَدَه بإزالةِ الخَبَثِ عنه، قال الشاعر، يَهْجُو رَجُلا (٧):\rيارَخَمًا قَاظَ علَى عُرْقُوبِ (٨)\rيُعْجِلُ كَفَّ الْخَارِىءِ الْمُطِيبِ\rوالاسْتِنْجاءُ: اسْتِفْعالٌ مِن (٩) نَجَوْتُ الشَّجرةَ، أي: قَطَعْتُها، فكَأَنَّه قَطَعَ الأَذَى عنه، وقال ابنُ قُتَيْبَة: هو مَأْخوذٌ من النَّجْوَةِ، وهى ما ارْتَفَعَ من الأرض، لأنَّ مَنْ أرادَ قَضاءَ الحاجةِ اسْتَتَرَ بها. والاسْتِجْمارُ: اسْتِفْعالٌ من الجِمَارِ، وهي الحِجارَةُ الصّغَارُ؛ لأنَّه يَسْتَعْمِلُها في اسْتِجْمارهِ.\r\r<span data-type="title" id=toc-211>٣٥ - مسألة؛ قال: (وليس عَلَى مَنْ نامَ أو خَرَجتْ منه رِيحٌ اسْتِنْجاءٌ)</span>\rلا نَعْلمُ في هذا خِلافا. قال أبو عبد اللَّه: ليس في الرِّيحِ اسْتِنْجاءٌ؛ في كتابِ اللهِ، ولا في سُنَّةِ رَسُولهِ، إنَّما عليه الوُضُوءُ، وقد رُوِىَ عن النبيِّ -صلى اللَّه عليه وسلم-[أنَّه قال] (١): "من اسْتَنْجَى مِنْ رِيحٍ فليس مِنَّا". رَوَاه الطَّبَرَانِيُّ في "مُعْجَمِه الصَّغِير (٢) "، وعن زَيْدِ بنِ أَسْلَم في قوله تعالى: {إِذَا قُمْتُمْ إِلَى الصَّلَاةِ فَاغْسِلُوا وُجُوهَكُمْ}. إذَا قُمْتُمْ',
                    id: 7957,
                },
            ];

            options = {
                breakpoints: [{ exclude: [1, 2, 58], pattern: '{{tarqim}}\\s*' }, ''],
                maxPages: 1,
                prefer: 'longer',
                rules: [
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{basmalah}}'],
                        split: 'at',
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{fasl}}'],
                        split: 'at',
                    },
                    {
                        lineStartsAfter: ['## {{raqms:num}} {{dash}}'],
                        meta: { type: 'chapter' },
                        min: 60,
                        split: 'at',
                    },
                    {
                        lineStartsAfter: ['##'],
                        meta: { type: 'chapter' },
                        split: 'at',
                    },
                    {
                        lineStartsAfter: ['{{raqms:num}} {{dash}}'],
                        min: 60,
                        split: 'at',
                    },
                ],
            };

            pages = pages.map(mapPageToMarkdown);
        });

        it('should segment the pages', () => {
            const segments = segmentPages(pages, options);

            expect(segments).toHaveLength(21);

            testSegment(segments[0], {
                beginsWith: 'المغْني',
                endsWith: 'الرياض',
                from: 1,
            });

            testSegment(segments[1], {
                content: 'المغْني',
                from: 2,
            });

            testSegment(segments[2], {
                content: 'بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ',
                from: 5,
            });

            testSegment(segments[3], {
                beginsWith: 'مقدمة التحقيق',
                endsWith: 'لمسائله.',
                from: 5,
                meta: { type: 'chapter' },
            });

            // Remaining page 5 content after tarqim split (no tarqim in this part)
            testSegment(segments[4], {
                beginsWith: 'وكان أبو القاسم',
                endsWith: 'سنة ٣٣٤ هـ،',
                from: 5,
            });

            testSegment(segments[5], {
                beginsWith: 'السابق لها',
                endsWith: 'يهدى السبيل.',
                from: 56,
            });

            // Remaining page 56 content after tarqim split
            testSegment(segments[6], {
                beginsWith: 'غرة ربيع',
                endsWith: 'محمد الحلو',
                from: 56,
            });

            testSegment(segments[7], {
                beginsWith: 'المغْني',
                endsWith: 'الجزء الأول',
                from: 57,
            });

            testSegment(segments[8], {
                content: 'المغْني',
                from: 58,
            });

            testSegment(segments[9], {
                beginsWith: 'بِسْمِ اللَّهِ الرَّحْمَنِ',
                endsWith: 'أمَر سائِرَ الناسِ',
                from: 59,
            });

            testSegment(segments[10], {
                content: 'إلى هذا الطَّرْفِ.',
                from: 229,
            });

            testSegment(segments[11], {
                beginsWith: 'فصل: وإنْ خُلِقَ',
                endsWith: 'عَيْنَها.',
                from: 229,
            });

            testSegment(segments[12], {
                beginsWith: 'فصل: وإن انْقَلَعَتْ',
                endsWith: 'مَحَلِّ الفَرْضِ.',
                from: 229,
            });

            testSegment(segments[13], {
                beginsWith: 'فصل: وإن قُطِعَت',
                endsWith: 'طَرَفُ العَضُدِ؛',
                from: 229,
            });

            testSegment(segments[14], {
                content: 'لأنَّ غَسْلَ العَظْمَيْنِ',
                from: 229,
            });

            testSegment(segments[15], {
                beginsWith: 'بالموتِ',
                endsWith: 'فإنَّها كامِلَةٌ.',
                from: 7954,
            });

            testSegment(segments[16], {
                beginsWith: 'فصل: ولا يَجِبُ',
                endsWith: 'كالمُدَبَّرَةِ.',
                from: 7954,
            });

            testSegment(segments[17], {
                beginsWith: 'مسألة؛ قال: (وإِنْ',
                endsWith: 'ما كان عليه.',
                from: 7954,
            });

            testSegment(segments[18], {
                beginsWith: 'مسألة؛ قال: (وَإِذَا قَتلَتْ',
                endsWith: 'بقَتلِ الحُرِّ دِيَتُه (٢).',
                from: 7954,
                to: 7955,
            });

            testSegment(segments[19], {
                beginsWith: 'بابُ الاسْتِطابةِ',
                endsWith: ' في اسْتِجْمارهِ.',
                from: 7957,
                meta: { type: 'chapter' },
            });

            testSegment(segments[20], {
                beginsWith: 'مسألة؛ قال: (وليس',
                endsWith: 'إذَا قُمْتُمْ',
                from: 7957,
                meta: { type: 'chapter' },
            });
        });
    });

    describe('misc', () => {
        beforeEach(() => {
            options = {
                breakpoints: [
                    {
                        pattern: '{{tarqim}}\\s*',
                    },
                    '',
                ],
                maxPages: 1,
                rules: [
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{basmalah}}'],
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{fasl}}'],
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{bab}}'],
                        meta: {
                            type: 'chapter',
                        },
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{naql}}'],
                    },
                    {
                        lineStartsAfter: ['## {{raqms:num}}\\s*{{dash}}'],
                        meta: {
                            type: 'chapter',
                        },
                    },
                    {
                        lineStartsAfter: [
                            '## ({{raqms:num}})\\s*{{dash}} {{rumuz}}:',
                            '## ({{raqms:num}})\\s*{{dash}}',
                            '## {{raqms:num}} {{rumuz}}:',
                            '## {{rumuz}}:',
                        ],
                        meta: {
                            type: 'chapter',
                        },
                        min: 100,
                    },
                    {
                        lineStartsAfter: ['##\\s*•:?\\s*', '##\\s*-\\s*', '##'],
                        meta: {
                            type: 'chapter',
                        },
                        split: 'at',
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{kitab}}'],
                        meta: {
                            type: 'book',
                        },
                    },
                    {
                        lineStartsAfter: [
                            '•',
                            '{{harf}}+:\\s*',
                            '{{rumuz}}:\\s*',
                            '({{harf}})\\s*:',
                            '{{raqms:num}} {{rumuz}}:',
                            '{{raqms:num}}\\s*{{dash}}\\s*{{rumuz}}:',
                            '{{raqms:num}}\\s*{{dash}}\\s*{{harf:rumuz}}:',
                            '{{raqms:num}}\\s*{{dash}}',
                            '({{raqms:num}})\\s*{{dash}}',
                            '- {{harf:rumuz}}:',
                            '{{raqms:num}}:',
                            '{{harf}} {{raqm}} {{dash}}',
                        ],
                        min: 100,
                    },
                ],
            };
        });

        it('should segment the text', () => {
            pages = [
                {
                    content:
                        'أربعا وتسعين سنة (١) .\r٢٩- خ سي:<span data-type="title" id=toc-70> أَحْمَد بن حميد الطريثيثي، أَبُو الْحَسَن الكوفي، ختن عُبَيد اللَّهِ بْن مُوسَى، ويعرف بدار أم </span>سَلَمَة (٢) .\rوكان من حفاظ الكوفة.',
                    id: 257,
                },
                {
                    content:
                        '١٠٢-<span data-type="title" id=toc-145> تمييز ولهم شيخ آخر يقَالَ له: أَحْمَد بْن مُحَمَّد بْن يحيى بن نيزك بن صَالِح بن عَبْد الرَّحْمَنِ </span>بن عَمْرو بن مرة الهمداني، أَبُو الْعَبَّاس القومسي النيزكي.',
                    id: 435,
                },
            ];
            pages = pages.map(mapPageToMarkdown);

            const segments = segmentPages(pages, options);

            expect(segments).toHaveLength(3);

            testSegment(segments[0], {
                content: 'أربعا وتسعين سنة (١) .',
                from: 257,
            });

            testSegment(segments[1], {
                beginsWith: 'خ سي: أَحْمَد بن حميد',
                endsWith: 'من حفاظ الكوفة.',
                meta: {
                    num: '٢٩',
                    type: 'chapter',
                },
            });

            testSegment(segments[2], {
                beginsWith: 'تمييز ولهم',
                endsWith: 'القومسي النيزكي.',
                meta: {
                    num: '١٠٢',
                },
            });
        });

        it('should split into 3 segments', () => {
            pages = [
                {
                    content:
                        'بعضهم إحدى هاتين الترجمتين بالأخرى (١) ، والصواب التفريق كما ذكرنا، والله أعلم (٢) .\r١٠٦- ق:<span data-type="title" id=toc-149> أَحْمَد بن مُحَمَّد بن يحيى بن سَعِيد بن فروخ القطان أَبُو سَعِيد البَصْرِيّ، نزيل بغداد، أخو صَالِح </span>بْن مُحَمَّد.\rرَوَى عَن: بهلول بْن المورق، وحجين (٣) بن  وعفان بْن مسلم، وعَمْرو بْن مُحَمَّد العنقزي (ق) ، وعَمْرو بْن النعمان، وقريش بْن أنس، ومحاضر',
                    id: 442,
                },
                {
                    content:
                        'ابن المورع،  (ق) ، ويحيى بْن آدم، ويحيى بْن حَمَّاد، وجده يحيى بْن سَعِيد القطان، ويحيى بْن عُمَر الفراء،  الشَّيْبَانِيّ.\rرَوَى عَنه: ابْن  بْن حَفْص الدوري، ومحمد بْن نوح الجنديسابوري، ويحيى بْن مُحَمَّد بْن صاعد، ويعقوب بْن إِبْرَاهِيم بْن أَحْمَد بْن عيسى الْبَغْدَادِيّ.\rقال عَبد الرَّحْمَنِ بْن أَبي حَاتِم: كَانَ صدوقا (١)\rوَقَال مُحَمَّد بْن مخلد: مات بالعسكر (٢) سنة ثمان وخمسين',
                    id: 443,
                },
                {
                    content: 'ومئتين (١) .',
                    id: 444,
                },
            ].map(mapPageToMarkdown);

            const segments = segmentPages(pages, options);

            testSegment(segments[0], {
                beginsWith: 'بعضهم إحدى',
                endsWith: 'والله أعلم (٢) .',
                from: 442,
            });

            testSegment(segments[1], {
                beginsWith: 'ق: أَحْمَد',
                endsWith: 'عيسى الْبَغْدَادِيّ.',
                from: 442,
                to: 443,
            });

            testSegment(segments[2], {
                beginsWith: 'قال عَبد الرَّحْمَنِ',
                endsWith: 'ومئتين (١) .',
                from: 443,
                to: 444,
            });
        });

        it('should retain the right from page number', () => {
            pages = [
                {
                    content: 'وَقَال إبراهيم بْن مُحَمَّدِ بْن سفيان النيسابوري: سمعت أبا',
                    id: 2533,
                },
                {
                    content: 'وقَال البُخارِيُّ: قال أحمد: مات سنة ست ومئتين.',
                    id: 2534,
                },
                {
                    content:
                        'روى له الجماعة (١) .\r١١٢٨ ع: حجاج بن المنهال الأنماطي أَبُو مُحَمَّد السلمي (٢) وقيل: البرساني، مولاهم، البَصْرِيّ.\rرَوَى عَن: جرير بْن حازم (خ فق) ، وجويرية بْن أسماء (خ) ، وحماد بْن زيد (خ) ، وحماد بن سلمة (خت ٤) ، وداود بْن أَبي  (خ) ، وشعبة بْن الحجاج (خ س) ، وعبد الله بْن عُمَر النميري (خ) ، وعبد العزيز بن عَبد اللَّهِ بن أَبي سلمة الماجشون (خ) ،',
                    id: 2535,
                },
            ];

            const segments = segmentPages(pages, {
                breakpoints: [
                    {
                        pattern: '{{tarqim}}\\s*',
                    },
                    '',
                ],
                maxPages: 1,
                rules: [
                    {
                        lineStartsAfter: ['{{raqms:num}} {{rumuz}}:'],
                    },
                ],
            });

            expect(segments).toHaveLength(3);

            testSegment(segments[0], {
                beginsWith: 'وَقَال إبراهيم',
                endsWith: 'ومئتين.',
                from: 2533,
                to: 2534,
            });

            testSegment(segments[1], {
                content: 'روى له الجماعة (١) .',
                from: 2535,
            });

            testSegment(segments[2], {
                beginsWith: 'حجاج بن المنهال',
                endsWith: 'سلمة الماجشون (خ) ،',
                from: 2535,
                meta: {
                    num: '١١٢٨',
                },
            });
        });

        it('should be able to handle when there is some substrings repeated (الرجال والنساء.)', () => {
            pages = [
                {
                    content:
                        'وأما السنة، فإن الله تعالى وفق لها حفاظا عارفين، وجهابذة عالمين، وصيارفة ناقدين، ينفون عنها تحريف الغالين، وانتحال المبطلين، وتأويل الجاهلين، فتنوعوا في تصنيفها، وتفننوا في تدوينها على أنحاء كثيرة وضروب عديدة، حرصا على حفظها، وخوفا من إضاعتها، وكان من أحسنها تصنيفا، وأجودها تأليفا، وأكثرها صوابا، وأقلها خطأ، وأعمها نفعا، وأعودها فائدة، وأعظمها بركة، وأيسرها مؤونة، وأحسنها قبولا عند الموافق والمخالف وأجلها موقعا عند الخاصة والعامة: صحيح أَبِي عَبد اللَّهِ مُحَمَّد بْن إسماعيل البخاري، ثم صحيح أبي الحسين مسلم بن الحجاج النيسابوري، ثم بعدهما كتاب السنن لابي داود سُلَيْمان بْن الأشعث السجستاني، ثم كتاب الجامع لابي عِيسَى مُحَمَّدُ بْنُ عِيسَى التِّرْمِذِيّ، ثم كتاب السنن لابي عَبْدِ الرَّحْمَنِ أَحْمَدُ بْنُ شُعَيْبِ النَّسَائي، ثم كتاب السنن لأبي عَبد الله مُحَمَّد بْن يزيد المعروف بابن ماجة القزويني وإن لم يبلغ درجتهم.\rولكل واحد من هذه الكتب الستة مزية يعرفها أهل هذا الشأن، فاشتهرت هذه الكتب بين الانام، وانتشرت في بلاد الاسلام، وعظم\rالانتفاع بها، وحرص طلاب العلم على تحصيلها، وصنفت فيها تصانيف، وعلقت عليها تعاليق، بعضها في معرفة ما اشتملت عليه من المتون، وبعضها في معرفة ما احتوت عليه من الأسانيد، وبعضها في مجموع ذلك.\rوكان من جملة ذلك كتاب "الكمال" (١) الذي صنفه الْحَافِظ أَبُو مُحَمَّد عبد الغني بْنِ عَبْدِ الْوَاحِدِ بْنِ عَلِيِّ بن سرور المقدسي رحمة الله عليه في معرفة أحوال الرواة الذين اشتملت عليهم هذه الكتب الستة. وهو كتاب نفيس، كثير الفائدة، لكن لم يصرف مصنفه رحمه الله عنايته إليه حق صرفها، ولا استقصى الأَسماء التي اشتملت',
                    id: 107,
                },
                {
                    content:
                        'عليها هذه الكتب استقصاء تاما، ولا تتبع جميع تراجم الأَسماء التي ذكرها في كتابه تتبعا شافيا، فحصل في كتابه بسبب ذلك إغفال وإخلال.\rثم إن بعض ولده ممن لم يبلغ في العلم مبلغه، ولا نال في الحفظ درجته رام تهذيب كتابه وترتيبه واختصاره واستدراك بعض ما فاته من الأَسماء، فكتب عدة أسماء من أسماء الصحابة الذين أغفلهم والده من تراجم كتاب "الاطراف" (١) الذي صنفه الْحَافِظ أَبُو الْقَاسِم علي بْن الحسن بن هبة الله الدمشقي المعروف بابن عساكر رحمه الله وأسماء يسيرة من أسماء التابعين من كتاب "الاطراف" أيضا. وكتب عدة أسماء ممن أغفلهم والده من كتاب"المشايخ النبل"الذي صنفه الْحَافِظ أَبُو الْقَاسِمِ ابن عساكر أيضا.\rولم يزد في عامة ذلك على ما ذكره الحافظ أبو القاسم شيئا. فوقعت عامة تلك الأَسماء المستدركة في الكتاب مختصرة منتفة، ولا يحصل بذكرها كذلك كبير فائدة. ووقع في بعض ما اختصره بلفظه من كتاب والده خلل كبير، ووهم شنيع.\rفلما وقفت على ذلك، أردت تهذيب الكتاب وإصلاح ما وقع فيه من الوهم والاغفال، واستدراك ما حصل فيه من النقص والاخلال، فتتبعت الأَسماء التي حصل إغفالها منهما جميعا، فإذا هي أسماء كثيرة تزيد على مئات عديدة من أسماء الرجال والنساء. ثم وقفت على عدة مصنفات لهؤلاء الأئمة الستة غير هذه الكتب الستة وستأتي أسماؤها قريبا إن شاء اللَّه تعالى فإذا هي تشتمل على أسماء كثيرة ليس لها ذكر في الكتب الستة، ولا في شيء منها، فتتبعتها تتبعا تاما، وأضفتها إلى ما قبلها، فكان مجموع ذلك زيادة على ألف وسبع مئة اسم من الرجال والنساء. فترددت بين كتابتها مفردة عن كتاب الاصل، وجعلها كتابا مستقلا',
                    id: 108,
                },
                {
                    content:
                        'بنفسه، وبين إضافتها إلى كتاب الاصل، ونظمها في سلكه، فوقعت الخيرة على إضافتها إلى كتاب الاصل، ونظمها في سلكه، وتمييزها بعلامة تفوزها عنه، وهو أن أكتب الاسم، واسم الاب أو ما يجري مجراه بالحمرة وأقتصر في الاصل على كتابة الاسم خاصة بالحمرة.\rوجعلت لكل مصنف علامة (١) ، فإن تكرر الاسم في أكثر من مصنف واحد اقتصرت على عزوه إلى بعضها في الغالب.\rفعلامة ما اتفق عليه الجماعة الستة في الكتب الستة: (ع)\rوعلامة ما اتفق عليه أصحاب السنن الأربعة في سننهم الأربعة: (٤) .\rوعلامة ما أخرجه البخاري في الصحيح: (خ) ، وعلامة ما استشهد به في الصحيح تعليقا: (خت) .\rوعلامة ما أخرجه فِي كتاب القراءة خلف الإمام: (ز) .\rوعلامة ما أخرجه في كتاب رفع الدين في الصلاة: (ي) . وعلامة ما أخرجه في كتاب الادب: (بخ) . وعلامة ما أخرجه في كتاب أفعال العباد: (عخ) (٢) .\rوعلامة ما أخرجه مسلم في الصحيح: (م) ، وعلامة ما أخرجه في مقدمة كتابه: (مق) (٣) .\rوعلامة ما أخرجه أبو داود في كتاب السنن: (د) ، وعلامة ما أخرجه في كتاب المراسيل: (مد) . وعلامة ما أخرجه في كتاب الرد عَلَى أهل القدر: (قد) . وعلامة ما أخرجه في كتاب الناسخ والمنسوخ: (خد) .',
                    id: 109,
                },
            ];

            const segments = segmentPages(pages, options);

            expect(segments).toHaveLength(2);

            testSegment(segments[0], {
                beginsWith: 'وأما السنة',
                endsWith: ' الرجال والنساء.',
                from: 107,
                to: 108,
            });

            testSegment(segments[1], {
                beginsWith: 'فترددت بين كتابتها',
                endsWith: 'الناسخ والمنسوخ: (خد) .',
                from: 108,
                to: 109,
            });
        });

        it('should not create a segment for a naql mid-sentence', () => {
            pages = [
                { content: 'أَخْبَرَنَا أَبُو الْحَسَنِ بْنُ الْبُخَارِيِّ، قال:', id: 1 },
                // Starts with naql but previous page did NOT end with tarqim => should be treated as continuation (no split)
                { content: 'أخبرنا بِهِ إِسْمَاعِيلُ بْنُ إِبْرَاهِيمَ.', id: 2 },
                // Starts with naql and previous page ends with tarqim => should split here
                { content: 'أَخْبَرَنَا بِهِ أَبُو إِسْحَاقَ ابْنُ الدَّرَجِيِّ', id: 3 },
            ];

            const segments = segmentPages(pages, {
                rules: [{ fuzzy: true, lineStartsWith: ['{{naql}}'], pageStartGuard: '{{tarqim}}' }],
            });

            expect(segments).toHaveLength(2);
            testSegment(segments[0], { beginsWith: 'أَخْبَرَنَا أَبُو', endsWith: 'إِبْرَاهِيمَ.', from: 1, to: 2 });
            testSegment(segments[1], { content: pages.at(-1)!.content, from: 3 });
        });

        it('should split the pages with the breakpoints', () => {
            pages = [
                {
                    content: '٥٦١٣ - د س ق: مُحَمَّد بن مصفى بن بهلول القرشي (٣) ،',
                    id: 14214,
                },
                {
                    content:
                        'أبو عَبد الله الحمصي.\rورى عَن: أَحْمَد بْن خالد الوهبي (ق) ، وأحمد بْن عَبد الله بْن يونس، وآدم بْن أَبي إياس، وأبي النضر إسحاق بْن إبراهيم الفراديسي، وأبي ضمرة أنس بن عياض (ق) ، وبقية بن الوليد (د س ق) ، وحفص بن عُمَر العدني، وأبي اليمان الحكم بن نافع، وسفيان بن عُيَيْنَة، وسلم بْن ميمون الخواص، وسُلَيْمان بْن عَبْد الرحمن، وسويد بن عَبْد الْعَزِيزِ، وشريح بن يزيد الحضرمي، والعباس بن إسماعيل، والعباس بن الوليد صاحب شعبة، وأبي مسهر عبد الآعلى بْن مسهر، وعَبد الرَّحِيمِ بن سُلَيْمان، وأبي المغيرة عبد القدوس بن الحجاج (د) ، وعُبَيد الله بن مُوسَى، وعتبة بن سَعِيد ابن الرخص (١) ، وعثمان بن عَبْدِ الرَّحْمَنِ (ق) ، وعصام بن خالد، وعصام بن المثنى بن وائل الحمصي، وعلي بن عياش (د) ، ومحمد بن إسماعيل بن عياش، ومحمد بْن إِسْمَاعِيل بْن أَبي فديك (د) ، ومحمد بن حرب الخولاني (د س ق) ، ومحمد بْن حمير (ق) ، ومحمد بن شعيب بن شابور، وأبي الجماهر مُحَمَّد ابن عُثْمَان التنوخي، ومحمد بْن الْمُبَارَك الصوري (د) ، ومروان بْن مُحَمَّد الطاطري، وأبيه مصفى بن بهلول القرشي، والمعافى بن عِمْران الظهري، ومعاوية بن حفص (س) ، ومنبه بن عثمان اللخمي، وأبي سلمة مُوسَى بن إسماعيل، وهاشم بن عَمْرو',
                    id: 14215,
                },
                {
                    content:
                        'الحمصي شقران، وهشام بن عمار، والوليد بْن مسلم (د س ق) ، ويحيى بن سَعِيد العطار الحمصي، ويسرة بن صفوان اللخمي، ويوسف بْن السفر.\rرَوَى عَنه: أبو داود، والنَّسَائي، وابن ماجه، وإبراهيم بن دحيم، وإبراهيم بن مُحَمَّد بْن عرق الحمصي، وأَبُو عَبد المَلِك أَحْمَد بْن إِبْرَاهِيم البسري، وأحمد بْن سيار المروزي، وأَبُو على أَحْمَد بْن مُحَمَّد بْن عَلِيّ بْن رزين الباشاني، وأَبُو على أَحْمَد بْن مُحَمَّد بن فضالة الحمصي، وأَحْمَد بن المعلى بْن يَزِيد الْقَاضِي، وأَحْمَد بْن يَحْيَى بْن جابر البلاذري، وأَحْمَد بْن يَحْيَى الأنطاكي قرقرة (١) وإسحاق بْن إِبْرَاهِيم بْن نصر البشتي (٢) النيسابوري، وإسحاق بن إبراهيم البستي (٣) الْقَاضِي، وأَبُو عقيل أنس بْن سلم الخولاني، وبقي بْن مخلد الأندلسي، وجعفر بْن أَحْمَد بن عاصم الدمشقي، وأَبُو الطاهر الْحَسَن بْن أَحْمَد بْن إِبْرَاهِيم بن فيل الأنطاكي، والحسين بن إبراهيم السكوني، وأَبُو عَرُوبَة الحسين بن مُحَمَّد الحراني، وحميد بن مُحَمَّد بن النضر البعلبكي، وخالد بْن روح الثقفي، وزكريا بْن يحيى السجري، وسَعِيد بْن عَبْد الْعَزِيزِ الحلبي، وسُلَيْمان بن مُحَمَّد الخزاعي، والعباس بن أحمد بْن',
                    id: 14216,
                },
                {
                    content:
                        'حسان الشامي، وأَبُو بكر عَبد اللَّهِ بْن أَبي داود، وعَبد الله بْن مُحَمَّد بْن سلم المقدسي، وأَبُو مُحَمَّد عبد الصمد بْن عَبد اللَّهِ بْن عبد الصمد، وعبد الغافر بن سلامة الحمصي، وعبدان بن أَحْمَدَ الأهوازي، وعُمَر بن سَعِيد بن سنان المنبجي، وعِمْران بن مُوسَى ابن فضالة الموصلي، ومحمد بن إدريس بْن أَبي حمادة الأنطاكي، ومحمد بْن بركة برداعس، ومُحَمَّد بْن تمام بن صالح البهراني، ومحمد بن جابر الرملي، ومحمد بن الحسن بْن قتيبة العسقلاني، ومحمد بْن العباس بْن الدرفس، ومُحَمَّد بْن عَبد اللَّهِ بْن عبد السلام مكحول البيروتي، وأبو بكر مُحَمَّد بْن عَبد اللَّهِ بْن مُحَمَّد الطائي الحمصي، ومُحَمَّد بْن عُبَيد اللَّهِ بْن الفضيل الكلاعي، وأَبُو بَكْر مُحَمَّد بْن مُحَمَّد بن سُلَيْمان الباعندي، ومحمد بن يحيى بن رزين العطار الحمصي، ومحمد بن يوسف بن بشر بن ماموية الهروي، وأَبُو أَحْمَد المرار بْن حمويه الهمذاني (ق) ، وموسى بن جمهور التنيسي، وأَبُو عِمْران مُوسَى بن العباس الجويني، وأَبُو بشر الدولابي، وأبو حاتم الرازي، وأبو زُرْعَة الدمشقي، وأَبُو علي بن قيراط.\rقال أَبُو حَاتِم (١) : صدوق.\rوَقَال النَّسَائي (٢) : صالح (٣) .',
                    id: 14217,
                },
                {
                    content:
                        'وَقَال صَالِح بْن مُحَمَّد الْبَغْدَادِيّ: كان مخلطا، وأرجو أن يكون صادقا، وقد حدث بأحاديث مناكير.\rوذكره ابنُ حِبَّان في كتاب "الثقات" (١) ، وَقَال: كَانَ يخطئ.\rوَقَال أيضاً (٢) : سمعت ابن فضيل يقول: عادلته من حمص إلى مكة سنة ست وأربعين ومئتين فاعتل بالجحفة، ومات بمنى.\rوَقَال أيضا (٣) : سمعت مكحول يقول: سمعت مُحَمَّد (٤) بن عوف يقول: رأيت مُحَمَّد بن مصفى في النوم، وكان مات بمكة، فقلت: يا أبا عَبد الله أليس قدمت إلى ما صرت؟ قال: إلى خير، ومع ذلك فنحن نرى ربنا كل يوم مرتين. فقلت: يا أبا عَبد اللَّهِ، صاحب سنة في الدنيا وصاحب سنة في الآخرة. قال: فتبسم إلي (٥) .',
                    id: 14218,
                },
            ];

            const segments = segmentPages(pages, options);

            expect(segments).toHaveLength(4);

            // Segment 1: from 14214 to 14215, ends at "أبو عَبد الله الحمصي."
            testSegment(segments[0], {
                beginsWith: 'مُحَمَّد بن مصفى',
                endsWith: 'الحمصي.',
                from: 14214,
                meta: { num: '٥٦١٣' },
                to: 14215,
            });

            // Segment 2: from 14215 to 14216, starts with "ورى عَن:", ends with "ويوسف بْن السفر."
            testSegment(segments[1], {
                beginsWith: 'ورى عَن:',
                endsWith: 'السفر.',
                from: 14215,
                to: 14216,
            });

            // Segment 3: from 14216 to 14217, ends at "وَقَال النَّسَائي (٢) : صالح (٣) ."
            testSegment(segments[2], {
                beginsWith: 'رَوَى عَنه:',
                endsWith: 'صالح (٣) .',
                from: 14216,
                to: 14217,
            });

            // Segment 4: page 14218 only
            testSegment(segments[3], {
                beginsWith: 'وَقَال صَالِح',
                endsWith: 'فتبسم إلي (٥) .',
                from: 14218,
            });
        });
    });

    it('should not match عَ with diacritics or followed by another character that is not a ramz', () => {
        initPages(['٤٩٢٢ - عَن: قَيْس بن مُسْلِم الْمَذْحَجِيّ (١) ، شامي.\r• • •']);

        const segments = segmentPages(pages, {
            replace: [{ regex: '\r• • •', replacement: '' }],
            rules: [
                {
                    lineStartsAfter: ['{{raqms:num}} {{dash}} {{rumuz:rumuz}}:\\s*'],
                },
            ],
        });

        expect(segments).toEqual([{ content: pages[0].content, from: 0 }]);
    });

    it('should not merge the page with the next when maxPages=0 and using breakpoint to swallow entire page', () => {
        options = {
            breakpoints: [''],
            maxPages: 0,
            replace: [],
            rules: [],
        };

        initPages([
            'الحمد لله رب العالمين ولا عدوان إلا على الظالمين والعاقبة للمتقين وصلى الله وسلم وبارك على نبينا محمد وعلى آله وصحبه اجمعين أما بعد فإن علماء السوء كانوا ومازالوا ينشرون فتاوى مخزية تشوه صورة الإسلام وجماله ومحاسنه\nوتنشر الرذيلة لتقوم مقام الفضيلة ، وقد أمرنا الله تعالى بجهاد هؤلاء الأئمة المضلين المفسدين الذين يضلون أتباعهم ويفسدون عقائدهم وأخلاقهم .\nولقد وقفت على فتوى للمفتي الأكبر للفرقة الإباضية  أحمد خليلي هذا نصها :\n(رجل كثير الذنوب والمعاصي ولكن يحج ويعتمر ويفعل الخير ومواظب على الصلاة، ولكن يمارس عمل قوم لوط  ويتوب ثم يرجع عدة مرات، ولكن الآن تاب توبة يعلم الله أنها صادقة فما قولكم فيما مضى عليه والله من وراء القصد ؟\nإن تاب إلى الله قبل توبته، ولكن إن كان مارس اللواط مع صبي أو مجنون أو مملوك أو مكره فعليه لمن مارس معه مهر الثيب من النساء والله أعلم .\nوسئل أيضاً السؤال التالي:\nرجل بلغ مبلغ الرجال في سن الرابعة عشر، وقام بنكح الدواب وعمل قوم لوط، ولكن بعدما بلغ العشرين من العمر تاب توبة نصوحة ولم يعمل من هذه الخبائث شيئاً فماذا عليه الآن بعد التوبة والاستغفار والندم ؟\nعليه التوبة إلى الله عز وجل وعليه ضمان تلك الحيوانات التي فجر بها لأربابها، فإن لم يعرفهم فلفقراء المسلمين، وعليه إن كان الذين لاط بهم صبيانا أو مجانين أو مماليك أو أكرههم على ذلك ولم يكونوا راضين به، أن يدفع إلى كل من هؤلاء العقر، وهو مهر الثيب ويقدر بنصف عشر ديتها والله أعلم\nالمصدر : الفتاوى للشيخ أحمد الخليلي (٢ /٣٢٩)\nأيها الإباضي المغرر بك تأمل وتدبر وتعجب هل هذا قول رجل عرف العلم أو شم رائحته ؟\nهل استند بفتواه على آية محكمة أو حديث صحيح أو حتى ضعيف أو أثر عن صحابي ؟\nأهذا حكم أنزله الله أم أنه من هواه؟\nيقول الخليلي إذا مارس اللواط مع صبي أو مجنون أو مملوك أو مكره فعليه لمن مارس معه مهر الثيب من النساء ، والله إن هذا لشيء عجاب ‼️\nأليس فيكم أيها الإباضية رجل رشيد يقوم بوجهه ويقول كلمة حق ؟\nأين الذين يزعمون أنهم أصحاب حق واستقامة ؟\nهل قوله حق أو باطل ، استقامة أو ضلال ؟\nلماذا لا يقوم بوجهه فتى منكم فيقول\n يا سماحة مفتي الإباضية الأكبر ما دليلك على ما أفتيت به ؟\nوما حكم الله تعالى وليس حكمك في من فعل فاحشة اللواط مع بالغ عاقل حر غير مكره ؟ هل عليه مهر الثيب من النساء أو عليه مهر البكر من النساء أو ماذا ؟\nانتبه أيها الإباضي المغرر بك  ؛ المفتي يقول : للمفعول به مهر الثيب من النساء، فما علاقة المهر بالفاحشة ؟\nوهل إذا زنا الفاجر بإمرأة عليه التوبة والمهر أو ماذا عليه ؟\nوماذا على المرأة إذا أكرهت صبياً أو مجنوناً أو مملوكاً أو عاقلاً أو حراً على الفاحشة ؟\nهل عليها مهر الثيب أو البكر من النساء أو ماذا ؟\nوالأصعب من ذلك كله قولوا للمفتي أليس هذا من الحكم بغير ما أنزل الله ؟\nفإن قال : هذا مما أنزله الله، فقولوا له: أين نجد ذلك في الكتاب والسنة؟\nوأنى له ذلك ؟\nأما إن قال: هذا اجتهادي ؟\nفقولوا له : لا اجتهاد مع النص، ففاعل فاحشة اللواط يقتل بالإجماع لم يقل أحد يدفع غرامة أو تعويض مهر الثيب من النساء ولا البكر .\nأيها الإباضي المغرر بك لقد كفّرت الإباضية الخوارج الخليفة الراشد علي بن أبي طالب رضي الله عنه، ومنهم من قال كَفَرَ كُفْرَ نعمة ، وكافر كفر النعمة مخلد في النار ، ومنهم من قال أتوقف في تكفيره لعله تاب آخر لحظة قبل أن يموت ومنهم من قال مَن كفّره فيحق له ذلك .\nوهل تعلم أيها الإباضي المغرر بك على ماذا استندوا في تكفير هذا الصحابي الجليل المبشر بالجنة علي بن أبي طالب  رضي الله عنه؟\nلقد قالوا : لأنه رضي بالتحكيم ولم يحكم بما أنزل الله تعالى، والله يقول : (وَمَنْ لَمْ يَحْكُمْ بِمَا أَنْزَلَ اللَّهُ فَأُولَٰئِكَ هُمُ الْكَافِرُونَ) (44) سورة المائدة\nأقول : وهل مفتي الإباضية الأكبر في فتواه المخزية قد حكم بما أنزل الله ؟ وإذا كانت فتواه تشريع بما لم يأذن به الله تعالى فما حكمه عند الإباضية ؟\nوالله يقول : (أَمْ لَهُمْ شُرَكَاءُ شَرَعُوا لَهُمْ مِنَ الدِّينِ مَا لَمْ يَأْذَنْ بِهِ اللَّهُ ۚ وَلَوْلَا كَلِمَةُ الْفَصْلِ لَقُضِيَ بَيْنَهُمْ ۗ وَإِنَّ الظَّالِمِينَ لَهُمْ عَذَابٌ أَلِيمٌ (21) سورة الشورى\nوانتبه أيها الإباضي المغرر بك\nلآثار هذه الفتوى الضالة ففيها إشاعة للفاحشة في الذين آمنوا والله تعالى يقول : (إِنَّ الَّذِينَ يُحِبُّونَ أَنْ تَشِيعَ الْفَاحِشَةُ فِي الَّذِينَ آمَنُوا لَهُمْ عَذَابٌ أَلِيمٌ فِي الدُّنْيَا وَالْآخِرَةِ ۚ وَاللَّهُ يَعْلَمُ وَأَنْتُمْ لَا تَعْلَمُونَ (19) سورة النور، وتأمل جواب مفتي الإباضية الأكبر فقد قال إن كان الذي مارس معه اللواط صبي أو مجنون أو مكره وهؤلاء\n لا يرتكب بهم الفاحشة إلا غصباً ، فهذا الفاجر ليس فاعلاً للفاحشة فحسب بل مغتصب والله تعالى قال : (إِنَّمَا جَزَاءُ الَّذِينَ يُحَارِبُونَ اللَّهَ وَرَسُولَهُ وَيَسْعَوْنَ فِي الْأَرْضِ فَسَادًا أَنْ يُقَتَّلُوا أَوْ يُصَلَّبُوا أَوْ تُقَطَّعَ أَيْدِيهِمْ وَأَرْجُلُهُمْ مِنْ خِلَافٍ أَوْ يُنْفَوْا مِنَ الْأَرْضِ ۚ ذَٰلِكَ لَهُمْ خِزْيٌ فِي الدُّنْيَا ۖ وَلَهُمْ فِي الْآخِرَةِ عَذَابٌ عَظِيمٌ) (33) سورة المائدة\nالحمد لله رب العالمين ولا عدوان إلا على الظالمين والعاقبة للمتقين وصلى الله وسلم وبارك على نبينا محمد وعلى آله وصحبه اجمعين أما بعد فإن علماء السوء كانوا ومازالوا ينشرون فتاوى مخزية تشوه صورة الإسلام وجماله ومحاسنه\nوتنشر الرذيلة لتقوم مقام الفضيلة ، وقد أمرنا الله تعالى بجهاد هؤلاء الأئمة المضلين المفسدين الذين يضلون أتباعهم ويفسدون عقائدهم وأخلاقهم .\nولقد وقفت على فتوى للمفتي الأكبر للفرقة الإباضية  أحمد خليلي هذا نصها :\n(رجل كثير الذنوب والمعاصي ولكن يحج ويعتمر ويفعل الخير ومواظب على الصلاة، ولكن يمارس عمل قوم لوط  ويتوب ثم يرجع عدة مرات، ولكن الآن تاب توبة يعلم الله أنها صادقة فما قولكم فيما مضى عليه والله من وراء القصد ؟\nإن تاب إلى الله قبل توبته، ولكن إن كان مارس اللواط مع صبي أو مجنون أو مملوك أو مكره فعليه لمن مارس معه مهر الثيب من النساء والله أعلم .\nوسئل أيضاً السؤال التالي:\nرجل بلغ مبلغ الرجال في سن الرابعة عشر، وقام بنكح الدواب وعمل قوم لوط، ولكن بعدما بلغ العشرين من العمر تاب توبة نصوحة ولم يعمل من هذه الخبائث شيئاً فماذا عليه الآن بعد التوبة والاستغفار والندم ؟\nعليه التوبة إلى الله عز وجل وعليه ضمان تلك الحيوانات التي فجر بها لأربابها، فإن لم يعرفهم فلفقراء المسلمين، وعليه إن كان الذين لاط بهم صبيانا أو مجانين أو مماليك أو أكرههم على ذلك ولم يكونوا راضين به، أن يدفع إلى كل من هؤلاء العقر، وهو مهر الثيب ويقدر بنصف عشر ديتها والله أعلم\nالمصدر : الفتاوى للشيخ أحمد الخليلي (٢ /٣٢٩)\nأيها الإباضي المغرر بك تأمل وتدبر وتعجب هل هذا قول رجل عرف العلم أو شم رائحته ؟\nهل استند بفتواه على آية محكمة أو حديث صحيح أو حتى ضعيف أو أثر عن صحابي ؟\nأهذا حكم أنزله الله أم أنه من هواه؟\nيقول الخليلي إذا مارس اللواط مع صبي أو مجنون أو مملوك أو مكره فعليه لمن مارس معه مهر الثيب من النساء ، والله إن هذا لشيء عجاب ‼️\nأليس فيكم أيها الإباضية رجل رشيد يقوم بوجهه ويقول كلمة حق ؟\nأين الذين يزعمون أنهم أصحاب حق واستقامة ؟\nهل قوله حق أو باطل ، استقامة أو ضلال ؟\nلماذا لا يقوم بوجهه فتى منكم فيقول\n يا سماحة مفتي الإباضية الأكبر ما دليلك على ما أفتيت به ؟\nوما حكم الله تعالى وليس حكمك في من فعل فاحشة اللواط مع بالغ عاقل حر غير مكره ؟ هل عليه مهر الثيب من النساء أو عليه مهر البكر من النساء أو ماذا ؟\nانتبه أيها الإباضي المغرر بك  ؛ المفتي يقول : للمفعول به مهر الثيب من النساء، فما علاقة المهر بالفاحشة ؟\nوهل إذا زنا الفاجر بإمرأة عليه التوبة والمهر أو ماذا عليه ؟\nوماذا على المرأة إذا أكرهت صبياً أو مجنوناً أو مملوكاً أو عاقلاً أو حراً على الفاحشة ؟\nهل عليها مهر الثيب أو البكر من النساء أو ماذا ؟\nوالأصعب من ذلك كله قولوا للمفتي أليس هذا من الحكم بغير ما أنزل الله ؟\nفإن قال : هذا مما أنزله الله، فقولوا له: أين نجد ذلك في الكتاب والسنة؟\nوأنى له ذلك ؟\nأما إن قال: هذا اجتهادي ؟\nفقولوا له : لا اجتهاد مع النص، ففاعل فاحشة اللواط يقتل بالإجماع لم يقل أحد يدفع غرامة أو تعويض مهر الثيب من النساء ولا البكر .\nأيها الإباضي المغرر بك لقد كفّرت الإباضية الخوارج الخليفة الراشد علي بن أبي طالب رضي الله عنه، ومنهم من قال كَفَرَ كُفْرَ نعمة ، وكافر كفر النعمة مخلد في النار ، ومنهم من قال أتوقف في تكفيره لعله تاب آخر لحظة قبل أن يموت ومنهم من قال مَن كفّره فيحق له ذلك .\nوهل تعلم أيها الإباضي المغرر بك على ماذا استندوا في تكفير هذا الصحابي الجليل المبشر بالجنة علي بن أبي طالب  رضي الله عنه؟\nلقد قالوا : لأنه رضي بالتحكيم ولم يحكم بما أنزل الله تعالى، والله يقول : (وَمَنْ لَمْ يَحْكُمْ بِمَا أَنْزَلَ اللَّهُ فَأُولَٰئِكَ هُمُ الْكَافِرُونَ) (44) سورة المائدة\nأقول : وهل مفتي الإباضية الأكبر في فتواه المخزية قد حكم بما أنزل الله ؟ وإذا كانت فتواه تشريع بما لم يأذن به الله تعالى فما حكمه عند الإباضية ؟\nوالله يقول : (أَمْ لَهُمْ شُرَكَاءُ شَرَعُوا لَهُمْ مِنَ الدِّينِ مَا لَمْ يَأْذَنْ بِهِ اللَّهُ ۚ وَلَوْلَا كَلِمَةُ الْفَصْلِ لَقُضِيَ بَيْنَهُمْ ۗ وَإِنَّ الظَّالِمِينَ لَهُمْ عَذَابٌ أَلِيمٌ (21) سورة الشورى\nوانتبه أيها الإباضي المغرر بك\nلآثار هذه الفتوى الضالة ففيها إشاعة للفاحشة في الذين آمنوا والله تعالى يقول : (إِنَّ الَّذِينَ يُحِبُّونَ أَنْ تَشِيعَ الْفَاحِشَةُ فِي الَّذِينَ آمَنُوا لَهُمْ عَذَابٌ أَلِيمٌ فِي الدُّنْيَا وَالْآخِرَةِ ۚ وَاللَّهُ يَعْلَمُ وَأَنْتُمْ لَا تَعْلَمُونَ (19) سورة النور، وتأمل جواب مفتي الإباضية الأكبر فقد قال إن كان الذي مارس معه اللواط صبي أو مجنون أو مكره وهؤلاء\n لا يرتكب بهم الفاحشة إلا غصباً ، فهذا الفاجر ليس فاعلاً للفاحشة فحسب بل مغتصب والله تعالى قال : (إِنَّمَا جَزَاءُ الَّذِينَ يُحَارِبُونَ اللَّهَ وَرَسُولَهُ وَيَسْعَوْنَ فِي الْأَرْضِ فَسَادًا أَنْ يُقَتَّلُوا أَوْ يُصَلَّبُوا أَوْ تُقَطَّعَ أَيْدِيهِمْ وَأَرْجُلُهُمْ مِنْ خِلَافٍ أَوْ يُنْفَوْا مِنَ الْأَرْضِ ۚ ذَٰلِكَ لَهُمْ خِزْيٌ فِي الدُّنْيَا ۖ وَلَهُمْ فِي الْآخِرَةِ عَذَابٌ عَظِيمٌ) (33) سورة المائدة\nأيها الإباضية أليس فيكم رجل رشيد يقول للمفتي اتق الله ؟\nكيف يدفع هذا الفاجر  مهر الثيب من النساء لأولياء الصبي أو المجنون\nأو المكره ؟\nوماذا يقول لهم ؟\nهل يعترف لهم بأنه اغتصب ابنهم، أو استدرجه؟\nولماذا يدفع مهر الثيب من النساء\nولا يدفع مهر البكر من الفتيات ؟\nوكم مهر الثيب من النساء ؟\nوهل لهم أن يساوموه فيطالبونه بأكثر من مهر الثيب من النساء؟\nوإلى أي حد يحق لهم أن يطالبوه؟ وماذا يفعل إذا كان\n لا يملك مهر الثيب من النساء ؟\nوهل تتكفل العاقلة بالدفع عنه؟\nوهل يجوز أن يأخذ من أموال الصدقات والزكوات ليدفع مهر الثيب من النساء لصبي اغتصبه؟!\nوإذا كان لا يملك ورضوا بالأقساط فكم قيمة القسط؟\nوعلى كم سنة يدفع مهر الثيب من النساء؟\nوهل يوثق كتاب الدين الذي بينه وبين أولياء المعتدى عليه ؟\nوهل يوثق في المحكمة أو في مكتب محاماة أو عند شيخ القبيلة ؟\nوماذا يكتب في كتاب التوثيق؟\nهل يكتب لفلان عليّ مبلغ وقدره كذا وكذا مهر الثيب من النساء لأنه اغتصب ابنه مكرهاً بعد ما تم خطفه واستدراجه ؟\nوما سيدفعه الفاجر هل هو حق للصبي المعتدى عليه أو لوالديه أو لوالده أو لوالدته؟\nوالذي نفسي بيده\n لا أدري من أين أتى هذا المفتي بهذه الفتوى المخزية المظلمة التي ليس عليها نور النبوة ولا يدل عليها كتاب ولا سنة ولا أثر ولا قول صحابي ، أقرب ما تكون من فتاوى كتب السحرة والمشعوذين أو من فتاوى الأئمة المفسدين المضلين في الزنجبار الذين يفتون بغير علم فيضلون ويضلون .\nحقاً كما قال تعالى :(وَمَنْ لَمْ يَجْعَلِ اللَّهُ لَهُ نُورًا فَمَا لَهُ مِنْ نُورٍ (40) سورة النور\nوربما والعلم عند الله تعالى أن المفتي الإباضي  افتى بهذه الفتوى المخزية لأن  الفاحشة قد انتشرت مما جعله يغير حكم الله تعالى إلى حكم قاله بهواه، فقد ورد في السؤال أن الرجل كثير الذنوب والمعاصي ويحج ويعتمر ويفعل الخير ومواظب على الصلاة، ولكن يمارس عمل قوم لوط ‼️\nوهذا أمر غريب جداً ففي الغالب أن الذي يحافظ على الصلاة ويحج ويعتمر ويفعل الخيرات لا يمارس فاحشة اللواط، لكن ربما - والله اعلم - فساد العقيدة كما هو معلوم عادة يؤدي إلى فساد العبادات والأخلاق ،\nوالإباضية في تغيير أحكام الله تعالى ليسوا بدعاً من البشر فقد فعل ذلك قبلهم اليهود فقد أخرج البخاري في صحيحه حديث(6450 ) عن\nعَبْدِ اللَّهِ بْنِ عُمَرَ رَضِيَ اللَّهُ عَنْهُمَا أَنَّهُ قَالَ:  إِنَّ الْيَهُودَ جَاءُوا إِلَى رَسُولِ اللَّهِ صَلَّى اللَّهُ عَلَيْهِ وَسَلَّمَ فَذَكَرُوا لَهُ أَنَّ رَجُلًا مِنْهُمْ وَامْرَأَةً زَنَيَا فَقَالَ لَهُمْ رَسُولُ اللَّهِ صَلَّى اللَّهُ عَلَيْهِ وَسَلَّمَ: (مَا تَجِدُونَ فِي التَّوْرَاةِ فِي شَأْنِ الرَّجْمِ) فَقَالُوا: نَفْضَحُهُمْ وَيُجْلَدُونَ قَالَ عَبْدُ اللَّهِ بْنُ سَلَامٍ كَذَبْتُمْ إِنَّ فِيهَا الرَّجْمَ فَأَتَوْا بِالتَّوْرَاةِ فَنَشَرُوهَا فَوَضَعَ أَحَدُهُمْ يَدَهُ عَلَى آيَةِ الرَّجْمِ فَقَرَأَ مَا قَبْلَهَا وَمَا بَعْدَهَا فَقَالَ لَهُ عَبْدُ اللَّهِ بْنُ سَلَامٍ: ارْفَعْ يَدَكَ فَرَفَعَ يَدَهُ فَإِذَا فِيهَا آيَةُ الرَّجْمِ قَالُوا صَدَقَ يَا مُحَمَّدُ فِيهَا آيَةُ الرَّجْمِ فَأَمَرَ بِهِمَا رَسُولُ اللَّهِ صَلَّى اللَّهُ عَلَيْهِ وَسَلَّمَ فَرُجِمَا فَرَأَيْتُ الرَّجُلَ يَحْنِي عَلَى الْمَرْأَةِ يَقِيهَا الْحِجَارَةَ)\nفافق أيها الإباضي المغرر بك واحذر علماء السوء من قبل أن يأتي يوم تقول :(رَبَّنَا إِنَّا أَطَعْنَا سَادَتَنَا وَكُبَرَاءَنَا فَأَضَلُّونَا السَّبِيلَا) (67) سورة الاحزاب\nفالحمد لله الذي عافانا مما ابتلاهم به وفضلنا على أهل البدع تفضيلاً .\nوالحمد لله أولاً وآخراً وظاهراً وباطناً وصلى الله وسلم وبارك على نبينا محمد وعلى آله وصحبه أجمعين',
            'الحمد لله رب العالمين ولا عدوان إلا على الظالمين والعاقبة للمتقين وصلى الله وسلم وبارك على نبينا محمد وعلى آله وصحبه أجمعين أما بعد :فمن خلال مناقشاتي للإباضية الحاقدين الشامتين، أرسل لي أحدهم مقطعاً مصوراً تم نشره منذ سنوات لعضو برلمان سابق وهو يجزم بكل ثقة\nأن زواج الشواذ منتشر في الكويت وبعقود رسمية وموثقة بالمئات ‼️\nوزعم العضو البرلماني السابق وهو يرفع صوته مستنكراً الحال التي وصلنا إليها من الفساد، فزعم أنه تحقق من وجود 400 عقد زواج رجل\nمن رجل ‼️\nوقال أنه تحقق من ذلك بنفسه مرتين، وأنه قد انصدم لما عرف هذه المعلومة، أو هذه الحقيقة ‼️\nوأشار بكلامه إلى أن الذين يتزوجون زواج الشاذين كويتيون، لأنهم يستعملون عقود الزواج للحصول على بدل الإجار ، وبدل الإجار كما هو معلوم يصرف للكويتيين\nولما كان من حق بلدي وأهلي عليّ أن أدافع وأذبّ عنهم كل ما يسيء إليهم، لا سيما الإباضية الحاقدين .\nأقول وبالله أستعين : هذا الكلام غير صحيح بل ولا أساس له من الصحة بتاتاً، وقد رد عليه بعض الغيورين جزاهم الله خيراً لما صرح بذلك التصريح الغريب .\nوالحق أنه لا يوجد ولا عقد زواج واحد موثق رسمي رجل مع رجل فضلاً  أن يكون هناك 400 عقد للشاذين، وأجزم بل أقسم بالله أن دعواه غير صحيحة، فإن وجد شيء من ذلك فهي عقود مزورة غير موثقة إطلاقاً .\nوسأقول لماذا أجزم بل وأقسم بأن هذا الإدعاء غير صحيح .\nأولاً : بصفتي مأذون شرعي منذ ربع قرن أعرف تماماً مدى انضباط إدارة التوثيقات وشدة شروطهم وكيفية التدقيق في توثيق العقود.\nثانياً : إدارة التوثيقات الشرعية إدارة أنشأت منذ عشرات السنين على أيدي رجال أمناء وفيها نخبة من المسؤولين والموظفين الأكفاء ولا يتصور منهم هذه الخيانة بحيث يتم توثيق 400 عقد ازواج الشواذ .\nثالثاً : يشترط في كتابة عقد الزواج حضور ولي الزوجة أو وكالة منه خاصة موثقة\nرابعاً : لا يحق أن يتولى الولي الأبعد عقد الزواج مع وجود ولي أقرب منه، فمثلا الأولى بالولاية الأب فلا يحق للأخ أو العم تزويج البنت مع وجود الأب .\nخامساً : القاضي ولي من\nلا ولي لها، فلا يعقل أن القضاة يعقدون للشواذ\nسادساً : يستخرج الراغب بالزواج كتاباً رسمياً صادراً من المحكمة وموجهاً لوزارة الصحة للحصول على شهادة زواج آمن .\nسابعاً : لا يحق للمأذون كتابة عقد الزواج إلا بعد إحضار الفحص الطبي الصادر من المركز الصحي الحكومي وموثق من وزارة الصحة لبيان الحالة الصحية للطرفين إن كان الزواج آمناً أو غير آمن .\nثامناً : يتم أخذ عينة دم من الطرفين الرجل والمرأة، ويقدم كل منهما إثباته الشخصي الأصلي ولا يمكن في هذه اللحظة قبول رجلين بل لا بد من رجل وامرأة .\nتاسعاً : تصدر الشهادة الصحية في ورقة واحدة يكتب فيها اسم الزوج الكامل ورقم بطاقته وكذلك الزوجة.\nعاشراً : إذا كان أحد الطرفين غير كويتي، فلا بد من عقد الزواج داخل المحكمة أو بكتاب رسمي يتم استخراجه من المحكمة للمأذون الشرعي، ويذكر فيه اسم الزوجين وأرقام البطاقات المدنية أو جواز السفر .\nالحادي عشر : إذا كانت الزوجة سبق لها الزواج فلا بد أن تقدم شهادة طلاق أو شهادة مخالعة أو حصر ورثة لزوجها السابق إذا كانت أرملة، ثم يتم تقييد هذه المستندات في العقد\nمع ذكر رقم وتاريخ المستند .\nالثاني عشر : إذا كان الزوج يعمل في القطاع العسكري فيطلب منه إذن زواج من جهة العمل ويذكر فيه إسم الزوجة ورقم إثباتها .\nالثالث عشر: يتم العقد بشهادة شاهدين ويتم تقييد اسم كل منهما الثلاثي ورقم إثباته في العقد نفسه .\nالرابع عشر : تتم التوقيعات على العقد فيوقع كل من الزوج وولي الزوجة والشاهدين والمأذون يوقع ويختم، ولكل توقيع موضع مخصص له في العقد فمن اليمين توقيع الزوج ثم توقيع ولي الزوجة ثم توقيع الشاهدين ثم توقيع وختم المأذون الشرعي .\nالخامس عشر: بعد كتابة العقد يتم توثيقه عند موظفي التوثيقات في المحكمة أو مركز خدمة المواطن ، وأي ملاحظة أو خطأ يتم الإتصال بالمأذون ويطلب منه تعديل ما يلزم تعديله ولو كان الخطأ في رقم أو تاريخ .\nالسادس عشر : في حال تجاوز المأذون لأي جزئية من جزئيات إجراء العقد يتم التحقيق معه واتخاذ الإجراءات اللازمة في حقه، وإذا كان التجاوز جسيماً يمكن شطب المأذون نهائيا ومصادرة حقه في توثيق العقود .\nالسابع عشر : للحصول على بدل اجار من الإسكان\nلا بد من تقديم عقد زواج موثق رسمياً .\nالثامن عشر : يمكن لطالب بدل الإجار أن يقدم عقد زواج من أي زوجة ومن أي جنسية ولا يحتاج تقديم عقد زواج من رجل .\nالتاسع عشر : لو كان ما ادعاه النائب صحيحاً لانتشر الخبر لا سيما نحن في عصر منصات التواصل الإجتماعي وحرص كثير من الناس على نشر الفضائح وكل ما هو غريب .\nأقول : لهذه الأسباب فإني اجزم بأن خبر زواج 400 رجل برجل لا أساس له من الصحة، فهي إما عقود مزورة أو حصل خطأ في اجراء تدخيل المعلومات، أما أن تكون عقود موثقة رسمياً فهذا لا يعقل\nوقد قيل قديماً : حدّث العاقل بما لا يعقل فإن صدّق فلا عقل له .\nولذلك من استطاع أن يثبت حالة واحدة زواج رجل مع رجل بعقد رسمي موثق فليزودني بإسم المأذون الذي كتب هذا العقد، وأي محكمة تم توثيق العقد فيها واسم المركز الصحي الذي استخرج شهادة (زواج آمن) وسأتكفل برفع قضايا ضد كل من تورط بذلك .\nولكن أنى لأحد أن يثبت حالة زواج رجل من رجل رسمياً.\nفاتقوا الله يا مسلمون في بلدكم وشعبكم ولا تفسدوا سمعة أهلكم\nولا تمكنوا أحداً يظهر الشماتة بنا .\nوأيضاً في هذا الكلام إشاعة للفاحشة والله تعالى يقول:(إِنَّ الَّذِينَ يُحِبُّونَ أَنْ تَشِيعَ الْفَاحِشَةُ فِي الَّذِينَ آمَنُوا لَهُمْ عَذَابٌ أَلِيمٌ فِي الدُّنْيَا وَالْآخِرَةِ ۚ وَاللَّهُ يَعْلَمُ وَأَنْتُمْ لَا تَعْلَمُونَ (19) سورة النور ، وفيه نشر للكذب، روى مسلم في صحيحه (5/67)عَن خُبَيْبِ بْنِ عَبْدِ الرَّحْمن عَن حَفْص بن عَاصِم قال قال رَسُولُ الله صَلَّى الله عَلَيْهِ وَسَلَّمَ : (كَفَى بِالْمَرْءِ كَذِبًا أَنْ يُحَدِّثَ بِكُلِّ مَا سَمِعَ) فعلى كل مسلم نائباً كان أو غيره أن يتجنب إشاعة الفاحشة ويحفظ لسانه من نشر الكذب والبهتان .\nوالله المستعان\nوالحمد لله أولاً وآخراً وظاهراً وباطناً وصلى الله وسلم وبارك على نبينا محمد وعلى آله وصحبه أجمعين',
            'الحمد لله رب العالمين ولا عدوان إلا على الظالمين والعاقبة للمتقين وصلى الله وسلم وبارك على نبينا محمد وعلى آله وصحبه اجمعين أما بعد فإن التوراة والإنجيل والقرآن كلها من كتب الله تعالى التي أنزلها الله تعالى أوجب الله تعالى علينا الإيمان بها قال تعالى :(يَا أَيُّهَا الَّذِينَ آمَنُوا آمِنُوا بِاللَّهِ وَرَسُولِهِ وَالْكِتَابِ الَّذِي نَزَّلَ عَلَىٰ رَسُولِهِ وَالْكِتَابِ الَّذِي أَنْزَلَ مِنْ قَبْلُ ۚ وَمَنْ يَكْفُرْ بِاللَّهِ وَمَلَائِكَتِهِ وَكُتُبِهِ وَرُسُلِهِ وَالْيَوْمِ الْآخِرِ فَقَدْ ضَلَّ ضَلَالًا بَعِيدًا (136) سورة النساء\nولما أنزل كتبه كالتوراة والإنجيل ولم يتكفل بحفظها ولم يشأ ذلك لذلك اعتراها بعض التحريف كما ذكر الله تعالى عن أهل الكتاب فقال :(مِنَ الَّذِينَ هَادُوا يُحَرِّفُونَ الْكَلِمَ عَنْ مَوَاضِعِهِ) (46) سورة النساء\nوقال تعالى : (فَوَيْلٌ لِلَّذِينَ يَكْتُبُونَ الْكِتَابَ بِأَيْدِيهِمْ ثُمَّ يَقُولُونَ هَٰذَا مِنْ عِنْدِ اللَّهِ لِيَشْتَرُوا بِهِ ثَمَنًا قَلِيلًا ۖ فَوَيْلٌ لَهُمْ مِمَّا كَتَبَتْ أَيْدِيهِمْ وَوَيْلٌ لَهُمْ مِمَّا يَكْسِبُونَ)(79) سورة البقرة #محفظ\nوليس كل ما فيها محرف، فلا غرابة أن تجد توافقاً بل وتطابقاً بين اخبار التوراة والإنجيل واخبار القرآن الكريم .\nفظن الإباضيون أن من العيب تطابق عقيدة أهل السنة مع ما في التوراة والإنجيل، بينما الحق أن ذلك مما تمدح به عقيدة أهل السنة ولا تذم .\nقال تعالى في حق نبيه صلى الله عليه وسلم: (ويقولون  أَئِنَّا لَتَارِكُو آلِهَتِنَا لِشَاعِرٍ مَجْنُونٍ (36) بَلْ جَاءَ بِالْحَقِّ وَصَدَّقَ الْمُرْسَلِينَ)(٣٧) سورة الصافات\nوقال تعالى في حق القرآن :\n(أَوَلَمْ يَكُنْ لَهُمْ آيَةً أَنْ يَعْلَمَهُ عُلَمَاءُ بَنِي إِسْرَائِيلَ (197) سورة الشعراء)\nوقال تعالى : (إِنَّ هَٰذَا الْقُرْآنَ يَقُصُّ عَلَىٰ بَنِي إِسْرَائِيلَ أَكْثَرَ الَّذِي هُمْ فِيهِ يَخْتَلِفُونَ (76) سورة النمل\nوقال في حق من آمن من أهل كتاب :(وإذا  سَمِعُوا مَا أُنْزِلَ إِلَى الرَّسُولِ تَرَىٰ أَعْيُنَهُمْ تَفِيضُ مِنَ الدَّمْعِ مِمَّا عَرَفُوا مِنَ الْحَقِّ ۖ يَقُولُونَ رَبَّنَا آمَنَّا فَاكْتُبْنَا مَعَ الشَّاهِدِينَ (83) وَمَا لَنَا لَا نُؤْمِنُ بِاللَّهِ وَمَا جَاءَنَا مِنَ الْحَقِّ وَنَطْمَعُ أَنْ يُدْخِلَنَا رَبُّنَا مَعَ الْقَوْمِ الصَّالِحِينَ (٨٤) فَأَثَابَهُمُ اللَّهُ بِمَا قَالُوا جَنَّاتٍ تَجْرِي مِنْ تَحْتِهَا الْأَنْهَارُ خَالِدِينَ فِيهَا ۚ وَذَٰلِكَ جَزَاءُ الْمُحْسِنِينَ (٨٥) وَالَّذِينَ كَفَرُوا وَكَذَّبُوا بِآيَاتِنَا أُولَٰئِكَ أَصْحَابُ الْجَحِيمِ (٨٦) سورة المائدة\nوكان النبي صلى الله عليه وسلم يعجبه ويسره أن يسمع من اخبار أهل الكتاب ما يوافق ما أنزل الله تعالى إليه، فقد روى البخاري في صحيحه\n(4533) عَنْ عَبْدِ اللَّهِ بن مسعود رَضِيَ اللَّهُ عَنْهُ قَالَ جَاءَ حَبْرٌ مِنْ الْأَحْبَارِ إِلَى رَسُولِ اللَّهِ صَلَّى اللَّهُ عَلَيْهِ وَسَلَّمَ فَقَالَ يَا مُحَمَّدُ إِنَّا نَجِدُ أَنَّ اللَّهَ يَجْعَلُ السَّمَوَاتِ عَلَى إِصْبَعٍ وَالْأَرَضِينَ عَلَى إِصْبَعٍ وَالشَّجَرَ عَلَى إِصْبَعٍ وَالْمَاءَ وَالثَّرَى عَلَى إِصْبَعٍ وَسَائِرَ الْخَلَائِقِ عَلَى إِصْبَعٍ فَيَقُولُ أَنَا الْمَلِكُ فَضَحِكَ النَّبِيُّ صَلَّى اللَّهُ عَلَيْهِ وَسَلَّمَ حَتَّى بَدَتْ نَوَاجِذُهُ تَصْدِيقًا لِقَوْلِ الْحَبْرِ ثُمَّ قَرَأَ رَسُولُ اللَّهِ صَلَّى اللَّهُ عَلَيْهِ وَسَلَّمَ (وَمَا قَدَرُوا اللَّهَ حَقَّ قَدْرِهِ وَالْأَرْضُ جَمِيعًا قَبْضَتُهُ يَوْمَ الْقِيَامَةِ وَالسَّمَوَاتُ مَطْوِيَّاتٌ بِيَمِينِهِ سُبْحَانَهُ وَتَعَالَى عَمَّا يُشْرِكُون)\nبينما أهل البدع من المعتزلة والأشاعرة والإباضية وغيرهم\nيحسبون ذلك عيباً ونقصاً بل وضلالاً أن تتطابق اخبار التوراة والإنجيل مع ما أنزله الله تعالى في القرآن .\nفتراهم ينكرون مثلاً صفة اليد لله تعالى التي وصف الله تعالى بها نفسه كما في قوله تعالى\n (بَلْ يَدَاهُ مَبْسُوطَتَانِ)\nوقوله تعالى (قَالَ يَا إِبْلِيسُ مَا مَنَعَكَ أَنْ تَسْجُدَ لِمَا خَلَقْتُ بِيَدَيَّ ۖ أَسْتَكْبَرْتَ أَمْ كُنْتَ مِنَ الْعَالِينَ (75) سورة ص وحجتهم في ذلك أن اليهود هم الذين وصفوا الله تعالى باليد كما في قوله تعالى\n(وَقَالَتِ الْيَهُودُ يَدُ اللَّهِ مَغْلُولَةٌ ) والحق أن الله تعالى ما لعن اليهود لأنهم اثبتوا لله صفة اليد، فاليد صفة كمال ثابتة بالكتاب والسنة تليق بالله تعالى ولا تماثل صفات المخلوقين، وإنما لعن الله اليهود لأنهم  قالوا يد الله تعالى (مغلولة) ولذلك رد الله تعالى عليهم بقوله (غُلَّتْ أَيْدِيهِمْ وَلُعِنُوا بِمَا قَالُوا ۘ بَلْ يَدَاهُ مَبْسُوطَتَانِ يُنْفِقُ كَيْفَ) (64) سورة المائدة، ولم يقل مثلاً سبحانه ليس له يد .\nوكذلك مما يغلط فيه أهل البدع كثيراً ظنهم أن من سأل الله تعالى رؤيته ففيه شبه باليهود، وهذا من أبطل الباطل، فاليهود جعلوا رؤيتهم لله تعالى شرطاً للإيمان، فسألوا نبي الله موسى عليه السلام إما أن يريهم الله تعالى جهرة أو لن يؤمنوا له ، كما في قوله تعالى (وَإِذْ قُلْتُمْ يَا مُوسَىٰ لَنْ نُؤْمِنَ لَكَ حَتَّىٰ نَرَى اللَّهَ جَهْرَةً فَأَخَذَتْكُمُ الصَّاعِقَةُ وَأَنْتُمْ تَنْظُرُونَ) (55) سورة البقرة\nوقال تعالى: (يَسْأَلُكَ أَهْلُ الْكِتَابِ أَنْ تُنَزِّلَ عَلَيْهِمْ كِتَابًا مِنَ السَّمَاءِ ۚ فَقَدْ سَأَلُوا مُوسَىٰ أَكْبَرَ مِنْ ذَٰلِكَ فَقَالُوا أَرِنَا اللَّهَ جَهْرَةً فَأَخَذَتْهُمُ الصَّاعِقَةُ بِظُلْمِهِمْۚ ثُمَّ اتَّخَذُوا الْعِجْلَ مِنْ بَعْدِ مَا جَاءَتْهُمُ الْبَيِّنَاتُ فَعَفَوْنَا عَنْ ذَٰلِكَ ۚ وَآتَيْنَا مُوسَىٰ سُلْطَانًا مُبِينًا)\nولو كان سؤال رؤية الله تعالى يستوجب غضب الله تعالى لما سأل موسى ربه فقال : (رَبِّ أَرِنِي أَنْظُرْ إِلَيْكَ)\nولذلك لم تؤخذه صاعقة وإنما قال له ربه تبارك وتعالى : (لَنْ تَرَانِي وَلَٰكِنِ انْظُرْ إِلَى الْجَبَلِ فَإِنِ اسْتَقَرَّ مَكَانَهُ فَسَوْفَ تَرَانِي ۚ فَلَمَّا تَجَلَّىٰ رَبُّهُ لِلْجَبَلِ جَعَلَهُ دَكًّا وَخَرَّ مُوسَىٰ صَعِقًا ۚ فَلَمَّا أَفَاقَ قَالَ سُبْحَانَكَ تُبْتُ إِلَيْكَ وَأَنَا أَوَّلُ الْمُؤْمِنِينَ (143) سورة الاعراف\nوالفرق كبير بين سؤال اليهود وسؤال موسى عليه السلام فلا يمكن لمسلم عاقل يذم موسى عليه السلام  لأنه سأل ربه رؤيته .\nوأما نبينا صلوات ربي وسلامه عليه فقد سأل ربه رؤيته يوم القيامة وتبعه بذلك اتباع سنته فهم يسألون الله تعالى لذة النظر إلى وجه الله الكريم، في الجنة وسيكرمهم الله تعالى بذلك كما قال : (وُجُوهٌ يَوْمَئِذٍ نَاضِرَةٌ (22) إِلَىٰ رَبِّهَا نَاظِرَةٌ (23) سورة القيامة، وقد تواترت الأحاديث ولا ينكرها إلا مبتدع قد طمس الله بصيرته\nوالخلاصة صار لسؤال الله تعالى النظر إليه ثلاث حالات :\nالأولى: سؤال الله تعالى النظر إلى وجه الله تعالى الكريم يوم القيامة في الجنة كما في الدعاء المأثور عن النبي صلى الله عليه وسلم(واسألك برد العيش بعد الموت واسألك لذة النظر إلى وجهك) رواه أحمد في مسنده (30/265) وصححه الألباني في الكلم الطيب(106)عن عمار بن ياسر رضي الله عنه\nوهذا محمود ونسأل الله تعالى من فضله.\nالثانية : سؤال الله النظر إليه في الدنيا كما سأل موسى عليه السلام ربه، لكن الله تعالى قال : (لن تراني) .\nالثالثة : سؤال بني اسرائيل رؤية الله تعالى في الدنيا وجعلوا ذلك شرطاً للإيمان فأخذتهم الصاعقة وهذا مذموم\nوالفرق واضح جداً كما لا يخفى على كل منصف والحمد لله رب العالمين.\nومن المسائل التي استنكرها أهل البدع من المعتزلة والخوارج والإباضية على أهل السنة مسألة خروج عصاة الموحدين من النار بعد أن يعذبوا فيها .\nفاليهود كفروا بآيات الله وقتلوا أنبياءه بغير حق\nوقالوا : لموسى أرنا الله جهرة\nوقالوا : إن الله فقير ونحن أغنياء\nوقالوا : يد الله مغلولة\nوقالوا : إنا قتلنا المسيح عيسى بن مريم رسول الله\nوكذبوا رسول الله - صلى الله عليه وسلم - وانكروا نبوته\nوقالوا غير ذلك من الكفريات والواحدة منها تكفي لتستوجب لهم الخلود في النار\nومع هذا كله قالوا : نحن أبناء الله وأحباؤه، ولن تمسنا النار إلا أياماً معدودة\nفأين أقوالهم هذه الكفرية من قول أهل السنة بل أقوال النبي صلى الله عليه وسلم وأحاديثه المتواترة التي اخبرنا بها أن عصاة الموحدين إن عذبهم الله تعالى فإنما يعذبهم إلى أمد لا إلى الأبد ؟\nلا يقول ذلك إلا أحد رجلين إما جاهل لا يعرف من العلم إلا اسمه أو متعصب قد اعمى التعصب بصره وبصيرته .\nوالحمد لله أولاً وآخراً وظاهراً وباطناً وصلى الله وسلم وبارك على نبينا محمد وعلى آله وصحبه أجمعين.',
        ]);

        const segments = segmentPages(pages, options);

        expect(segments).toHaveLength(3);
        expect(segments[0].from).toBe(0);
        expect(segments[0].to).toBeUndefined();

        expect(segments[1].from).toBe(1);
        expect(segments[1].to).toBeUndefined();

        expect(segments[2].from).toBe(2);
        expect(segments[2].to).toBeUndefined();
    });

    it('should handle zero-width character', () => {
        options = {
            rules: [{ lineStartsWith: ['قال تعالى'] }],
        };

        initPages([
            '‎الحمد لله رب العالمين ولا عدوان إلا على الظالمين والعاقبة للمتقين وصلى الله وسلم وبارك على نبينا محمد وعلى آله وصحبه اجمعين أما بعد : فإني لا أبالغ إذا  الجنة والنار إلا من أجل التوحيد، قال تعالى:\n‎(وَمَا خَلَقْتُ الْجِنَّ وَالْإِنْسَ إِلَّا لِيَعْبُدُونِ (56) (الذاريات)\n‎وقال تعالى: (وَلَقَدْ بَعَثْنَا فِي كُلِّ أُمَّةٍ رَسُولًا أَنِ اعْبُدُوا اللَّهَ  مِنْ رَسُولٍ إِلَّا نُوحِي إِلَيْهِ أَنَّهُ لَا إِلَهَ إِلَّا أَنَا فَاعْبُدُونِ (25)(الأنبياء)\n‎والآيات في بيان  فقد أشرك .\n‎قال تعالى: (وَلَا تَدْعُ مَعَ اللَّهِ إِلَٰهًا آخَرَ ۘ لَا إِلَٰهَ إِلَّا هُوَ ۚ كُلُّ شَيْءٍ هَالِكٌ إِلَّا وَجْهَهُ ۚ لَهُ الْحُكْمُ وَإِلَيْهِ تُرْجَعُونَ)(88) (القصص) وقال تعالى: (وَأَنَّ  أجمعين.',
        ]);

        const segments = segmentPages(pages, options);

        expect(segments).toHaveLength(2);
    });
});
