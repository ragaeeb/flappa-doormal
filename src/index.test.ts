import { beforeEach, describe, expect, it } from 'bun:test';
import { type Page, type Segment, type SegmentationOptions, segmentPages } from './index';

const htmlToMarkdown = (html: string): string => {
    return (
        html
            // Move content after line break (or at start) but before title span INTO the span
            .replace(/(^|\r)([^\r]*?)<span[^>]*data-type=["']title["'][^>]*>/gi, '$1<span data-type="title">$2')
            // Convert title spans to markdown headers
            .replace(/<span[^>]*data-type=["']title["'][^>]*>(.*?)<\/span>/gi, '## $1')
            // Strip narrator links but keep text
            .replace(/<a[^>]*href=["']inr:\/\/[^"']*["'][^>]*>(.*?)<\/a>/gi, '$1')
            // Strip all remaining HTML tags
            .replace(/<[^>]*>/g, '')
            .replace(/舄/g, '')
    );
};

const mapPageToMarkdown = (p: Page) => ({ content: htmlToMarkdown(p.content), id: p.id });

const testSegment = (
    segment: Segment,
    { beginsWith, endsWith, ...expected }: Partial<Segment> & { beginsWith?: string; endsWith?: string },
) => {
    expect(segment).toMatchObject(expected);

    if (beginsWith) {
        expect(segment.content).toStartWith(beginsWith);
    }

    if (endsWith) {
        expect(segment.content).toEndWith(endsWith);
    }
};

describe('index', () => {
    let options: SegmentationOptions;
    let pages: Page[];

    describe('2576', () => {
        beforeEach(() => {
            pages = [
                {
                    content:
                        '舄<span data-type="title">(هذا نص التقرير) </span>\rالوارد من حضرة صاحب الفضيلة الأستاذ الأكبر الشيخ حسونة النواوي شيخ الجامع الأزهر - حفظه الله',
                    id: 1,
                },
                {
                    content:
                        '舄﷽\rالحمد للَّه رفع منار السنة النبوية وأعلى مكانها، ووفق من اصطفاه من خلقه لخدمتها فشادوا بنيانها، والصلاة والسلام على المبعوث رحمة للعالمين، سيدنا محمد وعلى آله وصحبه أجمعين والتابعين لهم بإحسان إلى يوم الدين، أما بعد:\rفإن مولانا أمير المؤمنين وخليفة رسول رب العالمين سلطان البرين والبحرين وإمام الحرمين الشريفين، السلطان الأعظم والخاقان الأفخم السلطان ابن السلطان السلطان الغازي عبد الحميد خان الثاني - نصر اللَّه به الإسلام والمسلمين، وأيد بدوام شوكته الملة والدين، وأسعد بوجوده وجوده عموم رعاياه، وحف اللَّه بألطافه الصمدانية وعنايته الربانية ذاته الملوكانية الشاهانية، وعظمته وسلطته الهمايونية - قد تعلقت إرادته السنية العلية بأن يعمل بمقتضى سجاياه الطاهرة الزكية فيما يعود على السنة النبوية بالصلاح، وعلى ذاته الشريفة بالبركة والفلاح، ففكر - أيده اللَّه - في أجل خدمة يسديها للسنة النبوية الحنيفية، فلم ير - وفقه اللَّه - أكمل من نشر أحاديثها الشريفة على وجه يصح معه النقل ويرضاه العقل، وقد اختار - أجله اللَّه - من بين كتب الحديث المنيفة كتاب "صحيح البخاري"، الذي اشتهر بضبط الرواية عند أهل الدراية، فأمر - وأمره الموفق - بأن يطبع في مطبعة مصر الأميرية؛ لما اشتهرت به من دقة التصحيح، وجودة الحروف بين كل المطابع العربية، وبأن يكون طبع هذا الكتاب في هذه المطبعة على النسخة "اليونينية" المحفوظة في الخزانة الملوكية بالآستانة العلية؛ لما هي معروفة به من الصحة القليلة المثال في هذا الجيل وما مضى من الأجيال، وبأن يكون جميع ما يطبع من هذا الكتاب وقفا عامًّا لجميع الممالك الإسلامية، وبأن يتولى قراءة المطبوع بعد تصحيحه في المطبعة جمع من أكابر علماء الأزهر الأعلام، الذين لهم في خدمة الحديث الشريف قدم راسخة بين الأنام، وفي التاسع عشر من شهر رمضان المبارك من سنة ١٣١٢ للهجرة النبوية على صاحبها أفضل الصلاة وأزكى التحية، أبلغ صاحب الدولة الغازي أحمد مختار باشا المندوب العالي العثماني في القطر المصري هذه الأوامر السلطانية إلينا؛ لنجمع من حضرات أكابر العلماء الأزهريين من يعتمد عليهم في هذا الباب، ونقوم معهم بهذه الخدمة الشريفة والأعمال المنيفة، ثم بعث دولته إلينا بالنسخة "اليونينية"، والنسخ المطبوعة على يد صاحب السعادة عبد السلام باشا المويلحي؛ للمقابلة عليها، كما قضى بذلك الأمر الهمايوني الكريم، وقد كان، وجمعنا ستة عشر ممن عم فضلهم واشتهر، وأبلغناهم هذه الأوامر السلطانية، فتلقوها بصدور رحبة وأفئدة فرحة؛ لعلمهم أنها خدمة من أجل الخدم الدينية وأعظمها قدرًا وأكبرها نفعًا، خصوصًا وقد أمر بها جلالة سلطان المسلمين',
                    id: 2,
                },
                {
                    content:
                        '舄وحافظ حوزة الدين، وأظهروا غاية القبول لهذا العمل المأمول، وعلى ذلك جمعنا أيضًا ما أمكن جمعه من نسخ هذا "الصحيح" القديمة، من المكاتب العامة والخاصة، مما عني به المتقدمون ضبطًا وتصحيحًا، وبدأنا مع حضراتهم في العمل بغاية الجد والاجتهاد، حتى تمت قراءته ومقابلته في مدة يسيرة من الزمان، مع بذل ما في الاستطاعة من العناية بضبط الحروف وشكلها وتحري أسماء الرواة وضبطها وأوجه الروايات، فجاء هذا الكتاب الجليل - بحمد اللَّه - على غاية ما يرام، مطابقًا لما أراده مولانا أمير المؤمنين، وحررنا جدولًا بما وجد من الخطأ وما بدل به من الصواب، وقد صارت هذه النسخة الجديدة التي طبعت بأمر مولانا أمير المؤمنين - أيده اللَّه - هي المعول عليها في الصحة والاعتبار، ولا ننسى في هذا المقام فضل الأفاضل المصححين بالمطبعة الأميرية؛ فإنهم بذلوا الوسع في المراجعة والتدقيق في التصحيح بما لا مزيد عليه، وإن شاء اللَّه تعالى يحصل بنشرها النفع العميم والخير العظيم، وتعود بركة ذلك النفع والخير إلى من هو السبب الأول فيه، وهو سيدنا ومولانا الخليفة الأعظم أمير المؤمنين الأفخم؛ فإن جلالته هو الآمر به والمسدي له، جزاه اللَّه عن الإسلام والمسلمين أعظم ما يجازى به إمام عدل في رعيته، وخدم شريعة سيد المرسلين ورفع منار سنته، ولا برحت أياديه البيضاء في خدمة السنة النبوية الغراء ما دام النيران وتعاقب الملوان، آمين.\r\rأما حضرات العلماء الأعلام الذين خدموا صحيح هذا الإمام فهم:\r• حضرة الأستاذ الشيخ سليم البشري شيخ السادة المالكية بالأزهر.\r• حضرة الأستاذ السيد علي الببلاوي من علماء السادة المالكية بالأزهر ونقيب السادة الأشراف بالديار المصرية.\r• حضرة الأستاذ الشيخ أحمد الرفاعي من علماء السادة المالكية بالأزهر وشيخ رواق السادة الفيمة بالأزهر.\r• حضرة الأستاذ الشيخ إسماعيل الحامدي من علماء السادة المالكية بالأزهر وشيخ رواق السادة الصعايدة بالأزهر.\r• حضرة الأستاذ الشيخ أحمد الجيزاوي من علماء السادة المالكية بالأزهر شيخ الجيزاوية بالأزهر.\r• حضرة الأستاذ الشيخ حسن داود العدوي من علماء السادة المالكية بالأزهر وإمام راتب بالجامع الأزهر.\r• حضرة الأستاذ الشيخ سليمان العبد من علماء السادة الشافعية بالأزهر.\r• حضرة الأستاذ الشيخ يوسف النابلسي شيخ السادة الحنابلة بالأزهر.\r• حضرة الأستاذ الشيخ بكري عاشور الصدفي من علماء السادة الحنفية بالأزهر مفتي بيت مال مصر والمجلس الحسبي.\r• حضرة الأستاذ الشيخ عمر الرافعي من علماء السادة الحنفية بالأزهر مفتي مديرية الجيزة.\r• حضرة الأستاذ الشيخ محمد حسين الإبريري من علماء السادة الشافعية.\r• حضرة الأستاذ الشيخ محمد أبو الفضل الوراقي من علماء السادة المالكية.\r• حضرة الأستاذ الشيخ هارون عبد الرازق من علماء السادة المالكية.\r• حضرة الأستاذ الشيخ حسن الطويل من علماء السادة المالكية.\r• حضرة الأستاذ الشيخ حمزة فتح اللَّه مفتش اللغة العربية بالمعارف المصرية.\r• حضرة السيد محمد غانم من أهل العلم الشافعية بالأزهر الذين لهم دراية بعلم الحديث.',
                    id: 3,
                },
                {
                    content:
                        '舄هذا وقد احتفلنا بيوم ختام هذا الكتاب المستطاب في مركز إدارة الجامع الأزهر الأنور، فحضر في ذلك اليوم المشهود جمع من أكابر العلماء، وتليت الأدعية الصالحة المقبولة بدوام عرش الخلافة العظمى وتأييد مولانا أمير المؤمنين، وخطب فيها البعض من أكابرهم ببيان فضل هذا العمل وفضل الآمر به والعاملين فيه، واختتمناها بصالح الدعاء لسيدنا ومولانا أمير المؤمنين، وأمن جميع الحاضرين بقلوب سليمة، وأفئدة مليئة كلها محبة وولاء وصفاء لعرش الخلافة، خلد اللَّه ملك جلالة مولانا أمير المؤمنين فيه على الدوام، آمين.\rيوم الأحد ٢٠ صفر سنة ١٣١٣\rمحل الختم\rالفقير حسونة النواوي الحنفي\rخادم العلم والفقراء بالأزهر.\r\rوقد أنشأ هذه القصيدة والتاريخ حضرة العلامة الفاضل الشيخ سليمان العبد\r(أحد الأفاضل المشروحة أسماؤهم بالتقرير)\rإِنْ رُمْتَ تَحْظَى بِالْقَبُو … لِ وتَرْتَقِي الشَّرَفَ الوَطِيدْ\rفَالْزَمْ صَحِيحًا لِلْبُخَا … رِي تَكْتَسِي العِزَّ المَدِيدْ\rواحْمَدْ أَمِيرَ المؤمِنيـ … ـنَ وَفَضْلَه الفَضْلَ المَزِيدْ\rشَادَ الشَّرِيعَةَ فِي الأَنَا … مِ فَلَا يَزَالُ لَهَا يَشِيدْ\rأَحْيَا لِسُنَّة خَيرِ خَلْـ … ــقِ اللَّهِ لِلْحُسْنَى يُرِيدْ\rعَاشَ الْخَلِيفَةُ سَالمًا … وَلَنَا بِهِ النُّعْمَى تَزِيدْ\rطُبِعَ البُخَارِيُّ طَبَعَةً … فَاقَتْ عَلَى الدُّرِّ النَّضِيدْ\rوَأَفَاضَهَا وَقْفًا عَلَى … مَنْ يَسْتَفِيدُ وَمَنْ يُفِيدْ\rفَنَظَمْتُ نَظْمًا قَدْ حَوَى التَّـ … ـارِيخَ فِي بَيْتِ الْقَصِيدْ\rطَبَعَ البُخَارِيَّ جَيِّدًا … سُلْطَانُنَا عَبْدُ الحَميدْ\r٨١، ٨٤٤، ١٨، ٢٠١، ١٦٩\r\rسنة ١٣١٣',
                    id: 4,
                },
                {
                    content:
                        '舄<span data-type="title">مقدمة </span>\r﷽\r\rيا من أمر بصنع الجميل، وجزى عليه الجزاء الجزيل، نحمدك على ما هديتنا، ونشكرك على ما أوليتنا، ونصلي ونسلم على نبيك الأكرم، ورسولك السيد السند الأعظم، سيدنا ومولانا محمد الذي كان أسرع إلى الخير من الريح المرسلة، وعلى آله وصحبه وكل من والى المعروف وواصله، أما بعد:\rفإن من المآثر العظام والأيادي الجسام التي لا يزال يسديها إلى أمة الإسلام سيدنا ومولانا أمير المؤمنين، وخليفة أشرف الأنبياء والمرسلين، القائم بحياطة الدين وإصلاح أمر العالمين، صاحب الرأفة الشاملة العامة، والإحسانات الجمة التامة، والرحمة التي يرتاح لها كل قوي وضعيف، والهمة العليا التي تنيل كل أحد حاجته من وضيع وشريف، سلطان البرين والبحرين، وخادم الحرمين الشريفين، ظل اللَّه على رعيته، ونعمته الشاملة لبريته، مولانا الإمام العدل المجاهد السلطان ابن السلطان السلطان الغازي عبد الحميد خان الثاني ابن السلطان عبد المجيد خان، أيد اللَّه',
                    id: 5,
                },
                {
                    content:
                        '舄القسط بهمته، وقوم أود الرعية بعدالته، وأكثر خير البلاد بيمنه، وأنام جميع الأنام في ظل أمنه، وأدامه عزًّا للإسلام، ورحمة لجميع الأنام.\rأنه - قوى اللَّه شوكته - أصدر أمره الكريم الشاهاني في سنة ١٣١١ من هجرته ﷺ بطبع الكتاب الجليل الشان، الغني بشهرة نفعه عن الإطراء والبيان، وهو "صحيح الإمام أبي عبد اللَّه محمد بن إسماعيل البخاري" ﵁ وأرضاه، وأن يعتمد في تصحيحه على نسخة شديدة الضبط بالغة الصحة، من فروع النسخة "اليونينية" المعول عليها في جميع روايات "صحيح البخاري" الشريف، وعلى نسخ أخرى خلافها شهيرة الصحة والضبط، وأن تكون نسخه المطبوعة كلها وقفًا على الخاص والعام، من سائر المسلمين شرقًا وغربًا، عجمًا وعربًا.\rوحقيقة أصل "اليونينية" أن شيخ الإسلام الإمام جمال الدين محمد بن مالك لما هاجر من الأندلس واستقر بدمشق، طلب منه فضلاء المحدثين والحفاظ أن يوضح ويصحح لهم مشكلات ألفاظ روايات "صحيح البخاري"، فأجابهم إلى ذلك، ووضحها وصححها لهم في أحد وسبعين مجلسًا، وألف لهم "شواهد التوضيح والتصحيح لمشكلات الجامع الصحيح"، وكتب عند تمام ختم التصحيح على أول ورقة من الجزء الأخير من النسخة "اليونينية" المذكورة ما صورته:\rسمعت ما تضمنه هذا المجلد من "صحيح البخاري" ﵁ بقراءة سيدنا الشيخ الإمام العالم الحافظ المتقن شرف الدين أبي الحسين علي بن محمد بن أحمد اليونيني ﵁ وعن سلفه، وكان السماع بحضرة جماعة من الفضلاء ناظرين في نسخ معتمد عليها، فكلما مر بهم لفظ ذو إشكال بينت فيه الصواب، وضبط على ما اقتضاه علمي بالعربية، وما افتقر إلى بسط عبارة وإقامة دلالة أخرت أمره إلى جزء أستوفي فيه الكلام مما يحتاج إليه من نظير وشاهد؛ ليكون الانتفاع به عامًّا، والبيان تامًّا، إن شاء اللَّه تعالى. وكتبه محمد بن عبد اللَّه بن مالك حامدًا للَّه تعالى. اهـ.\rوكتب الحافظ اليونيني على ظهر آخر ورقة من المجلد المذكور ما صورته:\rبلغت مقابلة وتصحيحًا وإسماعًا بين يدي شيخنا شيخ الإسلام حجة العرب، مالك أزمة الأدب، العلامة أبي عبد اللَّه بن مالك الطائي الجياني، أمد اللَّه تعالى عمره، في المجلس الحادي والسبعين، وهو يراعي قراءتي ويلاحظ نطقي، فما اختاره ورجحه وأمر بإصلاحه أصلحته وصححت عليه،',
                    id: 6,
                },
                {
                    content:
                        '舄 (الجزء الأول)\rمن صحيح أبي عبد اللَّه محمد بن إسماعيل بن إبراهيم بن المغيرة ابن بردزبه البخاري الجعفي رضي اللَّه تعالى عنه ونفعنا به آمين.\r\rقد وجدنا في النسخ الصحيحة المعتمدة التي صححنا عليها هذا المطبوع رموزًا لأسماء الرواة منها:\rهـ لأبي ذر الهروي، وص للأصيلي، وس لابن عساكر، وط لأبي الوقت، وهـ للكشميهني، وحـ للحموي، وسـ للمستملي، وك لكريمة، وحهـ لاجتماع الحموي والكشميهني، وحسـ للحموي والمستملي، وتارة توجد تحت حهـ وحسـ هـ أو غيرها إشارة إلى روايته عنهما، وتارة توجد قبل الرمز (لا) إشارة إلى سقوط الكلمة الموضوعة عليها (لا) عند أصحاب الرمز الذي بعدها، وقد يوجد في آخر تلك الجملة التي عليها (لا) لفظ (إلى) إشارة إلى آخر الساقط عند صاحب الرمز.\rومن الرموز ع ولعلها لابن السمعاني، وج ولعلها للجرجاني، وق ولعلها للقابسي، وح وعط وصع ولم يعلم أصحابها، وربما وجد رموز غير ذلك لم تعلم أيضًا، ويوجد على بعض الكلمات خـ أو ـخـ أو خ وهي إشارة إلى أنها نسخة أخرى، وقد يوجد على الكلمة لفظ صحـ إشارة إلى صحة سماع هذه الكلمة عند المرموز له أو عند الحافظ اليونيني. واللَّه سبحانه أعلم.\r\r(طبع)\rبالمطبعة الكبرى الأميرية ببولاق مصر المحمية\rسنة ١٣١١ هجرية',
                    id: 8,
                },
                {
                    content:
                        '﷽\rقَالَ الشَّيْخُ الإِمَامُ الْحَافِظُ أَبُو عَبْدِ اللَّهِ مُحَمَّدُ بْنُ إِسْمَاعِيلَ بْنِ إِبْرَاهِيمَ بْنِ الْمُغِيرَةِ الْبُخَارِىُّ رَحِمَهُ اللَّهُ تَعَالَى، آمِينَ: كَيْفَ كَانَ بَدْءُ الْوَحْيِ إِلَى رَسُولِ اللهِ ﷺ، وَقَوْلُ اللهِ جَلَّ ذِكْرُهُ: ﴿إِنَّا أَوْحَيْنَا إِلَيْكَ كَمَا أَوْحَيْنَا إِلَى نُوحٍ وَالنَّبِيِّينَ مِنْ بَعْدِهِ﴾.\r<span id="link-1"> </span>',
                    id: 9,
                },
                {
                    content:
                        '١ - حَدَّثَنَا <a href="inr://man-3654">الْحُمَيْدِيُّ عَبْدُ اللهِ بْنُ الزُّبَيْرِ </a>،  قَالَ: حَدَّثَنَا <a href="inr://man-2478">سُفْيَانُ </a>،  قَالَ: حَدَّثَنَا <a href="inr://man-6932">يَحْيَى بْنُ سَعِيدٍ الْأَنْصَارِيُّ </a>،  قَالَ: أَخْبَرَنِي <a href="inr://man-5443">مُحَمَّدُ بْنُ إِبْرَاهِيمَ التَّيْمِيُّ </a>:  أَنَّهُ سَمِعَ <a href="inr://man-4494">عَلْقَمَةَ بْنَ وَقَّاصٍ اللَّيْثِيَّ </a>،  يَقُولُ: سَمِعْتُ <a href="inr://man-4677">عُمَرَ بْنَ الْخَطَّابِ </a>﵁ عَلَى الْمِنْبَرِ، قَالَ: سَمِعْتُ رَسُولَ اللهِ ﷺ، يَقُولُ: <hadeeth-1>«إِنَّمَا الْأَعْمَالُ بِالنِّيَّاتِ، وَإِنَّمَا لِكُلِّ امْرِئٍ مَا نَوَى، فَمَنْ كَانَتْ هِجْرَتُهُ إِلَى دُنْيَا يُصِيبُهَا، أَوْ إِلَى امْرَأَةٍ يَنْكِحُهَا، فَهِجْرَتُهُ إِلَى مَا هَاجَرَ إِلَيْهِ».\r <hadeeth>',
                    id: 10,
                },
                {
                    content: "<span data-type='title' id=toc-30>بَابُ عَلَامَةِ الْمُنَافِقِ</span>",
                    id: 66,
                },
                {
                    content:
                        '٣٣ - حَدَّثَنَا <a href="inr://man-2591">سُلَيْمَانُ أَبُو الرَّبِيعِ </a>قَالَ: حَدَّثَنَا <a href="inr://man-650">إِسْمَاعِيلُ بْنُ جَعْفَرٍ </a>قَالَ: حَدَّثَنَا <a href="inr://man-6506">نَافِعُ بْنُ مَالِكِ بْنِ أَبِي عَامِرٍ أَبُو سُهَيْلٍ، </a>عَنْ <a href="inr://man-5358">أَبِيهِ، </a>عَنْ <a href="inr://man-3320">أَبِي هُرَيْرَةَ، </a>عَنِ النَّبِيِّ ﷺ قَالَ: <hadeeth-31>«آيَةُ الْمُنَافِقِ ثَلَاثٌ: إِذَا حَدَّثَ كَذَبَ، وَإِذَا وَعَدَ أَخْلَفَ، وَإِذَا اؤْتُمِنَ خَانَ».\r <hadeeth>',
                    id: 67,
                },
                {
                    content:
                        '٣٤ - حَدَّثَنَا <a href="inr://man-5178">قَبِيصَةُ بْنُ عُقْبَةَ </a>قَالَ: حَدَّثَنَا <a href="inr://man-2472">سُفْيَانُ، </a>عَنِ <a href="inr://man-2638">الْأَعْمَشِ، </a>عَنْ <a href="inr://man-3909">عَبْدِ اللهِ بْنِ مُرَّةَ، </a>عَنْ <a href="inr://man-6088">مَسْرُوقٍ، </a>عَنْ <a href="inr://man-3823">عَبْدِ اللهِ بْنِ عَمْرٍو، </a>أَنَّ النَّبِيَّ ﷺ قَالَ: <hadeeth-32>«أَرْبَعٌ مَنْ كُنَّ فِيهِ كَانَ مُنَافِقًا خَالِصًا، وَمَنْ كَانَتْ فِيهِ خَصْلَةٌ مِنْهُنَّ، كَانَتْ فِيهِ خَصْلَةٌ مِنَ النِّفَاقِ حَتَّى يَدَعَهَا: إِذَا اؤْتُمِنَ خَانَ، وَإِذَا حَدَّثَ كَذَبَ، وَإِذَا عَاهَدَ غَدَرَ، وَإِذَا خَاصَمَ فَجَرَ.» تَابَعَهُ شُعْبَةُ، عَنِ الْأَعْمَشِ.\r <hadeeth>',
                    id: 68,
                },
                {
                    content: "<span data-type='title' id=toc-31>بَابٌ: قِيَامُ لَيْلَةِ الْقَدْرِ مِنَ الْإِيمَانِ</span>",
                    id: 69,
                },
                {
                    content:
                        '٣٥ - حَدَّثَنَا <a href="inr://man-1588">أَبُو الْيَمَانِ </a>قَالَ: أَخْبَرَنَا <a href="inr://man-2785">شُعَيْبٌ </a>قَالَ: حَدَّثَنَا <a href="inr://man-3645">أَبُو الزِّنَادِ، </a>عَنِ <a href="inr://man-3424">الْأَعْرَجِ، </a>عَنْ <a href="inr://man-3320">أَبِي هُرَيْرَةَ </a>قَالَ: قَالَ رَسُولُ اللهِ ﷺ: <hadeeth-33>«مَنْ يَقُمْ لَيْلَةَ الْقَدْرِ إِيمَانًا وَاحْتِسَابًا غُفِرَ لَهُ مَا تَقَدَّمَ مِنْ ذَنْبِهِ».\r <hadeeth>',
                    id: 70,
                },
                {
                    content:
                        'بَابُ قَوْلِ الْمُحَدِّثِ حَدَّثَنَا أَوْ أَخْبَرَنَا وَأَنْبَأَنَا\rوَقَالَ لَنَا الْحُمَيْدِيُّ: كَانَ عِنْدَ ابْنِ عُيَيْنَةَ حَدَّثَنَا وَأَخْبَرَنَا وَأَنْبَأَنَا وَسَمِعْتُ وَاحِدًا.\rوَقَالَ ابْنُ مَسْعُودٍ: حَدَّثَنَا رَسُولُ اللهِ ﷺ وَهُوَ الصَّادِقُ الْمَصْدُوقُ.\rوَقَالَ شَقِيقٌ عَنْ عَبْدِ اللهِ: سَمِعْتُ النَّبِيَّ ﷺ كَلِمَةً.\rوَقَالَ حُذَيْفَةُ: حَدَّثَنَا رَسُولُ اللهِ ﷺ حَدِيثَيْنِ.\rوَقَالَ أَبُو الْعَالِيَةِ: عَنِ ابْنِ عَبَّاسٍ عَنِ النَّبِيِّ ﷺ فِيمَا يَرْوِي عَنْ رَبِّهِ.\rوَقَالَ أَنَسٌ: عَنِ النَّبِيِّ ﷺ يَرْوِيهِ عَنْ رَبِّهِ ﷿.\rوَقَالَ أَبُو هُرَيْرَةَ: عَنِ النَّبِيِّ ﷺ يَرْوِيهِ عَنْ رَبِّكُمْ ﷿',
                    id: 115,
                },
                {
                    content:
                        '٧٥٦٣ - حَدَّثَنِي <a href="inr://man-415">أَحْمَدُ بْنُ إِشْكَابٍ، </a>حَدَّثَنَا <a href="inr://man-5879">مُحَمَّدُ بْنُ فُضَيْلٍ، </a>عَنْ <a href="inr://man-4642">عُمَارَةَ بْنِ الْقَعْقَاعِ، </a>عَنْ <a href="inr://man-268">أَبِي زُرْعَةَ، </a>عَنْ <a href="inr://man-3320">أَبِي هُرَيْرَةَ </a>﵁ قَالَ: قَالَ النَّبِيُّ ﷺ: <hadeeth-2283>«كَلِمَتَانِ حَبِيبَتَانِ إِلَى الرَّحْمَنِ، خَفِيفَتَانِ عَلَى اللِّسَانِ، ثَقِيلَتَانِ فِي الْمِيزَانِ: سُبْحَانَ اللهِ وَبِحَمْدِهِ، سُبْحَانَ اللهِ الْعَظِيمِ.» <hadeeth>',
                    id: 11208,
                },
            ];

            options = {
                breakpoints: [{ pattern: '{{tarqim}}\\s*' }, ''],
                maxPages: 1,
                prefer: 'longer',
                rules: [
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{basmalah}}'],
                        split: 'at',
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{bab}}'],
                        meta: { type: 'chapter' },
                        split: 'at',
                    },
                    {
                        lineStartsAfter: ['##'],
                        meta: { type: 'chapter' },
                        split: 'at',
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{kitab}}'],
                        meta: { type: 'book' },
                        split: 'at',
                    },
                    {
                        lineStartsAfter: ['{{raqms:num}} {{dash}}'],
                        split: 'at',
                    },
                ],
            };

            pages = pages.map(mapPageToMarkdown);
        });

        it('should segment the pages', () => {
            const segments = segmentPages(pages, options);

            // With page-ID-based span calculation, pages get split more accurately
            expect(segments).toHaveLength(17);

            testSegment(segments[0], {
                beginsWith: '(هذا نص التقرير)',
                endsWith: 'حفظه الله',
                from: 1,
                meta: {
                    type: 'chapter',
                },
            });

            testSegment(segments[1], {
                beginsWith: '﷽',
                endsWith: 'بعلم الحديث.',
                from: 2,
                to: 3,
            });

            testSegment(segments[2], {
                beginsWith: 'هذا وقد',
                endsWith: 'سنة ١٣١٣',
                from: 4,
            });

            testSegment(segments[3], {
                beginsWith: 'مقدمة',
                from: 5,
                meta: {
                    type: 'chapter',
                },
            });

            testSegment(segments[4], {
                beginsWith: '﷽',
                endsWith: 'تعالى. اهـ.',
                from: 5,
                to: 6,
            });

            testSegment(segments[5], {
                beginsWith: 'وكتب الحافظ',
                from: 6,
            });

            testSegment(segments[6], {
                beginsWith: '(الجزء الأول)',
                from: 8,
            });

            testSegment(segments[7], {
                beginsWith: '(طبع)',
                from: 8,
            });

            testSegment(segments[8], {
                beginsWith: '﷽',
                from: 9,
            });

            testSegment(segments[9], {
                beginsWith: 'حَدَّثَنَا الْحُمَيْدِيُّ عَبْدُ اللهِ بْنُ الزُّبَيْرِ',
                endsWith: 'هَاجَرَ إِلَيْهِ».',
                from: 10,
                meta: {
                    num: '١',
                },
            });

            testSegment(segments[10], {
                content: 'بَابُ عَلَامَةِ الْمُنَافِقِ',
                from: 66,
                meta: {
                    type: 'chapter',
                },
            });

            testSegment(segments[11], {
                beginsWith: 'حَدَّثَنَا سُلَيْمَانُ أَبُو الرَّبِيعِ',
                endsWith: 'اؤْتُمِنَ خَانَ».',
                from: 67,
                meta: {
                    num: '٣٣',
                },
            });

            testSegment(segments[13], {
                content: 'بَابٌ: قِيَامُ لَيْلَةِ الْقَدْرِ مِنَ الْإِيمَانِ',
                from: 69,
                meta: {
                    type: 'chapter',
                },
            });

            testSegment(segments[14], {
                beginsWith: 'حَدَّثَنَا أَبُو الْيَمَانِ قَالَ: أَخْبَرَنَا',
                endsWith: 'ذَنْبِهِ».',
                from: 70,
                meta: {
                    num: '٣٥',
                },
            });

            testSegment(segments[15], {
                beginsWith: 'بَابُ قَوْلِ الْمُحَدِّثِ',
                endsWith: 'عَنْ رَبِّكُمْ ﷿',
                from: 115,
                meta: {
                    type: 'chapter',
                },
            });

            testSegment(segments[16], {
                beginsWith: 'حَدَّثَنِي أَحْمَدُ بْنُ إِشْكَابٍ',
                endsWith: 'الْعَظِيمِ.»',
                from: 11208,
                meta: {
                    num: '٧٥٦٣',
                },
            });
        });
    });

    describe('2588', () => {
        beforeEach(() => {
            pages = [
                {
                    content:
                        'المغْني\rالرياض',
                    id: 1,
                },
                {
                    content: 'المغْني',
                    id: 2,
                },
                {
                    content:
                        'بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ\r\r<span data-type="title">مقدمة التحقيق</span>\rنص مختصر لمسائله.\rوكان أبو القاسم عمر بن الحسين المتوفى سنة ٣٣٤ هـ،',
                    id: 5,
                },
                {
                    content:
                        'السابق لها حتى يهدى السبيل.\rغرة ربيع الأول ١٤٠٦ هـ\rعبد اللَّه عبد المحسن التركى\rعبد الفتاح محمد الحلو',
                    id: 56,
                },
                {
                    content:
                        'المغْني\rالجزء الأول',
                    id: 57,
                },
                {
                    content: 'المغْني',
                    id: 58,
                },
                {
                    content:
                        'بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ\r[قال الشيخُ الإِمامُ العالمُ العاملُ شيخُ الإِسلام، قُدْوةُ الأنام، مَجْمُوعُ الفضائل، مُوَفَّقُ الدين أبو محمد عبد اللَّه بن أحمد بن محمد بن قُدامَةَ المَقْدِسِىُّ، قَدَّس اللهُ رُوحَه، وَنوَّر ضَرِيحَهُ: ] (١)\rالحمدُ للَّه بارِئِ الْبَرِيَّات، وغافِر الخَطِيَّات، وعالِمِ الخَفِيَّات، المُطّلِعِ على الضمائِرِ والنِّيَّات، أحاط بكلِّ شَئٍ عِلْما، وَوَسِعَ كُلَّ شَئٍ رحمةً وحِلْما، وَقَهَرَ كُلَّ مخلوقٍ عِزةً وحُكْمًا {يَعْلَمُ مَا بَيْنَ أَيْدِيهِمْ وَمَا خَلْفَهُمْ وَلَا يُحِيطُونَ بِهِ عِلْمًا} (٢)، لا تدركُه الأبصار، ولا تُغيِّره الأعْصار، ولا تَتَوهَّمه الأفكار، {وَكُلُّ شَيْءٍ عِنْدَهُ بِمِقْدَارٍ} (٣)، أتْقَن ما صنَع وأحْكَمه، وأحْصَى كُلَّ شَئٍ وعلمَه، وخلق الإِنسانَ وَعَلَّمَهُ، ورفع قَدْرَ العِلْمِ وعظَّمه، وحظَره على من استرْذَله وحَرَّمَه، وخَصَّ به مِن خَلْقِه مَن كرَّمه، وحَضَّ عبادَه المؤمنين على النَّفِيرِ لِلتَّفَقُّهِ في الدين، فقال تعالى وهو أصدق القائلين: {فَلَوْلَا نَفَرَ مِنْ كُلِّ فِرْقَةٍ مِنْهُمْ طَائِفَةٌ لِيَتَفَقَّهُوا فِي الدِّينِ وَلِيُنْذِرُوا قَوْمَهُمْ إِذَا رَجَعُوا إِلَيْهِمْ لَعَلَّهُمْ يَحْذَرُونَ} (٤)، نَدَبَهم إلى إِنْذَارِ بَرِيَّتِه، كَما نَدَب إلى ذلك أهلَ رسالتِه، ومَنحهم ميراثَ أهلِ نُبُوَّتِه، وَرَضِيَهم للقيامِ بحُجَّتِه، والنِّيابةِ عنه في الإِخبارِ بشريعتِه، واخْتَصَّهم مِن بينِ عبادِه بخَشْيتِه، فقَال تعالى: {إِنَّمَا يَخْشَى اللَّهَ مِنْ عِبَادِهِ الْعُلَمَاءُ} (٥)، ثم أمَر سائِرَ الناسِ\r',
                    id: 59,
                },
                {
                    content:
                        'إلى هذا الطَّرْفِ.\r\r<span data-type="title" id=toc-167><span data-type="title" id=toc-168><span data-type="title" id=toc-169>فصل: </span></span></span>وإنْ خُلِقَ له إصْبَعٌ زائدةٌ، أو يَدٌ زائِدةٌ في مَحَلِّ الفَرْضِ، وَجَب غَسْلُها مع الأَصْلِيَّةِ؛ لأنها نابِتَةٌ فيه، أشْبَهَت الثُّؤْلُولَ (٨)، وإن كانت نابتةً في غيرِ مَحَلِّ الفَرْضِ كالعَضُدِ أو المَنْكِبِ، لم يجِبْ غَسْلُها، سواء كانت قصيرةً أو طويلةً؛ لأنها في غيرِ مَحَلِّ الفَرْضِ، فأشْبَهت شعرَ الرَّأْسِ إذا نزلَ عن الوَجْهِ، وهذا قَوْلُ ابنِ حَامِد وابنِ عَقِيل. وقال القَاضِى: إن كان بَعْضُها يُحَاذِى مَحَلَّ الفَرْضِ غَسَلَ ما يُحاذِيهِ منها. والأَوَّلُ أصَحُّ. واخْتَلَفَ أَصْحابُ الشَّافِعِىِّ (٩) في ذلك، كنَحْوٍ ممَّا ذَكَرْنا. وإن لم يَعْلَم الأَصْلِيَّةَ منهما وجبَ غَسْلُهما جميعًا؛ لأنَّ غَسْلَ إحْدَاهُما واجِبٌ، ولا يَخْرُجُ عن عُهْدَةِ الواجِبِ يَقِينًا إلَّا بِغَسْلِهما، فوَجَبَ غَسْلُهما، كما لو تَنَجَّسَت إحْدَى يَدَيْه ولم يَعْلَمْ عَيْنَها.\r\rفصل: وإن انْقَلَعَتْ (١٠) جِلْدَةٌ مِنْ غيرِ مَحَلِّ الفَرْضِ، حَتَّى تَدَلَّتْ مِنْ مَحَلِّ الْفَرْضِ، وجَبَ غَسْلُها؛ لأنَّ أصْلَها في مَحَلِّ الفَرْضِ، فأشْبَهَت الإِصْبعَ الزائدةَ، وإن تَقَلَّعت (١١) مِن مَحَلِّ الفَرْضِ حتى صارَتْ مُتَدَلِّيةً مِن غيرِ مَحَلِّ الفَرْضِ، لم يَجبْ غَسْلُها؛ قصيرةً كانت أو طويلةً بلا خِلَافٍ، لأنها في غيرِ مَحَلِّ الفَرْضِ. وإن تَقَلَّعت (١١) مِن أحدِ المَحَلّيْنِ، فالْتَحَمَ رَأْسُها في الآخَرِ، وبَقِىَ وَسَطُها مُتَجَافِيًا، صارت كالنابِتَةِ في المَحَلَّيْنِ، يَجِبُ غَسْلُ ما حَاذَى مَحَلَّ الفَرْضِ منها (١٢) من ظاهِرِهَا وباطِنِها، وغَسْلُ ما تحتَها مِن مَحَلِّ الفَرْضِ.\r\rفصل: وإن قُطِعَت يَدُه مِنْ دُون المِرْفَقِ، غَسَلَ ما بَقِىَ مِنْ مَحَلِّ الفَرْضِ. وإن قُطِعَت مِن المِرْفَقِ غَسَلَ العَظْمَ الذي هو طَرَفُ العَضُدِ؛ لأنَّ غَسْلَ العَظْمَيْنِ\r',
                    id: 229,
                },
                {
                    content:
                        'بالموتِ، أشْبَهَت المُدَبَّرَةِ، وتُفارِقُ الحُرَّةَ، فإنَّها كامِلَةٌ.\r\r<span data-type="title" id=toc-8780>فصل: </span>ولا يَجِبُ القصاصُ على الحُرَّةِ بقَتْلِها؛ لعدَمِ المُكافَأَةِ. وإِنْ كان القاتِلُ لها رَقِيقًا، وجَبَ القِصاصُ عليه؛ لأنَّها أكْمَلُ منه. وإِنْ جَنَتْ على عبدٍ أو أَمَةٍ، جنايَةً فيها القِصاصُ، لَزِمَها القِصاصُ؛ لأنَّها أَمَةٌ، أحْكامُها أحْكامُ الإِماءِ، واسْتِحْقاقُها العِتْقَ لا يَمْنَعُ القِصاصَ، كالمُدَبَّرَةِ.\r\r<span data-type="title" id=toc-8781>٢٠٢٦ - مسألة؛ قال: (وإِنْ صَلَّتْ مَكْشُوفَةَ الرَّأْسِ، كُرِهَ لَهَا ذلِكَ، وأَجْزأَهَا)</span>\rإنَّما كُرِهَ لها كَشْفُ رَأْسِها فى صلاتِها؛ لأنَّها قدأخَذَتْ شَبَهًا من الحَرائِرِ، لامْتِناعِ بَيْعِها. وقد سُئِلَ أحمدُ، رَضِىَ اللَّهُ عنه، عن أُمِّ الولدِ كيف تُصَلِّى؟ قال: تُغَطِّى رَأْسَها وقَدَمَيْها؛ لأنَّها لا تُباعُ. وكان الحسنُ يُحِبُّ للأَمَةِ إذا [عَهِدَها سَيِّدُها -يعنى وَطِئَها] (١) - أَنْ لا تُصَلِّىَ إِلَّا مُجْتَمِعَةً. وإِنْ صَلَّتْ مكْشُوفَةَ الرَّأْسِ، أَجْزَأَها؛ لأنَّها أمَةٌ، حكمُها حكمُ (٢) الإِماءِ. قال إبراهيمُ: تُصَلِّى أُمُّ الولدِ بغيرِ قِناعِ، وإِنْ كانَتْ بنتَ سِتِّينَ سَنَةً. وقد رُوِىَ عن أحمدَ، رَضِىَ اللَّهُ عنه، رِوايةٌ أُخْرَى، أَنَّ عَوْرَتَها عَوْرَةُ الحُرَّةِ. وذكرنا ذلك فى كتابِ الصَّلاةِ (٣). والصحيحُ أنّ حُكْمَها حكمُ الإِماءِ، وإنَّما خالَفَتْهُنَّ فى اسْتِحْقاقِها للعِتْقِ، وامْتِناعِ نَقْلِ المِلْكِ فيها، وهذا لا يوجِبُ تغَيُّرَ الحكمِ فى عَوْرَتِها، كالمُدَبَّرَةِ، ولأنَّ الأَصْلَ بقاءُ حُكْمِها فى إباحَةِ كشفِ رَأْسِها، ولم يُوجَدْ ما يَنْقُلُ عنه مِن نَصٍّ، ولا ما فى مَعْناه، فيَبْقَى الحكمُ على ما كان عليه.\r\r<span data-type="title" id=toc-8782>٢٠٢٧ - مسألة؛ قال: (وَإِذَا قَتلَتْ أمُّ الْوَلَدِ سَيِّدَهَا، فعَلَيْهَا قِيمَةُ نَفْسِهَا)</span>\rوجملتُه أَنَّ أُمَّ الولدِ إذا قَتَلَتْ سَيِّدَها، عَتَقَتْ؛ لأنَّها لا يُمْكِنُ نَقْلُ المِلْكِ فيها، وقد زالَ مِلْكُ سَيِّدِها بقَتْلِه، فصارَتْ حُرَّةً، كما لو قَتَلَه غيرُها، وعليها قِيمَةُ نَفْسِها، إِنْ لم يجبِ\r',
                    id: 7954,
                },
                {
                    content:
                        'القِصاصُ عليها. وهذا قولُ أبى يوسفَ. وقال الشافِعِىُّ: عليها الدِّيَةُ؛ لأنَّها تَصِيرُ حُرَّةً. وكذلك (١) لَزِمَها مُوجَبُ جِنايَتِها، والواجِبُ على الحُرِّ بقَتلِ الحُرِّ دِيَتُه (٢).',
                    id: 7955,
                },
                {
                    content:
                        '<span data-type="title" id=toc-210>بابُ الاسْتِطابةِ والحَدَثِ</span>\rالاسْتِطابةُ: هي الاسْتِنْجاءُ بالماءِ أو بالأَحْجارِ، يقال: اسْتَطابَ، وأَطَابَ: إذا اسْتَنْجَى؛ سُمِّىَ اسْتِطابةً لأنَّه يُطَيِّبُ جَسَدَه بإزالةِ الخَبَثِ عنه، قال الشاعر، يَهْجُو رَجُلا (٧):\rيارَخَمًا قَاظَ علَى عُرْقُوبِ (٨)\rيُعْجِلُ كَفَّ الْخَارِىءِ الْمُطِيبِ\rوالاسْتِنْجاءُ: اسْتِفْعالٌ مِن (٩) نَجَوْتُ الشَّجرةَ، أي: قَطَعْتُها، فكَأَنَّه قَطَعَ الأَذَى عنه، وقال ابنُ قُتَيْبَة: هو مَأْخوذٌ من النَّجْوَةِ، وهى ما ارْتَفَعَ من الأرض، لأنَّ مَنْ أرادَ قَضاءَ الحاجةِ اسْتَتَرَ بها. والاسْتِجْمارُ: اسْتِفْعالٌ من الجِمَارِ، وهي الحِجارَةُ الصّغَارُ؛ لأنَّه يَسْتَعْمِلُها في اسْتِجْمارهِ.\r\r<span data-type="title" id=toc-211>٣٥ - مسألة؛ قال: (وليس عَلَى مَنْ نامَ أو خَرَجتْ منه رِيحٌ اسْتِنْجاءٌ)</span>\rلا نَعْلمُ في هذا خِلافا. قال أبو عبد اللَّه: ليس في الرِّيحِ اسْتِنْجاءٌ؛ في كتابِ اللهِ، ولا في سُنَّةِ رَسُولهِ، إنَّما عليه الوُضُوءُ، وقد رُوِىَ عن النبيِّ -صلى اللَّه عليه وسلم-[أنَّه قال] (١): "من اسْتَنْجَى مِنْ رِيحٍ فليس مِنَّا". رَوَاه الطَّبَرَانِيُّ في "مُعْجَمِه الصَّغِير (٢) "، وعن زَيْدِ بنِ أَسْلَم في قوله تعالى: {إِذَا قُمْتُمْ إِلَى الصَّلَاةِ فَاغْسِلُوا وُجُوهَكُمْ}. إذَا قُمْتُمْ',
                    id: 7957,
                },
            ];

            options = {
                breakpoints: [{ exclude: [1, 2, 58], pattern: '{{tarqim}}\\s*' }, ''],
                maxPages: 1,
                prefer: 'longer',
                rules: [
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{basmalah}}'],
                        split: 'at',
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{fasl}}'],
                        split: 'at',
                    },
                    {
                        lineStartsAfter: ['## {{raqms:num}} {{dash}}'],
                        meta: { type: 'chapter' },
                        min: 60,
                        split: 'at',
                    },
                    {
                        lineStartsAfter: ['##'],
                        meta: { type: 'chapter' },
                        split: 'at',
                    },
                    {
                        lineStartsAfter: ['{{raqms:num}} {{dash}}'],
                        min: 60,
                        split: 'at',
                    },
                ],
            };

            pages = pages.map(mapPageToMarkdown);
        });

        it('should segment the pages', () => {
            const segments = segmentPages(pages, options);

            expect(segments).toHaveLength(21);

            testSegment(segments[0], {
                beginsWith: 'المغْني',
                endsWith: 'الرياض',
                from: 1,
            });

            testSegment(segments[1], {
                content: 'المغْني',
                from: 2,
            });

            testSegment(segments[2], {
                content: 'بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ',
                from: 5,
            });

            testSegment(segments[3], {
                beginsWith: 'مقدمة التحقيق',
                endsWith: 'لمسائله.',
                from: 5,
                meta: { type: 'chapter' },
            });

            // Remaining page 5 content after tarqim split (no tarqim in this part)
            testSegment(segments[4], {
                beginsWith: 'وكان أبو القاسم',
                endsWith: 'سنة ٣٣٤ هـ،',
                from: 5,
            });

            testSegment(segments[5], {
                beginsWith: 'السابق لها',
                endsWith: 'يهدى السبيل.',
                from: 56,
            });

            // Remaining page 56 content after tarqim split
            testSegment(segments[6], {
                beginsWith: 'غرة ربيع',
                endsWith: 'محمد الحلو',
                from: 56,
            });

            testSegment(segments[7], {
                beginsWith: 'المغْني',
                endsWith: 'الجزء الأول',
                from: 57,
            });

            testSegment(segments[8], {
                content: 'المغْني',
                from: 58,
            });

            testSegment(segments[9], {
                beginsWith: 'بِسْمِ اللَّهِ الرَّحْمَنِ',
                endsWith: 'أمَر سائِرَ الناسِ',
                from: 59,
            });

            testSegment(segments[10], {
                content: 'إلى هذا الطَّرْفِ.',
                from: 229,
            });

            testSegment(segments[11], {
                beginsWith: 'فصل: وإنْ خُلِقَ',
                endsWith: 'عَيْنَها.',
                from: 229,
            });

            testSegment(segments[12], {
                beginsWith: 'فصل: وإن انْقَلَعَتْ',
                endsWith: 'مَحَلِّ الفَرْضِ.',
                from: 229,
            });

            testSegment(segments[13], {
                beginsWith: 'فصل: وإن قُطِعَت',
                endsWith: 'طَرَفُ العَضُدِ؛',
                from: 229,
            });

            testSegment(segments[14], {
                content: 'لأنَّ غَسْلَ العَظْمَيْنِ',
                from: 229,
            });

            testSegment(segments[15], {
                beginsWith: 'بالموتِ',
                endsWith: 'فإنَّها كامِلَةٌ.',
                from: 7954,
            });

            testSegment(segments[16], {
                beginsWith: 'فصل: ولا يَجِبُ',
                endsWith: 'كالمُدَبَّرَةِ.',
                from: 7954,
            });

            testSegment(segments[17], {
                beginsWith: 'مسألة؛ قال: (وإِنْ',
                endsWith: 'ما كان عليه.',
                from: 7954,
            });

            testSegment(segments[18], {
                beginsWith: 'مسألة؛ قال: (وَإِذَا قَتلَتْ',
                endsWith: 'بقَتلِ الحُرِّ دِيَتُه (٢).',
                from: 7954,
                to: 7955,
            });

            testSegment(segments[19], {
                beginsWith: 'بابُ الاسْتِطابةِ',
                endsWith: ' في اسْتِجْمارهِ.',
                from: 7957,
                meta: { type: 'chapter' },
            });

            testSegment(segments[20], {
                beginsWith: 'مسألة؛ قال: (وليس',
                endsWith: 'إذَا قُمْتُمْ',
                from: 7957,
                meta: { type: 'chapter' },
            });
        });
    });

    describe('misc', () => {
        beforeEach(() => {
            options = {
                breakpoints: [
                    {
                        pattern: '{{tarqim}}\\s*',
                    },
                    '',
                ],
                maxPages: 1,
                rules: [
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{basmalah}}'],
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{fasl}}'],
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{bab}}'],
                        meta: {
                            type: 'chapter',
                        },
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{naql}}'],
                    },
                    {
                        lineStartsAfter: ['## {{raqms:num}}\\s*{{dash}}'],
                        meta: { type: 'chapter' },
                    },
                    {
                        lineStartsAfter: ['##'],
                        meta: {
                            type: 'chapter',
                        },
                        split: 'at',
                    },
                    {
                        lineStartsAfter: ['({{harf}}):'],
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{kitab}}'],
                        meta: {
                            type: 'book',
                        },
                    },
                    {
                        lineStartsAfter: ['{{raqms:num}}\\s*{{dash}}\\s*{{harf}}:'],
                    },
                    {
                        lineStartsAfter: ['{{raqms:num}}\\s*{{dash}}'],
                    },
                    {
                        lineStartsAfter: ['{{raqms:num}} {{harf}} {{harf}}:'],
                    },
                ],
            };
        });

        it('should segment the text', () => {
            pages = [
                {
                    content:
                        'أربعا وتسعين سنة (١) .\r٢٩- خ سي:<span data-type="title" id=toc-70> أَحْمَد بن حميد الطريثيثي، أَبُو الْحَسَن الكوفي، ختن عُبَيد اللَّهِ بْن مُوسَى، ويعرف بدار أم </span>سَلَمَة (٢) .\rوكان من حفاظ الكوفة.',
                    id: 257,
                },
                {
                    content:
                        '١٠٢-<span data-type="title" id=toc-145> تمييز ولهم شيخ آخر يقَالَ له: أَحْمَد بْن مُحَمَّد بْن يحيى بن نيزك بن صَالِح بن عَبْد الرَّحْمَنِ </span>بن عَمْرو بن مرة الهمداني، أَبُو الْعَبَّاس القومسي النيزكي.',
                    id: 435,
                },
            ];
            pages = pages.map((p) => ({ content: htmlToMarkdown(p.content), id: p.id }));

            const segments = segmentPages(pages, options);

            expect(segments).toHaveLength(3);

            testSegment(segments[0], {
                content: 'أربعا وتسعين سنة (١) .',
                from: 257,
            });

            testSegment(segments[1], {
                beginsWith: 'خ سي: أَحْمَد بن حميد',
                endsWith: 'من حفاظ الكوفة.',
                meta: {
                    num: '٢٩',
                    type: 'chapter',
                },
            });

            testSegment(segments[2], {
                beginsWith: 'تمييز ولهم',
                endsWith: 'القومسي النيزكي.',
                meta: {
                    num: '١٠٢',
                },
            });
        });

        it('should split into 3 segments', () => {
            const pages = [
                {
                    content:
                        'بعضهم إحدى هاتين الترجمتين بالأخرى (١) ، والصواب التفريق كما ذكرنا، والله أعلم (٢) .\r١٠٦- ق:<span data-type="title" id=toc-149> أَحْمَد بن مُحَمَّد بن يحيى بن سَعِيد بن فروخ القطان أَبُو سَعِيد البَصْرِيّ، نزيل بغداد، أخو صَالِح </span>بْن مُحَمَّد.\rرَوَى عَن: بهلول بْن المورق، وحجين (٣) بن المثنى، وحسين ابن علي الجعفي، وأبي أسامة حَمَّاد بْن أسامة، وزيد بْن الحباب، وسَعِيد بْن عامر الضبعي، وأبي داود سُلَيْمان بْن داود الطيالسي، وسويد بْن عَمْرو الكلبي، وصفوان بن عيسى الزُّهْرِيّ، وعبد الله بْن نمير، وعبد الرحمن بْن غزوان المعروف بقراد أَبِي نوح، وعبد الرحمن بْن مهدي، وأبي عامر عَبد المَلِك بْن عَمْرو العقدي، وعُبَيد ابن أَبي قرة، وعثمان بْن عُمَر بْن فارس، وعفان بْن مسلم، وعَمْرو بْن مُحَمَّد العنقزي (ق) ، وعَمْرو بْن النعمان، وقريش بْن أنس، ومحاضر',
                    id: 442,
                },
                {
                    content:
                        'ابن المورع، ومحمد بْن بشر العبدي، ومحمد بْن عُمَر الواقدي، وأبيه: مُحَمَّد بن يحيى بن سَعِيد القطان، ومنصور بْن عكرمة، وأبي النَّضْر هاشم بْن الْقَاسِم (ق) ، ويحيى بْن آدم، ويحيى بْن حَمَّاد، وجده يحيى بْن سَعِيد القطان، ويحيى بْن عُمَر الفراء، ويحيى بْن عيسى الرملي، ويزيد بْن هارون، ويونس بْن بُكَيْر الشَّيْبَانِيّ.\rرَوَى عَنه: ابْن ماجه، وأَبُو الْحَسَن أَحْمَد بْن مُحَمَّد بْن عُبَيد الطوابيقي، وأَبُو على أَحْمَد بْن مُحَمَّد بْن مصقلة الأصبهاني، وحاجب ابْن أركين الفرغاني، والحسن بْن علي بْن نصر الطوسي، والحسين بْن إِسْمَاعِيل المحاملي، والحسين بْن يحيى بْن عياش القطان، والخضر ابن مُحَمَّد بْن المرزبان الْبَغْدَادِيّ، وعبد الله بْن أَحْمَد بْن مُوسَى عبدان الأهوازي، وعبد الله بْن جَعْفَر بْن خشيش، وعبد الله بْن مُحَمَّد بْن أَبي الدنيا، وعبد الله بْن مُحَمَّد بْن عَبْد الْعَزِيزِ البغوي، وعبد الله بن محمد ابن ناجية، وعبد الرحمن بْن أَبي حَاتِم الرازي، وعُمَر بْن إِبْرَاهِيم بْن سُلَيْمان المعروف بأبي الآذان، وعُمَر بْن مُحَمَّد بْن بجير البجيري، والقاسم بْن مُوسَى بْن الْحَسَن بْن مُوسَى الأشيب، ومحمد بْن أَحْمَد بْن صَالِح بْن علي الأزدي، ومحمد بْن حامد بْن السري الْبَغْدَادِيّ المعروف بخال ولد السني، ومحمد بْن الحسين بن شهريار، ومحمد ابن الْعَبَّاس بْن أيوب الأصبهاني الأخرم، ومحمد بْن مخلد بْن حَفْص الدوري، ومحمد بْن نوح الجنديسابوري، ويحيى بْن مُحَمَّد بْن صاعد، ويعقوب بْن إِبْرَاهِيم بْن أَحْمَد بْن عيسى الْبَغْدَادِيّ.\rقال عَبد الرَّحْمَنِ بْن أَبي حَاتِم: كَانَ صدوقا (١)\rوَقَال مُحَمَّد بْن مخلد: مات بالعسكر (٢) سنة ثمان وخمسين',
                    id: 443,
                },
                {
                    content: 'ومئتين (١) .',
                    id: 444,
                },
            ].map((p) => ({ content: htmlToMarkdown(p.content), id: p.id }));

            const segments = segmentPages(pages, options);

            testSegment(segments[0], {
                beginsWith: 'بعضهم إحدى',
                endsWith: 'والله أعلم (٢) .',
                from: 442,
            });

            testSegment(segments[1], {
                beginsWith: 'ق: أَحْمَد',
                endsWith: 'عيسى الْبَغْدَادِيّ.',
                from: 442,
                to: 443,
            });

            testSegment(segments[2], {
                beginsWith: 'قال عَبد الرَّحْمَنِ',
                endsWith: 'ومئتين (١) .',
                from: 443,
                to: 444,
            });
        });

        it('should retain the right from page number', () => {
            const pages = [
                {
                    content: 'وَقَال إبراهيم بْن مُحَمَّدِ بْن سفيان النيسابوري: سمعت أبا',
                    id: 2533,
                },
                {
                    content: 'وقَال البُخارِيُّ: قال أحمد: مات سنة ست ومئتين.',
                    id: 2534,
                },
                {
                    content:
                        'روى له الجماعة (١) .\r١١٢٨ ع: حجاج بن المنهال الأنماطي أَبُو مُحَمَّد السلمي (٢) وقيل: البرساني، مولاهم، البَصْرِيّ.\rرَوَى عَن: جرير بْن حازم (خ فق) ، وجويرية بْن أسماء (خ) ، وحماد بْن زيد (خ) ، وحماد بن سلمة (خت ٤) ، وداود بْن أَبي الفرات (س) ، وربيعة بْن كلثوم (س) ، وسفيان بْن عُيَيْنَة (خ) ، وشعبة بْن الحجاج (خ س) ، وعبد الله بْن عُمَر النميري (خ) ، وعبد العزيز بن عَبد اللَّهِ بن أَبي سلمة الماجشون (خ) ،',
                    id: 2535,
                },
            ];

            const segments = segmentPages(pages, {
                breakpoints: [
                    {
                        pattern: '{{tarqim}}\\s*',
                    },
                    '',
                ],
                maxPages: 1,
                rules: [
                    {
                        lineStartsAfter: ['{{raqms:num}} {{harfs}}:'],
                    },
                ],
            });

            expect(segments).toHaveLength(3);

            testSegment(segments[0], {
                beginsWith: 'وَقَال إبراهيم',
                endsWith: 'ومئتين.',
                from: 2533,
                to: 2534,
            });

            testSegment(segments[1], {
                content: 'روى له الجماعة (١) .',
                from: 2535,
            });

            testSegment(segments[2], {
                beginsWith: 'حجاج بن المنهال',
                endsWith: 'سلمة الماجشون (خ) ،',
                from: 2535,
                meta: {
                    num: '١١٢٨',
                },
            });
        });
    });
});
