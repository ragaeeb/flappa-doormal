import { beforeEach, describe, expect, it } from 'bun:test';
import { type Page, type Segment, type SegmentationOptions, segmentPages } from './index';

const htmlToMarkdown = (html: string): string => {
    return (
        html
            // Move content after line break (or at start) but before title span INTO the span
            .replace(/(^|\r)([^\r]*?)<span[^>]*data-type=["']title["'][^>]*>/gi, '$1<span data-type="title">$2')
            // Convert title spans to markdown headers
            .replace(/<span[^>]*data-type=["']title["'][^>]*>(.*?)<\/span>/gi, '## $1')
            // Strip narrator links but keep text
            .replace(/<a[^>]*href=["']inr:\/\/[^"']*["'][^>]*>(.*?)<\/a>/gi, '$1')
            // Strip all remaining HTML tags
            .replace(/<[^>]*>/g, '')
            .replace(/舄/g, '')
    );
};

const mapPageToMarkdown = (p: Page) => ({ content: htmlToMarkdown(p.content), id: p.id });

const testSegment = (
    segment: Segment,
    { beginsWith, endsWith, ...expected }: Partial<Segment> & { beginsWith?: string; endsWith?: string },
) => {
    expect(segment).toMatchObject(expected);

    if (beginsWith) {
        expect(segment.content).toStartWith(beginsWith);
    }

    if (endsWith) {
        expect(segment.content).toEndWith(endsWith);
    }
};

describe('index', () => {
    let options: SegmentationOptions;
    let pages: Page[];

    describe('2576', () => {
        beforeEach(() => {
            pages = [
                {
                    content:
                        '舄<span data-type="title">(هذا نص التقرير) </span>\rالوارد من حضرة صاحب الفضيلة الأستاذ الأكبر الشيخ حسونة النواوي شيخ الجامع الأزهر - حفظه الله',
                    id: 1,
                },
                {
                    content: '舄﷽\rالحمد للَّه  سلطان المسلمين',
                    id: 2,
                },
                {
                    content: '舄وحافظ   لهم دراية بعلم الحديث.',
                    id: 3,
                },
                {
                    content:
                        '舄هذا وقد احتفلنا بيوم ختام هذا الكتاب المستطاب في مركز إدارة الجامع الأزهر الأنور، فحضر في ذلك اليوم المشهود جمع من أكابر العلماء، وتليت الأدعية الصالحة المقبولة بدوام عرش الخلافة العظمى وتأييد مولانا أمير  قَدْ حَوَى التَّـ … ـارِيخَ فِي بَيْتِ الْقَصِيدْ\rطَبَعَ البُخَارِيَّ جَيِّدًا … سُلْطَانُنَا عَبْدُ الحَميدْ\r٨١، ٨٤٤، ١٨، ٢٠١، ١٦٩\r\rسنة ١٣١٣',
                    id: 4,
                },
                {
                    content:
                        '舄<span data-type="title">مقدمة </span>\r﷽\r\rيا من أمر بصنع الجميل، وجزى عليه الجزاء الجزيل، نحمدك على ما هديتنا، ونشكرك على ما أوليتنا، ونصلي ونسلم على نبيك الأكرم، ورسولك السيد السند الأعظم، سيدنا ومولانا  خان، أيد اللَّه',
                    id: 5,
                },
                {
                    content:
                        '舄القسط بهمته، وقوم أود الرعية بعدالته، وأكثر خير البلاد بيمنه، وأنام جميع الأنام في ظل أمنه، وأدامه عزًّا  والبيان تامًّا، إن شاء اللَّه تعالى. وكتبه محمد بن عبد اللَّه بن مالك حامدًا للَّه تعالى. اهـ.\rوكتب الحافظ اليونيني على ظهر آخر ورقة من المجلد  مالك أزمة الأدب، العلامة أبي عبد اللَّه بن مالك الطائي الجياني، أمد اللَّه تعالى عمره، في المجلس الحادي والسبعين، وهو يراعي قراءتي ويلاحظ نطقي، فما اختاره ورجحه وأمر بإصلاحه أصلحته وصححت عليه،',
                    id: 6,
                },
                {
                    content:
                        '舄 (الجزء الأول)\rمن صحيح أبي عبد اللَّه محمد بن إسماعيل بن إبراهيم بن المغيرة ابن بردزبه البخاري الجعفي رضي اللَّه تعالى عنه عند أصحاب الرمز الذي بعدها، وقد يوجد في آخر تلك الجملة التي عليها (لا) لفظ (إلى) إشارة إلى آخر الساقط عند صاحب الرمز.\rومن  سبحانه أعلم.\r\r(طبع)\rبالمطبعة الكبرى الأميرية ببولاق مصر المحمية\rسنة ١٣١١ هجرية',
                    id: 8,
                },
                {
                    content:
                        '﷽\rقَالَ الشَّيْخُ الإِمَامُ الْحَافِظُ أَبُو عَبْدِ اللَّهِ مُحَمَّدُ بْنُ إِسْمَاعِيلَ بْنِ إِبْرَاهِيمَ بْنِ الْمُغِيرَةِ الْبُخَارِىُّ رَحِمَهُ اللَّهُ تَعَالَى، آمِينَ: كَيْفَ كَانَ بَدْءُ الْوَحْيِ إِلَى رَسُولِ اللهِ ﷺ، وَقَوْلُ اللهِ جَلَّ ذِكْرُهُ: ﴿إِنَّا أَوْحَيْنَا إِلَيْكَ كَمَا أَوْحَيْنَا إِلَى نُوحٍ وَالنَّبِيِّينَ مِنْ بَعْدِهِ﴾.\r<span id="link-1"> </span>',
                    id: 9,
                },
                {
                    content:
                        '١ - حَدَّثَنَا <a href="inr://man-3654">الْحُمَيْدِيُّ عَبْدُ اللهِ بْنُ الزُّبَيْرِ </a>،   أَوْ إِلَى امْرَأَةٍ يَنْكِحُهَا، فَهِجْرَتُهُ إِلَى مَا هَاجَرَ إِلَيْهِ».\r <hadeeth>',
                    id: 10,
                },
                {
                    content: "<span data-type='title' id=toc-30>بَابُ عَلَامَةِ الْمُنَافِقِ</span>",
                    id: 66,
                },
                {
                    content:
                        '٣٣ - حَدَّثَنَا <a href="inr://man-2591">سُلَيْمَانُ أَبُو الرَّبِيعِ </a>قَالَ: حَدَّثَنَا <a href="inr://man-650"> وَإِذَا اؤْتُمِنَ خَانَ».\r <hadeeth>',
                    id: 67,
                },
                {
                    content:
                        '٣٤ - حَدَّثَنَا <a href="inr://man-5178">قَبِيصَةُ بْنُ عُقْبَةَ </a>قَالَ: حَدَّثَنَا <a href="inr://man-2472">سُفْيَانُ، </a>عَنِ <a href="inr://man-2638">الْأَعْمَشِ، </a>عَنْ <a href="inr://man-3909">عَبْدِ اللهِ بْنِ مُرَّةَ، </a>عَنْ <a href="inr://man-6088">مَسْرُوقٍ، </a>عَنْ <a href="inr://man-3823">عَبْدِ اللهِ بْنِ عَمْرٍو، </a>أَنَّ النَّبِيَّ ﷺ قَالَ: <hadeeth-32>«أَرْبَعٌ مَنْ كُنَّ فِيهِ كَانَ مُنَافِقًا خَالِصًا، وَمَنْ  شُعْبَةُ، عَنِ الْأَعْمَشِ.\r <hadeeth>',
                    id: 68,
                },
                {
                    content: "<span data-type='title' id=toc-31>بَابٌ: قِيَامُ لَيْلَةِ الْقَدْرِ مِنَ الْإِيمَانِ</span>",
                    id: 69,
                },
                {
                    content:
                        '٣٥ - حَدَّثَنَا <a href="inr://man-1588">أَبُو الْيَمَانِ </a>قَالَ: أَخْبَرَنَا <a href="inr://man-2785">شُعَيْبٌ </a>قَالَ: حَدَّثَنَا <a href="inr://man-3645">أَبُو الزِّنَادِ، </a>عَنِ <a href="inr://man-3424">الْأَعْرَجِ، </a>عَنْ <a href="inr://man-3320">أَبِي هُرَيْرَةَ </a>قَالَ: قَالَ رَسُولُ اللهِ ﷺ: <hadeeth-33>«مَنْ يَقُمْ لَيْلَةَ الْقَدْرِ إِيمَانًا وَاحْتِسَابًا غُفِرَ لَهُ مَا تَقَدَّمَ مِنْ ذَنْبِهِ».\r <hadeeth>',
                    id: 70,
                },
                {
                    content: 'بَابُ قَوْلِ الْمُحَدِّثِ حَدَّثَنَا أَوْ : عَنِ النَّبِيِّ ﷺ يَرْوِيهِ عَنْ رَبِّكُمْ ﷿',
                    id: 115,
                },
                {
                    content:
                        '٧٥٦٣ - حَدَّثَنِي <a href="inr://man-415">أَحْمَدُ بْنُ إِشْكَابٍ، </a>حَدَّثَنَا <a href="inr://man-5879">مُحَمَّدُ بْنُ فُضَيْلٍ، </a>عَنْ <a href="inr://man-4642">عُمَارَةَ بْنِ الْقَعْقَاعِ، </a>عَنْ <a href="inr://man-268">أَبِي زُرْعَةَ، </a>عَنْ <a href="inr://man-3320">أَبِي هُرَيْرَةَ </a>﵁ قَالَ: قَالَ النَّبِيُّ ﷺ: <hadeeth-2283>«كَلِمَتَانِ حَبِيبَتَانِ إِلَى الرَّحْمَنِ، خَفِيفَتَانِ عَلَى اللِّسَانِ، ثَقِيلَتَانِ فِي الْمِيزَانِ: سُبْحَانَ اللهِ وَبِحَمْدِهِ، سُبْحَانَ اللهِ الْعَظِيمِ.» <hadeeth>',
                    id: 11208,
                },
            ];

            options = {
                breakpoints: [{ pattern: '{{tarqim}}\\s*' }, ''],
                maxPages: 1,
                prefer: 'longer',
                rules: [
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{basmalah}}'],
                        split: 'at',
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{bab}}'],
                        meta: { type: 'chapter' },
                        split: 'at',
                    },
                    {
                        lineStartsAfter: ['##'],
                        meta: { type: 'chapter' },
                        split: 'at',
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{kitab}}'],
                        meta: { type: 'book' },
                        split: 'at',
                    },
                    {
                        lineStartsAfter: ['{{raqms:num}} {{dash}}'],
                        split: 'at',
                    },
                ],
            };

            pages = pages.map(mapPageToMarkdown);
        });

        it('should segment the pages', () => {
            const segments = segmentPages(pages, options);

            // With page-ID-based span calculation, pages get split more accurately
            expect(segments).toHaveLength(17);

            testSegment(segments[0], {
                beginsWith: '(هذا نص التقرير)',
                endsWith: 'حفظه الله',
                from: 1,
                meta: {
                    type: 'chapter',
                },
            });

            testSegment(segments[1], {
                beginsWith: '﷽',
                endsWith: 'بعلم الحديث.',
                from: 2,
                to: 3,
            });

            testSegment(segments[2], {
                beginsWith: 'هذا وقد',
                endsWith: 'سنة ١٣١٣',
                from: 4,
            });

            testSegment(segments[3], {
                beginsWith: 'مقدمة',
                from: 5,
                meta: {
                    type: 'chapter',
                },
            });

            testSegment(segments[4], {
                beginsWith: '﷽',
                endsWith: 'تعالى. اهـ.',
                from: 5,
                to: 6,
            });

            testSegment(segments[5], {
                beginsWith: 'وكتب الحافظ',
                from: 6,
            });

            testSegment(segments[6], {
                beginsWith: '(الجزء الأول)',
                from: 8,
            });

            testSegment(segments[7], {
                beginsWith: '(طبع)',
                from: 8,
            });

            testSegment(segments[8], {
                beginsWith: '﷽',
                from: 9,
            });

            testSegment(segments[9], {
                beginsWith: 'حَدَّثَنَا الْحُمَيْدِيُّ عَبْدُ اللهِ بْنُ الزُّبَيْرِ',
                endsWith: 'هَاجَرَ إِلَيْهِ».',
                from: 10,
                meta: {
                    num: '١',
                },
            });

            testSegment(segments[10], {
                content: 'بَابُ عَلَامَةِ الْمُنَافِقِ',
                from: 66,
                meta: {
                    type: 'chapter',
                },
            });

            testSegment(segments[11], {
                beginsWith: 'حَدَّثَنَا سُلَيْمَانُ أَبُو الرَّبِيعِ',
                endsWith: 'اؤْتُمِنَ خَانَ».',
                from: 67,
                meta: {
                    num: '٣٣',
                },
            });

            testSegment(segments[13], {
                content: 'بَابٌ: قِيَامُ لَيْلَةِ الْقَدْرِ مِنَ الْإِيمَانِ',
                from: 69,
                meta: {
                    type: 'chapter',
                },
            });

            testSegment(segments[14], {
                beginsWith: 'حَدَّثَنَا أَبُو الْيَمَانِ قَالَ: أَخْبَرَنَا',
                endsWith: 'ذَنْبِهِ».',
                from: 70,
                meta: {
                    num: '٣٥',
                },
            });

            testSegment(segments[15], {
                beginsWith: 'بَابُ قَوْلِ الْمُحَدِّثِ',
                endsWith: 'عَنْ رَبِّكُمْ ﷿',
                from: 115,
                meta: {
                    type: 'chapter',
                },
            });

            testSegment(segments[16], {
                beginsWith: 'حَدَّثَنِي أَحْمَدُ بْنُ إِشْكَابٍ',
                endsWith: 'الْعَظِيمِ.»',
                from: 11208,
                meta: {
                    num: '٧٥٦٣',
                },
            });
        });
    });

    describe('2588', () => {
        beforeEach(() => {
            pages = [
                {
                    content: 'المغْني\rالرياض',
                    id: 1,
                },
                {
                    content: 'المغْني',
                    id: 2,
                },
                {
                    content:
                        'بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ\r\r<span data-type="title">مقدمة التحقيق</span>\rنص مختصر لمسائله.\rوكان أبو القاسم عمر بن الحسين المتوفى سنة ٣٣٤ هـ،',
                    id: 5,
                },
                {
                    content:
                        'السابق لها حتى يهدى السبيل.\rغرة ربيع الأول ١٤٠٦ هـ\rعبد اللَّه عبد المحسن التركى\rعبد الفتاح محمد الحلو',
                    id: 56,
                },
                {
                    content: 'المغْني\rالجزء الأول',
                    id: 57,
                },
                {
                    content: 'المغْني',
                    id: 58,
                },
                {
                    content:
                        'بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ\r[قال الشيخُ الإِمامُ العالمُ العاملُ شيخُ الإِسلام، قُدْوةُ الأنام، مَجْمُوعُ الفضائل، مُوَفَّقُ الدين أبو محمد عبد اللَّه بن أحمد بن محمد بن قُدامَةَ المَقْدِسِىُّ، قَدَّس اللهُ رُوحَه، وَنوَّر ضَرِيحَهُ: ] (١)\rالحمدُ للَّه بارِئِ الْبَرِيَّات، وغافِر الخَطِيَّات، وعالِمِ الخَفِيَّات، المُطّلِعِ على الضمائِرِ والنِّيَّات، أحاط بكلِّ شَئٍ عِلْما، وَوَسِعَ كُلَّ شَئٍ رحمةً وحِلْما، وَقَهَرَ كُلَّ مخلوقٍ عِزةً وحُكْمًا {يَعْلَمُ مَا بَيْنَ أَيْدِيهِمْ وَمَا خَلْفَهُمْ وَلَا يُحِيطُونَ بِهِ عِلْمًا} (٢)، لا تدركُه الأبصار، ولا تُغيِّره الأعْصار، ولا تَتَوهَّمه الأفكار، {وَكُلُّ شَيْءٍ عِنْدَهُ بِمِقْدَارٍ} (٣)، أتْقَن ما صنَع وأحْكَمه، وأحْصَى كُلَّ شَئٍ وعلمَه، وخلق الإِنسانَ وَعَلَّمَهُ، ورفع قَدْرَ العِلْمِ وعظَّمه، وحظَره على من استرْذَله وحَرَّمَه، وخَصَّ به مِن خَلْقِه مَن كرَّمه، وحَضَّ عبادَه المؤمنين على النَّفِيرِ لِلتَّفَقُّهِ في الدين، فقال  للقيامِ بحُجَّتِه، والنِّيابةِ عنه في الإِخبارِ بشريعتِه، واخْتَصَّهم مِن بينِ عبادِه بخَشْيتِه، فقَال تعالى: {إِنَّمَا يَخْشَى اللَّهَ مِنْ عِبَادِهِ الْعُلَمَاءُ} (٥)، ثم أمَر سائِرَ الناسِ\r',
                    id: 59,
                },
                {
                    content:
                        'إلى هذا الطَّرْفِ.\r\r<span data-type="title" id=toc-167><span data-type="title" id=toc-168><span data-type="title" id=toc-169>فصل: </span></span></span>وإنْ خُلِقَ له إصْبَعٌ زائدةٌ، أو يَدٌ زائِدةٌ في مَحَلِّ الفَرْضِ، وَجَب غَسْلُها مع الأَصْلِيَّةِ؛ لأنها نابِتَةٌ فيه، أشْبَهَت الثُّؤْلُولَ (٨)، وإن كانت نابتةً في غيرِ مَحَلِّ الفَرْضِ كالعَضُدِ أو المَنْكِبِ، لم يجِبْ غَسْلُها، سواء كانت قصيرةً أو طويلةً؛ لأنها في غيرِ مَحَلِّ الفَرْضِ، فأشْبَهت شعرَ الرَّأْسِ إذا نزلَ عن الوَجْهِ، وهذا قَوْلُ ابنِ حَامِد وابنِ عَقِيل. وقال القَاضِى: إن كان بَعْضُها يُحَاذِى مَحَلَّ الفَرْضِ غَسَلَ ما يُحاذِيهِ منها. والأَوَّلُ أصَحُّ. واخْتَلَفَ أَصْحابُ الشَّافِعِىِّ (٩) في ذلك، كنَحْوٍ ممَّا  فوَجَبَ غَسْلُهما، كما لو تَنَجَّسَت إحْدَى يَدَيْه ولم يَعْلَمْ عَيْنَها.\r\rفصل: وإن انْقَلَعَتْ (١٠) جِلْدَةٌ مِنْ غيرِ مَحَلِّ الفَرْضِ، حَتَّى تَدَلَّتْ مِنْ مَحَلِّ الْفَرْضِ، وجَبَ غَسْلُها؛ لأنَّ أصْلَها في مَحَلِّ الفَرْضِ، فأشْبَهَت الإِصْبعَ الزائدةَ، وإن تَقَلَّعت (١١) مِن مَحَلِّ الفَرْضِ حتى صارَتْ مُتَدَلِّيةً مِن غيرِ مَحَلِّ الفَرْضِ، لم يَجبْ غَسْلُها؛ قصيرةً كانت أو طويلةً بلا خِلَافٍ، لأنها في غيرِ مَحَلِّ الفَرْضِ. وإن تَقَلَّعت (١١) مِن أحدِ  وغَسْلُ ما تحتَها مِن مَحَلِّ الفَرْضِ.\r\rفصل: وإن قُطِعَت يَدُه مِنْ دُون المِرْفَقِ، غَسَلَ ما بَقِىَ مِنْ مَحَلِّ الفَرْضِ. وإن قُطِعَت مِن المِرْفَقِ غَسَلَ العَظْمَ الذي هو طَرَفُ العَضُدِ؛ لأنَّ غَسْلَ العَظْمَيْنِ\r',
                    id: 229,
                },
                {
                    content:
                        'بالموتِ، أشْبَهَت المُدَبَّرَةِ، وتُفارِقُ الحُرَّةَ، فإنَّها كامِلَةٌ.\r\r<span data-type="title" id=toc-8780>فصل: </span>ولا يَجِبُ القصاصُ على الحُرَّةِ بقَتْلِها؛ لعدَمِ المُكافَأَةِ. وإِنْ كان القاتِلُ لها رَقِيقًا، وجَبَ القِصاصُ عليه؛ لأنَّها أكْمَلُ منه. وإِنْ جَنَتْ على عبدٍ أو أَمَةٍ، جنايَةً فيها القِصاصُ، لَزِمَها القِصاصُ؛ لأنَّها أَمَةٌ، أحْكامُها أحْكامُ الإِماءِ، واسْتِحْقاقُها العِتْقَ لا يَمْنَعُ القِصاصَ، كالمُدَبَّرَةِ.\r\r<span data-type="title" id=toc-8781>٢٠٢٦ - مسألة؛ قال: (وإِنْ صَلَّتْ مَكْشُوفَةَ الرَّأْسِ، كُرِهَ لَهَا ذلِكَ، وأَجْزأَهَا)</span>\rإنَّما كُرِهَ لها كَشْفُ رَأْسِها فى صلاتِها؛ لأنَّها قدأخَذَتْ شَبَهًا من الحَرائِرِ، لامْتِناعِ بَيْعِها. وقد سُئِلَ أحمدُ، رَضِىَ اللَّهُ عنه، عن أُمِّ الولدِ كيف تُصَلِّى؟ قال: تُغَطِّى رَأْسَها وقَدَمَيْها؛ لأنَّها لا تُباعُ. وكان الحسنُ يُحِبُّ للأَمَةِ إذا [عَهِدَها سَيِّدُها -يعنى وَطِئَها] (١) - أَنْ لا تُصَلِّىَ إِلَّا مُجْتَمِعَةً. وإِنْ صَلَّتْ مكْشُوفَةَ الرَّأْسِ، أَجْزَأَها؛ لأنَّها أمَةٌ، حكمُها حكمُ (٢) الإِماءِ. قال إبراهيمُ: تُصَلِّى أُمُّ الولدِ بغيرِ قِناعِ، وإِنْ كانَتْ  ولأنَّ الأَصْلَ بقاءُ حُكْمِها فى إباحَةِ كشفِ رَأْسِها، ولم يُوجَدْ ما يَنْقُلُ عنه مِن نَصٍّ، ولا ما فى مَعْناه، فيَبْقَى الحكمُ على ما كان عليه.\r\r<span data-type="title" id=toc-8782>٢٠٢٧ - مسألة؛ قال: (وَإِذَا قَتلَتْ أمُّ الْوَلَدِ سَيِّدَهَا، فعَلَيْهَا قِيمَةُ نَفْسِهَا)</span>\rوجملتُه أَنَّ أُمَّ الولدِ إذا قَتَلَتْ سَيِّدَها، عَتَقَتْ؛ لأنَّها لا يُمْكِنُ نَقْلُ المِلْكِ فيها، وقد زالَ مِلْكُ سَيِّدِها بقَتْلِه، فصارَتْ حُرَّةً، كما لو قَتَلَه غيرُها، وعليها قِيمَةُ نَفْسِها، إِنْ لم يجبِ\r',
                    id: 7954,
                },
                {
                    content:
                        'القِصاصُ عليها. وهذا قولُ أبى يوسفَ. وقال الشافِعِىُّ: عليها الدِّيَةُ؛ لأنَّها تَصِيرُ حُرَّةً. وكذلك (١) لَزِمَها مُوجَبُ جِنايَتِها، والواجِبُ على الحُرِّ بقَتلِ الحُرِّ دِيَتُه (٢).',
                    id: 7955,
                },
                {
                    content:
                        '<span data-type="title" id=toc-210>بابُ الاسْتِطابةِ والحَدَثِ</span>\rالاسْتِطابةُ: هي الاسْتِنْجاءُ بالماءِ أو بالأَحْجارِ، يقال: اسْتَطابَ، وأَطَابَ: إذا اسْتَنْجَى؛ سُمِّىَ اسْتِطابةً لأنَّه يُطَيِّبُ جَسَدَه بإزالةِ الخَبَثِ عنه، قال الشاعر، يَهْجُو رَجُلا (٧):\rيارَخَمًا قَاظَ علَى عُرْقُوبِ (٨)\rيُعْجِلُ كَفَّ الْخَارِىءِ الْمُطِيبِ\rوالاسْتِنْجاءُ: اسْتِفْعالٌ مِن (٩) نَجَوْتُ الشَّجرةَ، أي: قَطَعْتُها، فكَأَنَّه قَطَعَ الأَذَى عنه، وقال ابنُ قُتَيْبَة: هو مَأْخوذٌ من النَّجْوَةِ، وهى ما ارْتَفَعَ من الأرض، لأنَّ مَنْ أرادَ قَضاءَ الحاجةِ اسْتَتَرَ بها. والاسْتِجْمارُ: اسْتِفْعالٌ من الجِمَارِ، وهي الحِجارَةُ الصّغَارُ؛ لأنَّه يَسْتَعْمِلُها في اسْتِجْمارهِ.\r\r<span data-type="title" id=toc-211>٣٥ - مسألة؛ قال: (وليس عَلَى مَنْ نامَ أو خَرَجتْ منه رِيحٌ اسْتِنْجاءٌ)</span>\rلا نَعْلمُ في هذا خِلافا. قال أبو عبد اللَّه: ليس في الرِّيحِ اسْتِنْجاءٌ؛ في كتابِ اللهِ، ولا في سُنَّةِ رَسُولهِ، إنَّما عليه الوُضُوءُ، وقد رُوِىَ عن النبيِّ -صلى اللَّه عليه وسلم-[أنَّه قال] (١): "من اسْتَنْجَى مِنْ رِيحٍ فليس مِنَّا". رَوَاه الطَّبَرَانِيُّ في "مُعْجَمِه الصَّغِير (٢) "، وعن زَيْدِ بنِ أَسْلَم في قوله تعالى: {إِذَا قُمْتُمْ إِلَى الصَّلَاةِ فَاغْسِلُوا وُجُوهَكُمْ}. إذَا قُمْتُمْ',
                    id: 7957,
                },
            ];

            options = {
                breakpoints: [{ exclude: [1, 2, 58], pattern: '{{tarqim}}\\s*' }, ''],
                maxPages: 1,
                prefer: 'longer',
                rules: [
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{basmalah}}'],
                        split: 'at',
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{fasl}}'],
                        split: 'at',
                    },
                    {
                        lineStartsAfter: ['## {{raqms:num}} {{dash}}'],
                        meta: { type: 'chapter' },
                        min: 60,
                        split: 'at',
                    },
                    {
                        lineStartsAfter: ['##'],
                        meta: { type: 'chapter' },
                        split: 'at',
                    },
                    {
                        lineStartsAfter: ['{{raqms:num}} {{dash}}'],
                        min: 60,
                        split: 'at',
                    },
                ],
            };

            pages = pages.map(mapPageToMarkdown);
        });

        it('should segment the pages', () => {
            const segments = segmentPages(pages, options);

            expect(segments).toHaveLength(21);

            testSegment(segments[0], {
                beginsWith: 'المغْني',
                endsWith: 'الرياض',
                from: 1,
            });

            testSegment(segments[1], {
                content: 'المغْني',
                from: 2,
            });

            testSegment(segments[2], {
                content: 'بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ',
                from: 5,
            });

            testSegment(segments[3], {
                beginsWith: 'مقدمة التحقيق',
                endsWith: 'لمسائله.',
                from: 5,
                meta: { type: 'chapter' },
            });

            // Remaining page 5 content after tarqim split (no tarqim in this part)
            testSegment(segments[4], {
                beginsWith: 'وكان أبو القاسم',
                endsWith: 'سنة ٣٣٤ هـ،',
                from: 5,
            });

            testSegment(segments[5], {
                beginsWith: 'السابق لها',
                endsWith: 'يهدى السبيل.',
                from: 56,
            });

            // Remaining page 56 content after tarqim split
            testSegment(segments[6], {
                beginsWith: 'غرة ربيع',
                endsWith: 'محمد الحلو',
                from: 56,
            });

            testSegment(segments[7], {
                beginsWith: 'المغْني',
                endsWith: 'الجزء الأول',
                from: 57,
            });

            testSegment(segments[8], {
                content: 'المغْني',
                from: 58,
            });

            testSegment(segments[9], {
                beginsWith: 'بِسْمِ اللَّهِ الرَّحْمَنِ',
                endsWith: 'أمَر سائِرَ الناسِ',
                from: 59,
            });

            testSegment(segments[10], {
                content: 'إلى هذا الطَّرْفِ.',
                from: 229,
            });

            testSegment(segments[11], {
                beginsWith: 'فصل: وإنْ خُلِقَ',
                endsWith: 'عَيْنَها.',
                from: 229,
            });

            testSegment(segments[12], {
                beginsWith: 'فصل: وإن انْقَلَعَتْ',
                endsWith: 'مَحَلِّ الفَرْضِ.',
                from: 229,
            });

            testSegment(segments[13], {
                beginsWith: 'فصل: وإن قُطِعَت',
                endsWith: 'طَرَفُ العَضُدِ؛',
                from: 229,
            });

            testSegment(segments[14], {
                content: 'لأنَّ غَسْلَ العَظْمَيْنِ',
                from: 229,
            });

            testSegment(segments[15], {
                beginsWith: 'بالموتِ',
                endsWith: 'فإنَّها كامِلَةٌ.',
                from: 7954,
            });

            testSegment(segments[16], {
                beginsWith: 'فصل: ولا يَجِبُ',
                endsWith: 'كالمُدَبَّرَةِ.',
                from: 7954,
            });

            testSegment(segments[17], {
                beginsWith: 'مسألة؛ قال: (وإِنْ',
                endsWith: 'ما كان عليه.',
                from: 7954,
            });

            testSegment(segments[18], {
                beginsWith: 'مسألة؛ قال: (وَإِذَا قَتلَتْ',
                endsWith: 'بقَتلِ الحُرِّ دِيَتُه (٢).',
                from: 7954,
                to: 7955,
            });

            testSegment(segments[19], {
                beginsWith: 'بابُ الاسْتِطابةِ',
                endsWith: ' في اسْتِجْمارهِ.',
                from: 7957,
                meta: { type: 'chapter' },
            });

            testSegment(segments[20], {
                beginsWith: 'مسألة؛ قال: (وليس',
                endsWith: 'إذَا قُمْتُمْ',
                from: 7957,
                meta: { type: 'chapter' },
            });
        });
    });

    describe('misc', () => {
        beforeEach(() => {
            options = {
                breakpoints: [
                    {
                        pattern: '{{tarqim}}\\s*',
                    },
                    '',
                ],
                maxPages: 1,
                rules: [
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{basmalah}}'],
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{fasl}}'],
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{bab}}'],
                        meta: {
                            type: 'chapter',
                        },
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{naql}}'],
                    },
                    {
                        lineStartsAfter: ['## {{raqms:num}}\\s*{{dash}}'],
                        meta: {
                            type: 'chapter',
                        },
                    },
                    {
                        lineStartsAfter: [
                            '## ({{raqms:num}})\\s*{{dash}} {{rumuz}}:',
                            '## ({{raqms:num}})\\s*{{dash}}',
                            '## {{raqms:num}} {{rumuz}}:',
                            '## {{rumuz}}:',
                        ],
                        meta: {
                            type: 'chapter',
                        },
                        min: 100,
                    },
                    {
                        lineStartsAfter: ['##\\s*•:?\\s*', '##\\s*-\\s*', '##'],
                        meta: {
                            type: 'chapter',
                        },
                        split: 'at',
                    },
                    {
                        fuzzy: true,
                        lineStartsWith: ['{{kitab}}'],
                        meta: {
                            type: 'book',
                        },
                    },
                    {
                        lineStartsAfter: [
                            '•',
                            '{{harf}}+:\\s*',
                            '{{rumuz}}:\\s*',
                            '({{harf}})\\s*:',
                            '{{raqms:num}} {{rumuz}}:',
                            '{{raqms:num}}\\s*{{dash}}\\s*{{rumuz}}:',
                            '{{raqms:num}}\\s*{{dash}}\\s*{{harf:rumuz}}:',
                            '{{raqms:num}}\\s*{{dash}}',
                            '({{raqms:num}})\\s*{{dash}}',
                            '- {{harf:rumuz}}:',
                            '{{raqms:num}}:',
                            '{{harf}} {{raqm}} {{dash}}',
                        ],
                        min: 100,
                    },
                ],
            };
        });

        it('should segment the text', () => {
            pages = [
                {
                    content:
                        'أربعا وتسعين سنة (١) .\r٢٩- خ سي:<span data-type="title" id=toc-70> أَحْمَد بن حميد الطريثيثي، أَبُو الْحَسَن الكوفي، ختن عُبَيد اللَّهِ بْن مُوسَى، ويعرف بدار أم </span>سَلَمَة (٢) .\rوكان من حفاظ الكوفة.',
                    id: 257,
                },
                {
                    content:
                        '١٠٢-<span data-type="title" id=toc-145> تمييز ولهم شيخ آخر يقَالَ له: أَحْمَد بْن مُحَمَّد بْن يحيى بن نيزك بن صَالِح بن عَبْد الرَّحْمَنِ </span>بن عَمْرو بن مرة الهمداني، أَبُو الْعَبَّاس القومسي النيزكي.',
                    id: 435,
                },
            ];
            pages = pages.map((p) => ({ content: htmlToMarkdown(p.content), id: p.id }));

            const segments = segmentPages(pages, options);

            expect(segments).toHaveLength(3);

            testSegment(segments[0], {
                content: 'أربعا وتسعين سنة (١) .',
                from: 257,
            });

            testSegment(segments[1], {
                beginsWith: 'خ سي: أَحْمَد بن حميد',
                endsWith: 'من حفاظ الكوفة.',
                meta: {
                    num: '٢٩',
                    type: 'chapter',
                },
            });

            testSegment(segments[2], {
                beginsWith: 'تمييز ولهم',
                endsWith: 'القومسي النيزكي.',
                meta: {
                    num: '١٠٢',
                },
            });
        });

        it('should split into 3 segments', () => {
            pages = [
                {
                    content:
                        'بعضهم إحدى هاتين الترجمتين بالأخرى (١) ، والصواب التفريق كما ذكرنا، والله أعلم (٢) .\r١٠٦- ق:<span data-type="title" id=toc-149> أَحْمَد بن مُحَمَّد بن يحيى بن سَعِيد بن فروخ القطان أَبُو سَعِيد البَصْرِيّ، نزيل بغداد، أخو صَالِح </span>بْن مُحَمَّد.\rرَوَى عَن: بهلول بْن المورق، وحجين (٣) بن  وعفان بْن مسلم، وعَمْرو بْن مُحَمَّد العنقزي (ق) ، وعَمْرو بْن النعمان، وقريش بْن أنس، ومحاضر',
                    id: 442,
                },
                {
                    content:
                        'ابن المورع،  (ق) ، ويحيى بْن آدم، ويحيى بْن حَمَّاد، وجده يحيى بْن سَعِيد القطان، ويحيى بْن عُمَر الفراء،  الشَّيْبَانِيّ.\rرَوَى عَنه: ابْن  بْن حَفْص الدوري، ومحمد بْن نوح الجنديسابوري، ويحيى بْن مُحَمَّد بْن صاعد، ويعقوب بْن إِبْرَاهِيم بْن أَحْمَد بْن عيسى الْبَغْدَادِيّ.\rقال عَبد الرَّحْمَنِ بْن أَبي حَاتِم: كَانَ صدوقا (١)\rوَقَال مُحَمَّد بْن مخلد: مات بالعسكر (٢) سنة ثمان وخمسين',
                    id: 443,
                },
                {
                    content: 'ومئتين (١) .',
                    id: 444,
                },
            ].map((p) => ({ content: htmlToMarkdown(p.content), id: p.id }));

            const segments = segmentPages(pages, options);

            testSegment(segments[0], {
                beginsWith: 'بعضهم إحدى',
                endsWith: 'والله أعلم (٢) .',
                from: 442,
            });

            testSegment(segments[1], {
                beginsWith: 'ق: أَحْمَد',
                endsWith: 'عيسى الْبَغْدَادِيّ.',
                from: 442,
                to: 443,
            });

            testSegment(segments[2], {
                beginsWith: 'قال عَبد الرَّحْمَنِ',
                endsWith: 'ومئتين (١) .',
                from: 443,
                to: 444,
            });
        });

        it('should retain the right from page number', () => {
            pages = [
                {
                    content: 'وَقَال إبراهيم بْن مُحَمَّدِ بْن سفيان النيسابوري: سمعت أبا',
                    id: 2533,
                },
                {
                    content: 'وقَال البُخارِيُّ: قال أحمد: مات سنة ست ومئتين.',
                    id: 2534,
                },
                {
                    content:
                        'روى له الجماعة (١) .\r١١٢٨ ع: حجاج بن المنهال الأنماطي أَبُو مُحَمَّد السلمي (٢) وقيل: البرساني، مولاهم، البَصْرِيّ.\rرَوَى عَن: جرير بْن حازم (خ فق) ، وجويرية بْن أسماء (خ) ، وحماد بْن زيد (خ) ، وحماد بن سلمة (خت ٤) ، وداود بْن أَبي  (خ) ، وشعبة بْن الحجاج (خ س) ، وعبد الله بْن عُمَر النميري (خ) ، وعبد العزيز بن عَبد اللَّهِ بن أَبي سلمة الماجشون (خ) ،',
                    id: 2535,
                },
            ];

            const segments = segmentPages(pages, {
                breakpoints: [
                    {
                        pattern: '{{tarqim}}\\s*',
                    },
                    '',
                ],
                maxPages: 1,
                rules: [
                    {
                        lineStartsAfter: ['{{raqms:num}} {{rumuz}}:'],
                    },
                ],
            });

            expect(segments).toHaveLength(3);

            testSegment(segments[0], {
                beginsWith: 'وَقَال إبراهيم',
                endsWith: 'ومئتين.',
                from: 2533,
                to: 2534,
            });

            testSegment(segments[1], {
                content: 'روى له الجماعة (١) .',
                from: 2535,
            });

            testSegment(segments[2], {
                beginsWith: 'حجاج بن المنهال',
                endsWith: 'سلمة الماجشون (خ) ،',
                from: 2535,
                meta: {
                    num: '١١٢٨',
                },
            });
        });

        it('should be able to handle when there is some substrings repeated (الرجال والنساء.)', () => {
            pages = [
                {
                    content:
                        'وأما السنة، فإن الله تعالى وفق لها حفاظا عارفين، وجهابذة عالمين، وصيارفة ناقدين، ينفون عنها تحريف الغالين، وانتحال المبطلين، وتأويل الجاهلين، فتنوعوا في تصنيفها، وتفننوا في تدوينها على أنحاء كثيرة وضروب عديدة، حرصا على حفظها، وخوفا من إضاعتها، وكان من أحسنها تصنيفا، وأجودها تأليفا، وأكثرها صوابا، وأقلها خطأ، وأعمها نفعا، وأعودها فائدة، وأعظمها بركة، وأيسرها مؤونة، وأحسنها قبولا عند الموافق والمخالف وأجلها موقعا عند الخاصة والعامة: صحيح أَبِي عَبد اللَّهِ مُحَمَّد بْن إسماعيل البخاري، ثم صحيح أبي الحسين مسلم بن الحجاج النيسابوري، ثم بعدهما كتاب السنن لابي داود سُلَيْمان بْن الأشعث السجستاني، ثم كتاب الجامع لابي عِيسَى مُحَمَّدُ بْنُ عِيسَى التِّرْمِذِيّ، ثم كتاب السنن لابي عَبْدِ الرَّحْمَنِ أَحْمَدُ بْنُ شُعَيْبِ النَّسَائي، ثم كتاب السنن لأبي عَبد الله مُحَمَّد بْن يزيد المعروف بابن ماجة القزويني وإن لم يبلغ درجتهم.\rولكل واحد من هذه الكتب الستة مزية يعرفها أهل هذا الشأن، فاشتهرت هذه الكتب بين الانام، وانتشرت في بلاد الاسلام، وعظم\rالانتفاع بها، وحرص طلاب العلم على تحصيلها، وصنفت فيها تصانيف، وعلقت عليها تعاليق، بعضها في معرفة ما اشتملت عليه من المتون، وبعضها في معرفة ما احتوت عليه من الأسانيد، وبعضها في مجموع ذلك.\rوكان من جملة ذلك كتاب "الكمال" (١) الذي صنفه الْحَافِظ أَبُو مُحَمَّد عبد الغني بْنِ عَبْدِ الْوَاحِدِ بْنِ عَلِيِّ بن سرور المقدسي رحمة الله عليه في معرفة أحوال الرواة الذين اشتملت عليهم هذه الكتب الستة. وهو كتاب نفيس، كثير الفائدة، لكن لم يصرف مصنفه رحمه الله عنايته إليه حق صرفها، ولا استقصى الأَسماء التي اشتملت',
                    id: 107,
                },
                {
                    content:
                        'عليها هذه الكتب استقصاء تاما، ولا تتبع جميع تراجم الأَسماء التي ذكرها في كتابه تتبعا شافيا، فحصل في كتابه بسبب ذلك إغفال وإخلال.\rثم إن بعض ولده ممن لم يبلغ في العلم مبلغه، ولا نال في الحفظ درجته رام تهذيب كتابه وترتيبه واختصاره واستدراك بعض ما فاته من الأَسماء، فكتب عدة أسماء من أسماء الصحابة الذين أغفلهم والده من تراجم كتاب "الاطراف" (١) الذي صنفه الْحَافِظ أَبُو الْقَاسِم علي بْن الحسن بن هبة الله الدمشقي المعروف بابن عساكر رحمه الله وأسماء يسيرة من أسماء التابعين من كتاب "الاطراف" أيضا. وكتب عدة أسماء ممن أغفلهم والده من كتاب"المشايخ النبل"الذي صنفه الْحَافِظ أَبُو الْقَاسِمِ ابن عساكر أيضا.\rولم يزد في عامة ذلك على ما ذكره الحافظ أبو القاسم شيئا. فوقعت عامة تلك الأَسماء المستدركة في الكتاب مختصرة منتفة، ولا يحصل بذكرها كذلك كبير فائدة. ووقع في بعض ما اختصره بلفظه من كتاب والده خلل كبير، ووهم شنيع.\rفلما وقفت على ذلك، أردت تهذيب الكتاب وإصلاح ما وقع فيه من الوهم والاغفال، واستدراك ما حصل فيه من النقص والاخلال، فتتبعت الأَسماء التي حصل إغفالها منهما جميعا، فإذا هي أسماء كثيرة تزيد على مئات عديدة من أسماء الرجال والنساء. ثم وقفت على عدة مصنفات لهؤلاء الأئمة الستة غير هذه الكتب الستة وستأتي أسماؤها قريبا إن شاء اللَّه تعالى فإذا هي تشتمل على أسماء كثيرة ليس لها ذكر في الكتب الستة، ولا في شيء منها، فتتبعتها تتبعا تاما، وأضفتها إلى ما قبلها، فكان مجموع ذلك زيادة على ألف وسبع مئة اسم من الرجال والنساء. فترددت بين كتابتها مفردة عن كتاب الاصل، وجعلها كتابا مستقلا',
                    id: 108,
                },
                {
                    content:
                        'بنفسه، وبين إضافتها إلى كتاب الاصل، ونظمها في سلكه، فوقعت الخيرة على إضافتها إلى كتاب الاصل، ونظمها في سلكه، وتمييزها بعلامة تفوزها عنه، وهو أن أكتب الاسم، واسم الاب أو ما يجري مجراه بالحمرة وأقتصر في الاصل على كتابة الاسم خاصة بالحمرة.\rوجعلت لكل مصنف علامة (١) ، فإن تكرر الاسم في أكثر من مصنف واحد اقتصرت على عزوه إلى بعضها في الغالب.\rفعلامة ما اتفق عليه الجماعة الستة في الكتب الستة: (ع)\rوعلامة ما اتفق عليه أصحاب السنن الأربعة في سننهم الأربعة: (٤) .\rوعلامة ما أخرجه البخاري في الصحيح: (خ) ، وعلامة ما استشهد به في الصحيح تعليقا: (خت) .\rوعلامة ما أخرجه فِي كتاب القراءة خلف الإمام: (ز) .\rوعلامة ما أخرجه في كتاب رفع الدين في الصلاة: (ي) . وعلامة ما أخرجه في كتاب الادب: (بخ) . وعلامة ما أخرجه في كتاب أفعال العباد: (عخ) (٢) .\rوعلامة ما أخرجه مسلم في الصحيح: (م) ، وعلامة ما أخرجه في مقدمة كتابه: (مق) (٣) .\rوعلامة ما أخرجه أبو داود في كتاب السنن: (د) ، وعلامة ما أخرجه في كتاب المراسيل: (مد) . وعلامة ما أخرجه في كتاب الرد عَلَى أهل القدر: (قد) . وعلامة ما أخرجه في كتاب الناسخ والمنسوخ: (خد) .',
                    id: 109,
                },
            ];

            const segments = segmentPages(pages, options);

            if (process.env.FLAPPA_DEBUG) {
                console.log('\n\n=== SEGMENTS DEBUG ===');
                console.log('Total segments:', segments.length);
                for (let i = 0; i < segments.length; i++) {
                    console.log(`\n--- Segment ${i} ---`);
                    console.log('from:', segments[i].from, 'to:', segments[i].to);
                    console.log('content length:', segments[i].content.length);
                    console.log('starts:', segments[i].content.slice(0, 50));
                    console.log('ends:', segments[i].content.slice(-50));
                }
                console.log('\n=== END SEGMENTS DEBUG ===\n');
            }

            expect(segments).toHaveLength(2);

            testSegment(segments[0], {
                beginsWith: 'وأما السنة',
                endsWith: ' الرجال والنساء.',
                from: 107,
                to: 108,
            });

            testSegment(segments[1], {
                beginsWith: 'فترددت بين كتابتها',
                endsWith: 'الناسخ والمنسوخ: (خد) .',
                from: 108,
                to: 109,
            });
        });
    });
});
