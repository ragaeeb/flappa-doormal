import { describe, expect, it } from 'bun:test';
import { segmentPages, validateSegments } from './index';

describe('bug', () => {
    it('should not merge the pages due to prioritizing newline characters over other whitespace', async () => {
        const pages = [
            {
                body: 'سؤال في الوصيَّة : رجل أوصى وهو في حياته بثلث الميراث لزوجته  أخذوا شققًا في المنزل ؛ ولذا قرَّر وصيته ؛ هل يجوز ذلك تأمين لأولاده الصغار أم لا ؟ وجزاكم  موصٍ بخلاف وصية النبي - صلى الله عليه آله وسلم - فهي  في السؤال المذكور .\nونسأل الله - عز وجل - أن يهيِّئنا لأن نسلِّمَ أنفسنا لأحكام شريعتنا لا نفرِّق بين ما كان منها في الكتاب أو ما جاء في السنة الصحيحة .\nنعم .',
                page: 141837,
            },
            {
                body: 'امرأة تسأل عن والدها المُتوفى الذي في ذمَّته رقبتين ، مات في حادث سيارة ولم يحرِّر رقبة أو يصم شهرين متتابعين لجهلهم في هذا الأمر ؛ مع العلم أنه دفع ديتهم ، فهل لي أن أصوم شهرين عن كلِّ نفس ؟ وهل يمكن أن أتقاسمها مع أقاربي ؟ وهل يمكن إطعام ستين مسكين عن كل نفس ؟\nالسائل : فضيلة الشيخ ، السلام عليكم ورحمة الله وبركاته ، وحياكم الله ، أما بعد :\nامرأة تسأل عن والدها المُتوفى الذي في ذمَّته رقبتين ، مات في حادث سيارة ولم يحرِّر رقبة أو يصم شهرين متتابعين لجهلهم في هذا الأمر ؛ مع العلم أنه دفع ديتهم ، فهل لي أن أصوم شهرين عن كلِّ نفس ؟ وهل يمكن أن أتقاسمها مع  - تعالى - .',
                page: 141838,
            },
        ].map((p) => ({ content: p.body, id: p.page }));

        const segments = segmentPages(pages, {
            breakpoints: [''],
            maxPages: 0,
        } as any);

        expect(segments).toHaveLength(2);
        expect(segments[0].content).toEndWith('نعم .');
        expect(segments[1].content).toStartWith('امرأة تسأل عن والدها');
        expect(segments[1].content).toEndWith('تعالى - .');
    });

    it('should keep per-page boundaries when split starts mid-page', async () => {
        const pages = [
            {
                content: `noise
START second
filler
START second
${'a'.repeat(200)}`,
                id: 1,
            },
            {
                content: `page2 ${'b'.repeat(200)}`,
                id: 2,
            },
            {
                content: `page3 ${'c'.repeat(200)}`,
                id: 3,
            },
        ];

        const options = {
            breakpoints: [''],
            maxPages: 0,
            rules: [
                {
                    lineStartsWith: ['START second'],
                },
            ],
        } as any;

        const segments = segmentPages(pages, options);
        const validation = validateSegments(pages, options, segments);

        expect(validation.ok).toBe(true);
        expect(segments.some((s) => s.from === 2)).toBe(true);
        expect(segments.some((s) => s.from === 3)).toBe(true);
    });

    it('should not merge the pages', async () => {
        const pages = [
            {
                content:
                    'هل الجمع في الحضر كالجمع في السفر ، من حيث إنه لا يفصل بين الفريضتين بوترٍ ولا سنَّة ؟\nالسائل : يقول : هل الجمع في الحضر كالجمع في السفر ، من حيث أنه لا يفصل بين الفريضتين بوترٍ ولا سنَّة ؟\nالشيخ : إذا كان المقصود بالفصل هو اتِّباع السنة فالأمر حينَ ذاك يأخذ خيرًا ، أما إذا كان المقصود أنه لا يجوز الفصل بين المجموعتين بالسفر فهذا ليس عليه دليل ، وإذا كان الأمر كذلك فالحكم هو هو في الجمع في الإقامة ، أما إذا قصدنا بالسنة ما هو الأولى ففي السفر الأَولى قرنُ المجموعتين إحداهما بالأخرى ، وأما في الحضر فقد ذكرتها أكثر من مرَّة جوابًا عن مثل هذا السؤال بأنَّ الجمع في السفر ليس رخصةً مطلقةً ، وإنما هو أمر جائز بقيد دفع الحرج ، فإذا كان دفع الحرج يستلزم الفصل فهذا هو الأقرب إلى هذا الحكم ؛ ألا وهو الترخيص في الجمع في الإقامة من أجل دفع الحرج ، أما إذا كان الحرج يمتثل بالجمع بينهما مباشرةً هذا هو المطلوب ، فإذًا الفصل والوصل بين الصَّلاتين في السفر - عفوًا في الإقامة - يعود إلى ملاحظة رفع الحرج ؛ فبأيٍّ من الوصل أو الفصل رُفع الحرج فهو المشروع ، أما في السفر فالمعروف عن الرسول - عليه السلام - أنه كان يجمع بينهما مباشرةً ، فيكون ذلك أفضل ، ولكن لا يعني أنه انفصل لحاجة عَرَضَت له ؛ لأنه لا يجوز له ذلك ، الجواب قد يجوز .\nهذا ما عندي والله أعلم ',
                id: 142193,
            },
            {
                content:
                    'أثر ابن عباس - رضي الله عنه - : " جمعَ رسولُ الله - صلى الله عليه وسلم - بين الظُّهر والعصر ، والمغرب والعشاء من غير خوف ولا مطر " .\nالسائل : طيب ؛ حديث : كان يجمع من غير مطر ولا سفر أو ولا خوف ؛ حديث ابن عباس .\nالشيخ : هذا تمامه كما قلت آنفًا قيل له : يا أبا العباس ، ماذا أراد بذلك ؟ قال : أراد ألَّا يحرج أمَّته .\nالسائل : الجمع لأجل المطر هل يشرع - أيضًا - بين الظهر والعصر ؟\nالشيخ : ... .\nالسائل : الوارد في ... في الليل ، بعض العلماء يخصُّه فقط في الليل لصعوبة ذهابه إلى المسجد أو ... في النهار .\nالشيخ : التخصيص - بارك الله فيك - ليس بنصٍّ من النبي - صلى الله عليه وآله وسلم - ، وإنما هو مراعاة لما قد وقع ، وما قد وقع لا ينفي شرعية مثله إذا قد وقع ، فليس هناك ما يمنع إذا كانت العلة هي علة نزول المطر ، وأنتم تعلم - إن شاء الله - أن هناك حكمًا آخر يتعلق بإسقاط فرض من الفرائض لمجرَّد نزول المطر ؛ ألا وهو قول النبي - صلى الله عليه وآله وسلم - في يوم مطير أن يقول بعد حيَّ على الصلاة أو حي على الفلاح ، أو بديلهما : ( الصلاة في الرِّحال ، الصلاة في الرِّحال ) ، ومعنى ذلك أنه - عليه الصلاة والسلام - رخَّصَ لِمَن كان في رحله في داره في بيته والأمطار تهطل أن لا يذهبَ إلى المسجد ؛ علمًا بأن الذهاب إلى المسجد فرض ، في الصلاة مع جماعة المسلمين ف',
                id: 142194,
            },
            {
                content:
                    'الأحاديث التي سكتَّ عنها في " فقه السيرة " و " تمام المنة " ما هو موقفك منها ؟ وكذلك المسائل الفقهية ؟\nالسائل : يقول السائل : الأحاديث التي سكتَّ عنها في " فقه السيرة " ، " تمام المنة " ما هو موقفك منها ؟\nالشيخ : أما في " تمام المنة " فالقاعدة : إلا ما سهوت عنه هو أنه يكون حديثًا مقبولًا ، إلا ما سهوت عنه ، أما في " فقه السيرة " فلأنَّه لم يتيسَّر لي الوصول إلى أصولها .\nالسائل : هنا يقول : والمسائل ؟\nالشيخ : نعم ؟\nالسائل : المسائل .\nالشيخ : المسائل ؟\nالسائل : المسائل في " تمام المنة " .\nالشيخ : أنو مسائل ؟\nالسائل : المسائل الفقهية .\nسائل آخر : الأحكام .\nالسائل : الأحكام اللي ما ... .\nالشيخ : المسائل في " التمام " ؟ هو نفس الجواب .\nالسائل : نفس الجواب .\nالشيخ : إي نعم .',
                id: 142195,
            },
            {
                content:
                    'متى يكون دعاء الاستخارة ؟ هل هو قبل السلام أم بعده أم في السجود ؟\nالسائل : هنا يقول : متى يكون دعاء الاستخارة ؟ هل هو قبل السلام أو بعده أو في السجود ؟\nالشيخ : لا ، الذي أراه أنه بعد الصلاة في قوله - عليه الصلاة والسلام - حديث جابر كما في " صحيح البخاري " : كان رسول الله - صلى الله عليه وآله وسلم - يعلِّمنا الاستخارة في الأمور كلها كما يعلِّمنا السورة من القرآن ، يقول : ( إذا همَّ أحدكم بالأمر فليصلِّ لله ركعتين من غير الفريضة ، ثم يقول ) - هنا الشاهد - ( ثم لِيقُلْ : اللهم إنِّي أستخيرك بعلمك ، وأستقدرك بقدرتك ) إلى آخر الدعاء المعلوم والمحفوظ - إن شاء الله - ، وقوله - صلى الله عليه وآله وسلم - : ( فليصلِّ ركعتين ثم ليقُلْ ) فهذا ظاهر ، إن لم نقل نصٌّ على أن الدعاء يكون بعد الصلاة .\nنعم .',
                id: 142196,
            },
            {
                content:
                    'فيما يتعلق بسجود السهو ؛ هل يكون لأجلِ سهوٍ عن الفعل والقول معًا أم أنَّه مختص بالأفعال ؟\nالسائل : هنا يقول : فيما يتعلَّق بسجود السهو ؛ هل يكون بالفعل والقول معًا أم أنه مختصٌّ بالأفعال ؟\nالشيخ : ما فهمت السؤال ، ما المقصود بالقول والفعل معًا ؟\nالسائل : إذا ترك قولًا في لفظ التشهد هل يسقط السهو ؟\nالشيخ : ... .\nالسائل : ... .\nالشيخ : هَيْ فرق .',
                id: 142197,
            },
            {
                content:
                    'ما تقولون في البيت الشعري : " دَعِ الأيام تفعل ما تشاءُ *** وطِبْ نفسًا إذا حكم القضاءُ " من حيث العقيدة ؟\nالسائل : هنا يقول - أيضًا - : ما تقولون في هذا البيت من حيث العقيدة :\n" دَعِ الأيام تفعل ما تشاءُ *** وطِبْ نفسًا إذا حَكَمَ القضاءُ " ؟\nالشيخ : هذا من يقول بالمجاز وكان مؤمنًا ، فيُستساغ منه على التأويل ، كقولهم : " أنبَتَ البقلُ الربيعَ " ، فمَن كان يُساء الظَّنُّ به فلا يتكلم به ، ومن كان في جوٍّ موحِّدٍ يعلمون أن المؤمن إنما ينسبُ كلَّ تصرف في الكون إلى الله ، ولكن ذلك لا يمنع من نسبة الشيء إلى السبب الذي جعله الله - عز وجل - سببًا ؛ كمن يقول : أشبَعَني هذا الخبز ، وأرواني هذا الماء ، فليس في هذا شيء ، ولكن ينبغي أن يُلاحظ المكان الذي يُقال فيه مثل هذا الكلام ، فإذا كان يُساء فهمه فلا ينبغي أن يُنطق به ، ويكفي في هذا قوله - عليه الصلاة والسلام - : ( إيَّاك وما يُعتذَرُ منه ) ؛ أي : إذا تكلَّمت بمثل هذا الكلام الذي يحتاج إلى شيء من التأويل بين ناسٍ لا يفهمون عليك ما تقول يأتي قولُ الرسول المذكور : ( إيَّاك وما يُعتَذَرُ منه ) ، أما إذا كان يعيش بين أناس من العرب لا يزالون على التوحيد ، وعلى الفهم لأصل لغتهم ؛ فما أحد يشك بأن هذه العبارة من باب المجاز المُستعمل في اللغة وليس في الكتاب أو السنة على ما هو مشروح في كتب ابن تيمية',
                id: 142198,
            },
            {
                content:
                    'المصالح والمفاسد لمن أُقيمت عليه الصلاة صلاة الغائب ، وكان الرجل ... في المسجد مع المصلين ، ونزل للصلاة على الغائب ؛ فهل يُصلِّي معهم إذا كان يخشى أن يترتَّب هذا الشرط مفسدة أو أنه يترك ذلك ؟ ونظائر هذا من المسائل ؟\nالسائل : مسألة - يا شيخ - المصالح والمفاسد لمن أُقيمت عليه الصلاة صلاة الغائب ، وكان الرجل ... في المسجد مع المصلين ، ونزل للصلاة على الغائب ؛ فهل يُصلِّي معهم إذا كان يخشى أن يترتَّب هذا الشرط مفسدة أو أنه يترك ذلك ؟ ونظائر هذا من المسائل ؟\nالشيخ : هذه المسألة تختلف باختلاف نظرة المُبتلى إلى هذا الواقع ، فكثيرًا ما يختلف تقدير الأمر من شخصٍ إلى آخر ، وكثيرًا ما يختلف الأمر في إمكانية قلب هذه المفسدة إلى مصلحة ، فإذا كان هناك رجل من أهل العلم والفضل ، وله منزلة في ذاك المجتمع الذي أُقيمت فيه مفسدة ؛ وهي في السؤال المذكور صلاة الغائب التي لا تُشرع في هذه الأيام ؛ لأنها لم تقع من النبي - صلى الله عليه وآله وسلم - مطلقًا إلا مرَّة واحدة حينما صلى على النجاشي ؛ حيث لم يكن هناك مَن يقيم هذه الفريضة عليه ، فإذا حضر رجل فاضل مجتمعًا أُقيمت صلاة الغائب هذه التي لا تُشرع ، وهو باستطاعته أن يلقي كلمة ، ويبيِّن أن هذا خلاف السنة ، وأن هذا البيان سيطرد الشيطان ، وسيكون بيانه للناس ينتفعون به فيما يأتي من الزمان ؛ فهذا له شأن ، ومن ل',
                id: 142199,
            },
        ];

        const segments = segmentPages(pages, {
            //logger: console,
            maxContentLength: 2000,
            maxPages: 0,
            rules: [
                {
                    lineStartsWith: ['هذا'],
                },
            ],
        } as any);

        expect(segments.find((s) => s.from === 142198)!.content).toEndWith('ابن تيمية');
    });

    // Reproduces bug where FastPath logic in buildBoundaryPositions causes incorrect
    // boundary calculations when a large segment starts mid-page (offset drift).
    it('repro_1000_pages_drift', () => {
        const pages: any[] = [];
        // Page 1 has content that will be split mid-page
        pages.push({ content: 'Header\nContent', id: 1 });
        // Add enough pages to trigger FAST_PATH_THRESHOLD (1000)
        for (let i = 2; i <= 1005; i++) {
            pages.push({ content: `Page${i}`, id: i });
        }

        const options: any = {
            maxPages: 0,
            rules: [{ lineStartsWith: ['Content'] }],
        };
        const segments = segmentPages(pages, options);

        // Debug assertions to confirm we have the setup we expect
        // Segment 0: "Header" (from Page 1, trimmed)
        // Segment 1 onwards should be single pages.
        // The problematic one is the "Content" part of Page 1, which starts a large chain.
        // If FastPath is used, it might attribute subsequent pages incorrectly.

        const report = validateSegments(pages, options, segments);
        const violations = report.issues.filter((i) => i.type === 'max_pages_violation');

        if (violations.length > 0) {
            console.log('Violations found:', violations.slice(0, 3));
        }
        expect(violations).toHaveLength(0);
    });
});
