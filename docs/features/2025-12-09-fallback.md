# Fallback Segmentation for No-Match Scenarios

## Problem Description

When a rule with `maxSpan=1` (per-page occurrence filtering) finds no matches within a page, the segmenter currently doesn't create any split points for that page. This causes the content to be merged with subsequent pages until a match is found.

**Example from test 2588:**
- Pages 1 and 2 have no punctuation marks (tarqim rule doesn't match)
- The tarqim rule has `maxSpan=1` (per-page filtering)
- Expected: Each page should be its own segment when no rule matches
- Actual: Pages 1 and 2 are merged into one segment: `"المغْني\n...\nالرياض المغْني"`

## User's Expected Behavior

When a rule with `maxSpan` finds no matches within a span:
1. Move on to check other rules for that content
2. If no rules match, use a **fallback** that creates segments at page boundaries

The user suggested that clients could explicitly add a rule for this behavior.

## Design Options

### Option A: Explicit Page Break Rule (Recommended)
Add a new optional `fallback: 'page'` property to split rules that creates page-boundary splits when no match is found within maxSpan.

```typescript
{
    maxSpan: 1,
    occurrence: 'last',
    split: 'after',
    template: '{{tarqim}}\\s*',
    fallback: 'page',  // NEW: if no match, create split at page boundary
}
```

**Pros:**
- Explicit client control
- Doesn't change default behavior (backward compatible)
- Clear intent in rule definition

**Cons:**
- Requires clients to add the property

### Option B: Global Fallback Option
Add a global `fallbackToPageBoundaries: boolean` option to [SegmentationOptions](../src/segmentation/types.ts#313-323).

```typescript
segmentPages(pages, {
    rules: [...],
    fallbackToPageBoundaries: true,  // NEW: if no rules match, segment by page
});
```

**Pros:**
- Single option for the entire segmentation
- Easier to enable globally

**Cons:**
- Less granular control

> [!IMPORTANT]
> **Decision Point**: Which option do you prefer?
> - **Option A** (per-rule `fallback` property) 
> - **Option B** (global `fallbackToPageBoundaries` option)

## Proposed Changes (Assuming Option A)

### [MODIFY] [segmenter.ts](../src/segmentation/segmenter.ts)

1. After processing all rules in [segmentPages()](../src/segmentation/segmenter.ts#406-502), identify pages/spans with no split points
2. For rules with `fallback: 'page'`, add split points at page boundaries for spans with no matches

### [MODIFY] [types.ts](../src/segmentation/types.ts)

Add the `fallback` property to [SplitRule](../src/segmentation/types.ts#266-267):

```typescript
interface SplitRule {
    // ... existing properties
    
    /**
     * Fallback behavior when no matches are found within a maxSpan boundary.
     * - 'page': Create split points at page boundaries
     * - undefined: No fallback (current behavior)
     */
    fallback?: 'page';
}
```

## Verification Plan

### Automated Tests

1. **Run existing tests** to ensure no regressions:
   ```bash
   bun test src/segmentation/segmenter.test.ts
   ```

2. **Run the 2588 integration test** to verify the fix:
   ```bash
   bun test src/index.test.ts --test-name-pattern "2588"
   ```

3. **Add a new unit test** in [segmenter.test.ts](../src/segmentation/segmenter.test.ts) for fallback behavior:
   - Test that `fallback: 'page'` creates page-boundary splits when no matches found
   - Test that without `fallback`, the original behavior is preserved

### Manual Verification
None required - automated tests cover the scenarios.

# Fallback Segmentation Feature - Walkthrough

## Summary

Implemented `fallback: 'page'` option for split rules to create page-boundary segments when no pattern matches are found within a `maxSpan` boundary.

## Changes Made

### [types.ts](../src/segmentation/types.ts#L185-L207)
Added `fallback?: 'page'` property to [SplitBehavior](../src/segmentation/types.ts#136-186) type.

### [segmenter.ts](../src/segmentation/segmenter.ts#L487-L520)  
Added fallback logic after main rule processing loop to create page-boundary splits for pages with no matches.

### [segmenter.test.ts](../src/segmentation/segmenter.test.ts#L560-L647)
Added 4 unit tests:
- `should create page-boundary splits when fallback is page and no matches found`
- `should merge pages when fallback is omitted and no matches found`
- `should mix matched and fallback pages correctly`
- `should respect min/max constraints with fallback`

### [index.test.ts](../src/index.test.ts#L207)
Updated 2588 test with `fallback: 'page'` on the tarqim rule.

### [README.md](../README.md#L280-L300)
Added documentation for fallback feature and future extension considerations.

## Test Results

✅ **162 tests pass** across 6 files

## Usage Example

```typescript
{
    template: '{{tarqim}}',
    split: 'after',
    maxSpan: 1,
    occurrence: 'last',
    fallback: 'page'  // NEW
}
```
