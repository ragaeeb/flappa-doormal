# AI Agent Handoff Document
## Date: 2025-12-09

---

## ğŸš€ Quick Start for Incoming Agent

**Immediate Priority**: Fix 2 failing integration tests in `src/index.test.ts`

```bash
# Check current test status
bun test  # Should show 163 pass, 2 fail

# The failing tests are for books 2576 and 2588
bun test src/index.test.ts
```

**The Issue**: Tests use `maxPages: 1` with `breakpoints: ['{{tarqim}}\\s*', '']`. Page 1 content has `(Ù¥Ù¤Ù¡ - Ù¦Ù¢Ù  Ù‡Ù€)` which contains `)` (a tarqim punctuation), causing mid-page splits.

**Recommended Fix**: Either:
1. Increase `maxPages` to 2+
2. Modify test expectations
3. Exclude parentheses from tarqim pattern

---

## Table of Contents

1. [Project Overview](#project-overview)
2. [Historical Context: The Old maxSpan System](#historical-context-the-old-maxspan-system)
3. [What Was Accomplished This Session](#what-was-accomplished-this-session)
4. [Current State / What Remains](#current-state--what-remains)
5. [File Locations](#file-locations)
6. [Key Design Decisions](#key-design-decisions)
7. [Test Commands](#test-commands)
8. [Important Code Snippets](#important-code-snippets)
9. [Token Reference](#token-reference)
10. [Debugging Tips](#debugging-tips)
11. [Summary of Test Status](#summary-of-test-status)
12. [Next Steps for Incoming Agent](#next-steps-for-incoming-agent)

---

## Project Overview

**Repository**: `flappa-doormal` - A TypeScript/JavaScript library for segmenting paginated content (books, manuscripts) based on configurable rules and patterns.

**Core Purpose**: Takes an array of pages (with `content` and `id`) and segments them into logical units based on structural markers like chapter headings, basmalah, numbered hadiths, etc.

**Primary Use Case**: Processing Arabic Islamic texts (Quran, Hadith collections, Fiqh books) where content needs to be segmented by:
- Basmalah (Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù)
- Chapter markers (Ø¨Ø§Ø¨ØŒ ÙØµÙ„ØŒ ÙƒØªØ§Ø¨)
- Hadith numbers (numbered patterns like Ù§Ù¥Ù¦Ù£ -)
- Structural HTML markers (title spans converted to `##` headers)

**Technology Stack**:
- TypeScript
- Bun runtime and test runner
- No external dependencies for core functionality

---

## Historical Context: The Old `maxSpan` System

Before this session, the library used a `maxSpan` property on individual `SplitRule` objects:

```typescript
// OLD APPROACH (now deprecated/removed)
rules: [
    {
        template: '{{tarqim}}\\s*',
        occurrence: 'last',
        split: 'after',
        maxSpan: 1,           // â† This forced per-page splitting
        fallback: 'page'       // â† Fall back to page boundary if no match
    }
]
```

**Problems with this approach**:
1. The tarqim rule was treated as a structural rule, running with all other rules
2. It would find punctuation within chapter titles and split prematurely
3. Example: "ÙØµÙ„: Topic." would split at the period, creating a tiny "." segment
4. The `maxSpan` logic was embedded in the rule processing, making it complex

---

## What Was Accomplished This Session

### 1. Implemented New `breakpoints` Segmentation Feature

**Problem Being Solved**: The old `maxSpan` functionality (on `SplitRule`) caused premature cuts within titles when combined with the `tarqim` (punctuation) rule. For example, a chapter title containing a period would get cut in half.

**Solution Implemented**: A post-processing approach where:
1. Structural rules run first (basmalah, chapter markers, etc.)
2. `breakpoints` then addresses segments exceeding `maxPages`
3. Breakpoints patterns are tried in order until one matches

### 2. New API Design Added to `SegmentationOptions`

```typescript
interface SegmentationOptions {
  rules: SplitRule[];
  maxPages?: number;           // Maximum pages a segment can span
  breakpoints?: string[];      // Ordered array of regex patterns (supports token expansion)
  prefer?: 'longer' | 'shorter'; // Select last or first match within window
}
```

**Token Support**: Breakpoints patterns support token expansion like `{{tarqim}}`, `{{basmalah}}`, etc.

**Empty String Fallback**: Including `""` in breakpoints array means "fall back to page boundary" if no pattern matches.

### 3. Key Implementation Details

**File**: `src/segmentation/segmenter.ts`

**New Function**: `applyBreakpoints()` (lines ~432-576)

#### Algorithm Pseudocode:
```
function applyBreakpoints(segments, pages, breakpoints, maxPages, prefer):
    result = []
    
    for each segment in segments:
        pageSpan = count pages in segment
        
        if pageSpan <= maxPages:
            result.push(segment)  // Within limit, keep as-is
            continue
        
        // Segment is oversized, need to split
        combinedContent = segment.content
        
        // Calculate approximate window (where maxPages worth of content ends)
        avgCharsPerPage = total chars / total pages
        approxWindowEnd = avgCharsPerPage * maxPages * 1.5  // 50% padding
        windowContent = combinedContent.substring(0, approxWindowEnd)
        
        // Try each breakpoint pattern in order
        for each pattern in breakpoints:
            if pattern is empty string:
                // Fall back to page boundary
                splitAtPageBoundary()
                break
            
            regex = expandTokens(pattern)
            matches = findAllMatches(windowContent, regex)
            
            if matches.length > 0:
                if prefer == 'longer':
                    splitPos = lastMatch.endPosition
                else:
                    splitPos = firstMatch.endPosition
                
                // Create two segments from split
                firstPart = content up to splitPos
                secondPart = content after splitPos
                
                // Recursively process if still oversized
                result.push(firstPart)
                result.push(...applyBreakpoints([secondPart], ...))
                break
    
    return result
```

**Key Insight**: The 50% padding (line ~515-523 in actual code) was increased from 20% during debugging to ensure the window captures enough content for `prefer: 'longer'` scenarios.

**Integration**: Called at the end of `segmentPages()` function:
```typescript
if (maxPages && breakpoints) {
    segments = applyBreakpoints(segments, pages, breakpoints, maxPages, prefer || 'longer');
}
```

### 4. Escaping Issues Fixed

During test development, we encountered and fixed several escaping issues:

1. **Quadruple backslashes**: When inserting tests via tools, strings like `'\\.\\s*'` became `'\\\\.\\\\s*'`. Fixed with `sed` commands.

2. **Regex literal vs string escaping**: In test assertions, `/\\.\\s*$/` (regex literal) should NOT have double backslashes, but `'{{tarqim}}\\s*'` (string) SHOULD have double backslashes.

3. **Pattern examples**:
   - âœ… Correct string: `breakpoints: ['{{tarqim}}\\s*', '']`
   - âœ… Correct regex literal: `expect(result[0].content).toMatch(/\.\s*$/)`
   - âŒ Wrong: `breakpoints: ['{{tarqim}}\s*', '']` (not escaped)
   - âŒ Wrong: `/\\.\\s*$/` (double-escaped in regex literal)

### 5. Removed Legacy Code

- **Removed**: `maxSpan` property from `SplitRule` type
- **Removed**: `fallback` property from `SplitRule` type  
- **Removed**: `groupBySpanAndFilter` utility function and import
- **Removed**: All maxSpan/fallback related logic from `segmentPages`
- **Removed**: ~400 lines of legacy maxSpan/fallback tests from `segmenter.test.ts`

### 6. Added New Tests

**File**: `src/segmentation/segmenter.test.ts`

Added 13 comprehensive breakpoints tests covering:
- Basic behavior (should apply breakpoints to oversized segments)
- `prefer: 'longer'` and `prefer: 'shorter'` options
- Fallback patterns (period â†’ newline â†’ page boundary)
- Structural markers taking precedence
- Respecting structural boundaries
- Original problem fix (NOT creating tiny segments from punctuation in titles)
- Only breaking oversized segments, not within-limit ones
- OCR content without punctuation (falling back to line breaks)
- Content with no separators at all
- Token expansion in breakpoint patterns (`{{tarqim}}`)
- Error handling for invalid regex patterns

**All 13 breakpoints tests pass.**

---

## Current State / What Remains

### Immediate Issue: Integration Tests Failing

**Problem**: The two integration tests in `src/index.test.ts` (for books 2576 and 2588) are failing after the migration.

**Root Cause Identified**: The inline test data still had the old `tarqim` rule in the rules array. I migrated them to use the new breakpoints approach, but the test expectations don't match the new behavior.

**Specific Issue**: Page 1 of book 2588 contains `(Ù¥Ù¤Ù¡ - Ù¦Ù¢Ù  Ù‡Ù€)` which has `)` - a tarqim punctuation mark. With `maxPages: 1`, breakpoints finds this parenthesis and splits mid-page, causing the test expectation (`endsWith: 'Ø§Ù„Ø±ÙŠØ§Ø¶'`) to fail.

**Migration Done**:
1. âœ… Updated `data` type declaration to include `breakpoints`, `maxPages`, `prefer` (line 36-42)
2. âœ… Removed tarqim rule from inline rules arrays (both 2576 and 2588)
3. âœ… Added `breakpoints: ['{{tarqim}}\\s*', '']`, `maxPages: 1`, `prefer: 'longer' as const` to inline data
4. âœ… Updated `segmentPages` calls to pass all options

**What Still Needs To Be Done**:
- Either increase `maxPages: 2` so title pages stay together
- OR update test expectations to match new breakpoints behavior
- OR adjust tarqim pattern to exclude parentheses

### Lint Warnings (Deprioritized)

Two "excessive complexity" warnings remain in `segmenter.ts`:
- `applyBreakpoints` function (complexity: 73, max: 15)
- `segmentPages` function (complexity: 35, max: 15)

These are acceptable for now due to inherent complexity of segmentation logic.

---

## File Locations

| File | Purpose |
|------|---------|
| `src/segmentation/segmenter.ts` | Main segmentation logic including `applyBreakpoints()` |
| `src/segmentation/types.ts` | Type definitions for `SplitRule`, `SegmentationOptions`, etc. |
| `src/segmentation/segmenter.test.ts` | Unit tests including 13 new breakpoints tests |
| `src/segmentation/tokens.ts` | Token patterns like `{{tarqim}}`, `{{basmalah}}` |
| `src/index.test.ts` | Integration tests for books 2576 and 2588 (FAILING) |
| `test/2576.json` | Test data for book 2576 (NOT used - tests use inline data) |
| `test/2588.json` | Test data for book 2588 (NOT used - tests use inline data) |

---

## Key Design Decisions

### 1. Post-Processing Approach
Breakpoints run AFTER structural rules, only on segments that exceed `maxPages`. This ensures structural integrity is preserved.

### 2. Window Approximation
Since we don't have exact pageâ†’character mapping, we estimate using average characters per page with 50% padding to ensure the window is large enough.

### 3. Pattern Order Matters
Breakpoints are tried in order. Typical usage: `['{{tarqim}}\\s*', '\\n', '']` tries punctuation first, then newlines, then page boundaries.

### 4. Prefer Option
- `'longer'`: Finds the LAST match in the window (greedy - makes segments as large as possible)
- `'shorter'`: Finds the FIRST match (conservative - breaks at first opportunity)

### 5. Recursive Processing
If a split still produces an oversized segment, `applyBreakpoints` recursively processes it.

---

## Test Commands

```bash
# Run all tests
bun test

# Run only breakpoints tests
bun test src/segmentation/segmenter.test.ts --test-name-pattern "breakpoints"

# Run only integration tests
bun test src/index.test.ts
```

---

## Important Code Snippets

### How breakpoints is called (in segmentPages):
```typescript
// At the end of segmentPages, after structural rules have run:
if (maxPages && breakpoints) {
    segments = applyBreakpoints(segments, pages, breakpoints, maxPages, prefer || 'longer');
}
```

### Inline test data structure (how to configure):
```typescript
data = {
    pages: [...],
    rules: [
        { lineStartsWith: ['{{basmalah}}'], split: 'at' },
        // ... structural rules only
    ],
    breakpoints: ['{{tarqim}}\\s*', ''],  // Try punctuation, then page boundary
    maxPages: 1,
    prefer: 'longer' as const,
};
```

### Running segmentPages with breakpoints:
```typescript
const segments = segmentPages(data.pages, {
    rules: data.rules,
    breakpoints: data.breakpoints,
    maxPages: data.maxPages,
    prefer: data.prefer,
});
```

---

## Token Reference

| Token | Meaning |
|-------|---------|
| `{{tarqim}}` | Arabic punctuation marks (period, comma, semicolon, question mark, exclamation, parentheses) |
| `{{basmalah}}` | "Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù" patterns |
| `{{bab}}` | "Ø¨Ø§Ø¨" (chapter) patterns |
| `{{fasl}}` | "ÙØµÙ„" (section) patterns |
| `{{kitab}}` | "ÙƒØªØ§Ø¨" (book) patterns |
| `{{raqms:num}}` | Arabic-Indic numerals with named capture group |
| `{{dash}}` | Various dash characters |

---

## Debugging Tips

### To see what segments are produced:
```typescript
const segments = segmentPages(pages, options);
segments.forEach((s, i) => {
    console.log(i, ': from', s.from, 'to', s.to, '- content:', s.content.substring(0, 50));
});
```

### Common issues:
1. **Wrong escaping**: In TypeScript strings, use `'\\.'` for regex `.`, and in test assertions use `/\./`
2. **Token expansion not working**: Ensure tokens are correctly escaped in string (`'{{tarqim}}\\s*'` not `'{{tarqim}}\s*'`)
3. **maxPages too small**: Title pages without natural breakpoints may split incorrectly

---

## Summary of Test Status

| Test Suite | Status |
|------------|--------|
| `segmenter.test.ts` - breakpoints (13 tests) | âœ… PASSING |
| `segmenter.test.ts` - other tests | âœ… PASSING |
| `index.test.ts` - 2576 | âŒ FAILING |
| `index.test.ts` - 2588 | âŒ FAILING |
| All other test files | âœ… PASSING |

**Total**: 163 pass, 2 fail

---

## Next Steps for Incoming Agent

1. **Fix integration tests** - Decide on approach:
   - Option A: Increase `maxPages` to 2 for tests
   - Option B: Update test expectations to match new behavior
   - Option C: Adjust `{{tarqim}}` pattern to exclude parentheses

2. **Verify all 165 tests pass**

3. **(Optional) Update documentation** - Reflect new segmentation configuration in `AGENTS.md` and `README.md`

4. **(Optional) Reduce complexity** - Refactor `applyBreakpoints` and `segmentPages` to address lint warnings

---

## Questions the User Was Asked (Unanswered)

The last question posed to the user was about how to handle the failing integration tests:
- Should `maxPages` be increased to 2?
- Should test expectations be updated?
- Should the tarqim pattern exclude parentheses?

The user did not answer - instead requested this handoff document.

---

## Where To Look: Feature & Bug Reference

This section maps common questions to the relevant files and code locations.

### If Asked About Breakpoints Feature
| Topic | Where to Look |
|-------|---------------|
| Core implementation | `src/segmentation/segmenter.ts` â†’ `applyBreakpoints()` function (lines ~432-576) |
| API types/options | `src/segmentation/types.ts` â†’ `SegmentationOptions` interface |
| Unit tests | `src/segmentation/segmenter.test.ts` â†’ search for `describe('breakpoints'` |
| Integration with segmentPages | `src/segmentation/segmenter.ts` â†’ end of `segmentPages()` function |

### If Asked About Segmentation Rules
| Topic | Where to Look |
|-------|---------------|
| Rule processing logic | `src/segmentation/segmenter.ts` â†’ `segmentPages()` function |
| Rule type definitions | `src/segmentation/types.ts` â†’ `SplitRule` interface |
| lineStartsWith/lineStartsAfter | `src/segmentation/segmenter.ts` â†’ search for these property names |
| Template matching | `src/segmentation/segmenter.ts` â†’ search for `template` |
| fuzzy matching | `src/segmentation/fuzzy.ts` |

### If Asked About Tokens ({{tarqim}}, {{basmalah}}, etc.)
| Topic | Where to Look |
|-------|---------------|
| Token definitions | `src/segmentation/tokens.ts` â†’ `TOKEN_PATTERNS` object |
| Token expansion | `src/segmentation/tokens.ts` â†’ `expandTokens()` function |
| Token tests | `src/segmentation/tokens.test.ts` |
| Adding new tokens | Add to `TOKEN_PATTERNS` in `tokens.ts` |

### If Asked About Test Failures
| Topic | Where to Look |
|-------|---------------|
| Integration test data | `src/index.test.ts` â†’ inline `data = { pages, rules, ... }` objects |
| Integration test JSON (unused) | `test/2576.json`, `test/2588.json` - **NOTE: tests use inline data, not these files** |
| Breakpoints unit tests | `src/segmentation/segmenter.test.ts` â†’ `describe('breakpoints'` block |
| Other segmenter tests | `src/segmentation/segmenter.test.ts` |

### If Asked About the "Premature Split" Bug (Original Problem)
| Topic | Where to Look |
|-------|---------------|
| Problem description | This document â†’ "Historical Context: The Old maxSpan System" section |
| Solution | `applyBreakpoints()` post-processing approach |
| Test proving fix | `segmenter.test.ts` â†’ `'should NOT create tiny segments from punctuation within chapter titles'` |

### If Asked About Page/Content Mapping
| Topic | Where to Look |
|-------|---------------|
| Page type definition | `src/segmentation/types.ts` â†’ `Page` interface |
| Segment type definition | `src/segmentation/types.ts` â†’ `Segment` interface |
| Content window calculation | `src/segmentation/segmenter.ts` â†’ `applyBreakpoints()` â†’ look for `approxWindowEnd` |

### If Asked About Arabic Text Processing
| Topic | Where to Look |
|-------|---------------|
| HTML to markdown conversion | `src/index.test.ts` â†’ `htmlToMarkdown()` helper function |
| Fuzzy Arabic matching | `src/segmentation/fuzzy.ts` |
| Arabic punctuation patterns | `src/segmentation/tokens.ts` â†’ `tarqim` token |
| Arabic numeral patterns | `src/segmentation/tokens.ts` â†’ `raqm`, `raqms` tokens |

### If Asked About Complexity Lint Warnings
| Topic | Where to Look |
|-------|---------------|
| applyBreakpoints complexity | `src/segmentation/segmenter.ts` line ~432 (complexity: 73) |
| segmentPages complexity | `src/segmentation/segmenter.ts` line ~631 (complexity: 35) |
| Resolution approach | Consider extracting helper functions, but be careful not to break functionality |

### If Asked About Extending the Library
| Topic | Where to Look |
|-------|---------------|
| Adding new structural rules | `src/segmentation/types.ts` â†’ `SplitRule` for type, `segmenter.ts` for implementation |
| Adding new tokens | `src/segmentation/tokens.ts` â†’ add to `TOKEN_PATTERNS` |
| Adding new segment types | `src/segmentation/types.ts` â†’ modify `Segment`, `SegmentMeta` interfaces |
| Export configuration | `src/index.ts` |

---

## Conversation History Reference

During this session, the user asked about:

1. **Fixing breakpoints integration tests** - The main objective was ensuring all segmentation tests pass after removing `maxSpan` and implementing `breakpoints`

2. **Regex escaping issues** - Multiple fixes were needed for backslash escaping in test strings vs regex literals

3. **Window calculation padding** - Increased from 20% to 50% to fix `prefer: 'longer'` scenarios

4. **Test data location confusion** - User clarified that tests use inline data, not the JSON files in `test/` directory

5. **Migration approach** - User wanted tarqim rule moved from `rules` array to `breakpoints` option

